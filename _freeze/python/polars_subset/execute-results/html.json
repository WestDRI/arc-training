{
  "hash": "04ceae0c163d4298e343c5339dfa44e9",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: Subsetting data\nauthor: Marie-Hélène Burle\n---\n\n:::{.def}\n\nThe syntax to subset data is very different in Polars compared to the indexing of pandas and other languages. Action verbs are used in a style very similar to that of [R's dplyr](https://cran.r-project.org/web/packages/dplyr/index.html) from [the tidyverse](https://www.tidyverse.org/).\n\n:::\n\nLet's read in [another online dataset from Vega-Altair](https://github.com/vega/vega-datasets/blob/main/datapackage.md#disasters) into a DataFrame:\n\n::: {#0135e84a .cell execution_count=2}\n``` {.python .cell-code}\nimport polars as pl\n\ndf = pl.read_csv(\"https://cdn.jsdelivr.net/npm/vega-datasets/data/disasters.csv\")\n\nprint(df)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nshape: (803, 3)\n┌───────────────────────┬──────┬─────────┐\n│ Entity                ┆ Year ┆ Deaths  │\n│ ---                   ┆ ---  ┆ ---     │\n│ str                   ┆ i64  ┆ i64     │\n╞═══════════════════════╪══════╪═════════╡\n│ All natural disasters ┆ 1900 ┆ 1267360 │\n│ All natural disasters ┆ 1901 ┆ 200018  │\n│ All natural disasters ┆ 1902 ┆ 46037   │\n│ All natural disasters ┆ 1903 ┆ 6506    │\n│ All natural disasters ┆ 1905 ┆ 22758   │\n│ …                     ┆ …    ┆ …       │\n│ Wildfire              ┆ 2013 ┆ 35      │\n│ Wildfire              ┆ 2014 ┆ 16      │\n│ Wildfire              ┆ 2015 ┆ 67      │\n│ Wildfire              ┆ 2016 ┆ 39      │\n│ Wildfire              ┆ 2017 ┆ 75      │\n└───────────────────────┴──────┴─────────┘\n```\n:::\n:::\n\n\n## Selecting rows\n\nYou can create a new DataFrame with a subset of rows matching some condition with [`polars.DataFrame.filter`](https://docs.pola.rs/api/python/stable/reference/dataframe/api/polars.DataFrame.filter.html).\n\nLet's select rows for the year `2001`. For this, we select the column `Year` by its name with [`polars.col`](https://docs.pola.rs/api/python/stable/reference/expressions/col.html) and return the rows when the values for that column equal `2001`:\n\n::: {#9bc8a5b9 .cell execution_count=3}\n``` {.python .cell-code}\ndf_sub_row = df.filter(pl.col(\"Year\") == 2001)\n\nprint(df_sub_row)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nshape: (9, 3)\n┌───────────────────────┬──────┬────────┐\n│ Entity                ┆ Year ┆ Deaths │\n│ ---                   ┆ ---  ┆ ---    │\n│ str                   ┆ i64  ┆ i64    │\n╞═══════════════════════╪══════╪════════╡\n│ All natural disasters ┆ 2001 ┆ 39493  │\n│ Drought               ┆ 2001 ┆ 99     │\n│ Earthquake            ┆ 2001 ┆ 21348  │\n│ Epidemic              ┆ 2001 ┆ 8515   │\n│ Extreme temperature   ┆ 2001 ┆ 1787   │\n│ Extreme weather       ┆ 2001 ┆ 1911   │\n│ Flood                 ┆ 2001 ┆ 5014   │\n│ Landslide             ┆ 2001 ┆ 786    │\n│ Wildfire              ┆ 2001 ┆ 33     │\n└───────────────────────┴──────┴────────┘\n```\n:::\n:::\n\n\nYou can combine multiple conditions:\n\n::: {#0110d8f6 .cell execution_count=4}\n``` {.python .cell-code}\ndf_sub_row = df.filter(\n    pl.col(\"Year\") == 2001,\n    pl.col(\"Entity\") == \"Flood\"\n    )\n\nprint(df_sub_row)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nshape: (1, 3)\n┌────────┬──────┬────────┐\n│ Entity ┆ Year ┆ Deaths │\n│ ---    ┆ ---  ┆ ---    │\n│ str    ┆ i64  ┆ i64    │\n╞════════╪══════╪════════╡\n│ Flood  ┆ 2001 ┆ 5014   │\n└────────┴──────┴────────┘\n```\n:::\n:::\n\n\n## Selecting columns\n\nTo select columns (variables), you use [`polars.DataFrame.select`](https://docs.pola.rs/api/python/stable/reference/dataframe/api/polars.DataFrame.select.html):\n\n::: {#e9d1dee6 .cell execution_count=5}\n``` {.python .cell-code}\ndf_sub_col = df.select(\n    pl.col(\"Entity\"),\n    pl.col(\"Year\")\n    )\n\nprint(df_sub_col)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nshape: (803, 2)\n┌───────────────────────┬──────┐\n│ Entity                ┆ Year │\n│ ---                   ┆ ---  │\n│ str                   ┆ i64  │\n╞═══════════════════════╪══════╡\n│ All natural disasters ┆ 1900 │\n│ All natural disasters ┆ 1901 │\n│ All natural disasters ┆ 1902 │\n│ All natural disasters ┆ 1903 │\n│ All natural disasters ┆ 1905 │\n│ …                     ┆ …    │\n│ Wildfire              ┆ 2013 │\n│ Wildfire              ┆ 2014 │\n│ Wildfire              ┆ 2015 │\n│ Wildfire              ┆ 2016 │\n│ Wildfire              ┆ 2017 │\n└───────────────────────┴──────┘\n```\n:::\n:::\n\n\nNote that if you select a single column, you still have a DataFrame:\n\n::: {#fee4b19a .cell execution_count=6}\n``` {.python .cell-code}\ndf_onecol = df.select(pl.col(\"Entity\"))\n\nprint(df_onecol)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nshape: (803, 1)\n┌───────────────────────┐\n│ Entity                │\n│ ---                   │\n│ str                   │\n╞═══════════════════════╡\n│ All natural disasters │\n│ All natural disasters │\n│ All natural disasters │\n│ All natural disasters │\n│ All natural disasters │\n│ …                     │\n│ Wildfire              │\n│ Wildfire              │\n│ Wildfire              │\n│ Wildfire              │\n│ Wildfire              │\n└───────────────────────┘\n```\n:::\n:::\n\n\n::: {#62dd60d5 .cell execution_count=7}\n``` {.python .cell-code}\ntype(df_onecol)\n```\n\n::: {.cell-output .cell-output-display execution_count=6}\n```\npolars.dataframe.frame.DataFrame\n```\n:::\n:::\n\n\n## Extracting Series\n\n[As we saw earlier](polars_structures.qmd), Polars DataFrames are made of [`Series`](https://docs.pola.rs/api/python/stable/reference/series/index.html): one-dimensional homogeneous data structures representing the columns of the DataFrames.\n\nTo extract a Series out of a DataFrames, you can use [`polars.DataFrame.get_column`](https://docs.pola.rs/api/python/stable/reference/dataframe/api/polars.DataFrame.get_column.html#polars.DataFrame.get_column) if you want to use the column name:\n\n::: {#33641beb .cell execution_count=8}\n``` {.python .cell-code}\ns_entity = df.get_column(\"Entity\")\n\nprint(s_entity)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nshape: (803,)\nSeries: 'Entity' [str]\n[\n\t\"All natural disasters\"\n\t\"All natural disasters\"\n\t\"All natural disasters\"\n\t\"All natural disasters\"\n\t\"All natural disasters\"\n\t…\n\t\"Wildfire\"\n\t\"Wildfire\"\n\t\"Wildfire\"\n\t\"Wildfire\"\n\t\"Wildfire\"\n]\n```\n:::\n:::\n\n\nOr you can use [`polars.DataFrame.to_series`](https://docs.pola.rs/api/python/stable/reference/dataframe/api/polars.DataFrame.to_series.html#polars.DataFrame.to_series) if you want to extract the column by its index:\n\n::: {#7c329171 .cell execution_count=9}\n``` {.python .cell-code}\ns_entity = df.to_series(0)\n\nprint(s_entity)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nshape: (803,)\nSeries: 'Entity' [str]\n[\n\t\"All natural disasters\"\n\t\"All natural disasters\"\n\t\"All natural disasters\"\n\t\"All natural disasters\"\n\t\"All natural disasters\"\n\t…\n\t\"Wildfire\"\n\t\"Wildfire\"\n\t\"Wildfire\"\n\t\"Wildfire\"\n\t\"Wildfire\"\n]\n```\n:::\n:::\n\n\n::: {#929c3d93 .cell execution_count=10}\n``` {.python .cell-code}\ntype(s_entity)\n```\n\n::: {.cell-output .cell-output-display execution_count=9}\n```\npolars.series.series.Series\n```\n:::\n:::\n\n\nUsing [`polars.DataFrame.unique`](https://docs.pola.rs/api/python/stable/reference/dataframe/api/polars.DataFrame.unique.html) and [`polars.Series.to_list`](https://docs.pola.rs/api/python/stable/reference/series/api/polars.Series.to_list.html#polars.Series.to_list), you can get a list of all the types of natural disasters in this dataset (we can then sort the list with the standard `list.sort` method):\n\n::: {#61552050 .cell execution_count=11}\n``` {.python .cell-code}\ndisasters = s_entity.unique().to_list()\ndisasters.sort()\n\ndisasters\n```\n\n::: {.cell-output .cell-output-display execution_count=10}\n```\n['All natural disasters',\n 'Drought',\n 'Earthquake',\n 'Epidemic',\n 'Extreme temperature',\n 'Extreme weather',\n 'Flood',\n 'Landslide',\n 'Mass movement (dry)',\n 'Volcanic activity',\n 'Wildfire']\n```\n:::\n:::\n\n\n::: {#77760b7d .cell execution_count=12}\n``` {.python .cell-code}\ntype(disasters)\n```\n\n::: {.cell-output .cell-output-display execution_count=11}\n```\nlist\n```\n:::\n:::\n\n\n## Modifying selected columns\n\nYou can modify selected columns to create new columns. The new columns can be named with [`polars.Expr.alias`](https://docs.pola.rs/api/python/stable/reference/expressions/api/polars.Expr.alias.html#polars.Expr.alias):\n\n::: {#c6e0de9e .cell execution_count=13}\n``` {.python .cell-code}\ndf_col_mod = df.select(\n    pl.col(\"Entity\"),\n    pl.col(\"Year\"),\n    (pl.col(\"Deaths\") / 1000).alias(\"Kilodeaths\")\n)\n\nprint(df_col_mod)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nshape: (803, 3)\n┌───────────────────────┬──────┬────────────┐\n│ Entity                ┆ Year ┆ Kilodeaths │\n│ ---                   ┆ ---  ┆ ---        │\n│ str                   ┆ i64  ┆ f64        │\n╞═══════════════════════╪══════╪════════════╡\n│ All natural disasters ┆ 1900 ┆ 1267.36    │\n│ All natural disasters ┆ 1901 ┆ 200.018    │\n│ All natural disasters ┆ 1902 ┆ 46.037     │\n│ All natural disasters ┆ 1903 ┆ 6.506      │\n│ All natural disasters ┆ 1905 ┆ 22.758     │\n│ …                     ┆ …    ┆ …          │\n│ Wildfire              ┆ 2013 ┆ 0.035      │\n│ Wildfire              ┆ 2014 ┆ 0.016      │\n│ Wildfire              ┆ 2015 ┆ 0.067      │\n│ Wildfire              ┆ 2016 ┆ 0.039      │\n│ Wildfire              ┆ 2017 ┆ 0.075      │\n└───────────────────────┴──────┴────────────┘\n```\n:::\n:::\n\n\nOr you can name the new columns by assigning their values to the new names:\n\n::: {#e4047df9 .cell execution_count=14}\n``` {.python .cell-code}\ndf_col_mod = df.select(\n    pl.col(\"Entity\"),\n    pl.col(\"Year\"),\n    Kilodeaths=pl.col(\"Deaths\") / 1000\n)\n\nprint(df_col_mod)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nshape: (803, 3)\n┌───────────────────────┬──────┬────────────┐\n│ Entity                ┆ Year ┆ Kilodeaths │\n│ ---                   ┆ ---  ┆ ---        │\n│ str                   ┆ i64  ┆ f64        │\n╞═══════════════════════╪══════╪════════════╡\n│ All natural disasters ┆ 1900 ┆ 1267.36    │\n│ All natural disasters ┆ 1901 ┆ 200.018    │\n│ All natural disasters ┆ 1902 ┆ 46.037     │\n│ All natural disasters ┆ 1903 ┆ 6.506      │\n│ All natural disasters ┆ 1905 ┆ 22.758     │\n│ …                     ┆ …    ┆ …          │\n│ Wildfire              ┆ 2013 ┆ 0.035      │\n│ Wildfire              ┆ 2014 ┆ 0.016      │\n│ Wildfire              ┆ 2015 ┆ 0.067      │\n│ Wildfire              ┆ 2016 ┆ 0.039      │\n│ Wildfire              ┆ 2017 ┆ 0.075      │\n└───────────────────────┴──────┴────────────┘\n```\n:::\n:::\n\n\n## Adding modified columns\n\nIf you want to add the modified columns to the initial DataFrame (instead of selecting them), you use [`polars.DataFrame.with_columns`](https://docs.pola.rs/api/python/stable/reference/dataframe/api/polars.DataFrame.with_columns.html). The naming works in the same way:\n\n::: {#51e5efed .cell execution_count=15}\n``` {.python .cell-code}\ndf_mod = df.with_columns((pl.col(\"Deaths\") / 1000).alias(\"Kilodeaths\"))\n\nprint(df_mod)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nshape: (803, 4)\n┌───────────────────────┬──────┬─────────┬────────────┐\n│ Entity                ┆ Year ┆ Deaths  ┆ Kilodeaths │\n│ ---                   ┆ ---  ┆ ---     ┆ ---        │\n│ str                   ┆ i64  ┆ i64     ┆ f64        │\n╞═══════════════════════╪══════╪═════════╪════════════╡\n│ All natural disasters ┆ 1900 ┆ 1267360 ┆ 1267.36    │\n│ All natural disasters ┆ 1901 ┆ 200018  ┆ 200.018    │\n│ All natural disasters ┆ 1902 ┆ 46037   ┆ 46.037     │\n│ All natural disasters ┆ 1903 ┆ 6506    ┆ 6.506      │\n│ All natural disasters ┆ 1905 ┆ 22758   ┆ 22.758     │\n│ …                     ┆ …    ┆ …       ┆ …          │\n│ Wildfire              ┆ 2013 ┆ 35      ┆ 0.035      │\n│ Wildfire              ┆ 2014 ┆ 16      ┆ 0.016      │\n│ Wildfire              ┆ 2015 ┆ 67      ┆ 0.067      │\n│ Wildfire              ┆ 2016 ┆ 39      ┆ 0.039      │\n│ Wildfire              ┆ 2017 ┆ 75      ┆ 0.075      │\n└───────────────────────┴──────┴─────────┴────────────┘\n```\n:::\n:::\n\n\nOr, with the alternative column naming:\n\n::: {#1e8a20e6 .cell execution_count=16}\n``` {.python .cell-code}\ndf_mod = df.with_columns(Kilodeaths=pl.col(\"Deaths\") / 1000)\n\nprint(df_mod)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nshape: (803, 4)\n┌───────────────────────┬──────┬─────────┬────────────┐\n│ Entity                ┆ Year ┆ Deaths  ┆ Kilodeaths │\n│ ---                   ┆ ---  ┆ ---     ┆ ---        │\n│ str                   ┆ i64  ┆ i64     ┆ f64        │\n╞═══════════════════════╪══════╪═════════╪════════════╡\n│ All natural disasters ┆ 1900 ┆ 1267360 ┆ 1267.36    │\n│ All natural disasters ┆ 1901 ┆ 200018  ┆ 200.018    │\n│ All natural disasters ┆ 1902 ┆ 46037   ┆ 46.037     │\n│ All natural disasters ┆ 1903 ┆ 6506    ┆ 6.506      │\n│ All natural disasters ┆ 1905 ┆ 22758   ┆ 22.758     │\n│ …                     ┆ …    ┆ …       ┆ …          │\n│ Wildfire              ┆ 2013 ┆ 35      ┆ 0.035      │\n│ Wildfire              ┆ 2014 ┆ 16      ┆ 0.016      │\n│ Wildfire              ┆ 2015 ┆ 67      ┆ 0.067      │\n│ Wildfire              ┆ 2016 ┆ 39      ┆ 0.039      │\n│ Wildfire              ┆ 2017 ┆ 75      ┆ 0.075      │\n└───────────────────────┴──────┴─────────┴────────────┘\n```\n:::\n:::\n\n\n:::{.note}\n\nNotice that our new variable got added as the last column of the DataFrame.\n\n:::\n\n## Group by operations\n\nIf you want to perform operations on rows sharing the same value for some variable, you group those rows with [`polars.DataFrame.group_by`](https://docs.pola.rs/api/python/stable/reference/dataframe/api/polars.DataFrame.group_by.html#polars.DataFrame.group_by).\n\nFor instance, if we want to get the total number of deaths for each category of disaster, we can do:\n\n::: {#18bd75c8 .cell execution_count=17}\n``` {.python .cell-code}\ntotals = df.group_by(\n    pl.col(\"Entity\")\n).agg(\n    pl.col(\"Deaths\").sum()\n)\n\nprint(totals)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nshape: (11, 2)\n┌───────────────────────┬──────────┐\n│ Entity                ┆ Deaths   │\n│ ---                   ┆ ---      │\n│ str                   ┆ i64      │\n╞═══════════════════════╪══════════╡\n│ Extreme weather       ┆ 1396601  │\n│ Landslide             ┆ 63068    │\n│ Earthquake            ┆ 2576801  │\n│ Flood                 ┆ 6954992  │\n│ Epidemic              ┆ 9596463  │\n│ …                     ┆ …        │\n│ Volcanic activity     ┆ 96366    │\n│ All natural disasters ┆ 32607156 │\n│ Extreme temperature   ┆ 182604   │\n│ Drought               ┆ 11731294 │\n│ Wildfire              ┆ 3925     │\n└───────────────────────┴──────────┘\n```\n:::\n:::\n\n\nNotice that the rows became out of order. Not to worry about order makes the code more efficient and does not affect future subsetting of our DataFrame. If you want to maintain the order however, you can use the `maintain_order` parameter (but this slows down the operation):\n\n::: {#dfd77b58 .cell execution_count=18}\n``` {.python .cell-code}\ntotals = df.group_by(\n    pl.col(\"Entity\"),\n    maintain_order=True\n).agg(\n    pl.col(\"Deaths\").sum()\n)\n\nprint(totals)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nshape: (11, 2)\n┌───────────────────────┬──────────┐\n│ Entity                ┆ Deaths   │\n│ ---                   ┆ ---      │\n│ str                   ┆ i64      │\n╞═══════════════════════╪══════════╡\n│ All natural disasters ┆ 32607156 │\n│ Drought               ┆ 11731294 │\n│ Earthquake            ┆ 2576801  │\n│ Epidemic              ┆ 9596463  │\n│ Extreme temperature   ┆ 182604   │\n│ …                     ┆ …        │\n│ Flood                 ┆ 6954992  │\n│ Landslide             ┆ 63068    │\n│ Mass movement (dry)   ┆ 5030     │\n│ Volcanic activity     ┆ 96366    │\n│ Wildfire              ┆ 3925     │\n└───────────────────────┴──────────┘\n```\n:::\n:::\n\n\n:::{.exo}\n\n:::{.yourturn}\n\nYour turn:\n\n:::\n\nCreate a new DataFrame, ordered by year, that shows the total number of deaths for each year:\n\n::: {#2caf0c2f .cell execution_count=19}\n\n::: {.cell-output .cell-output-stdout}\n```\nshape: (117, 2)\n┌──────┬─────────┐\n│ Year ┆ Deaths  │\n│ ---  ┆ ---     │\n│ i64  ┆ i64     │\n╞══════╪═════════╡\n│ 1900 ┆ 1267360 │\n│ 1901 ┆ 200018  │\n│ 1902 ┆ 46037   │\n│ 1903 ┆ 6506    │\n│ 1905 ┆ 22758   │\n│ …    ┆ …       │\n│ 2013 ┆ 22225   │\n│ 2014 ┆ 20882   │\n│ 2015 ┆ 23893   │\n│ 2016 ┆ 10201   │\n│ 2017 ┆ 2087    │\n└──────┴─────────┘\n```\n:::\n:::\n\n\n:::\n\n## Combining contexts\n\n`select`, `with_columns`, `filter`, and `group_by` are called [contexts]{.emph} in the Polars terminology (the data transformations performed in these contexts are called [expressions]{.emph}).\n\nContexts can be combined. For instance, we can create a new DataFrame with the number of deaths for each decade:\n\n::: {#4b1be345 .cell execution_count=20}\n``` {.python .cell-code}\ndecade_totals = df.filter(\n    pl.col(\"Entity\") == \"All natural disasters\"\n).with_columns(\n    (pl.col(\"Year\") // 10 * 10).alias(\"Decade\")\n).group_by(\n    pl.col(\"Decade\"),\n    maintain_order=True\n).agg(\n    pl.col(\"Deaths\").sum()\n)\n\nprint(decade_totals)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nshape: (12, 2)\n┌────────┬─────────┐\n│ Decade ┆ Deaths  │\n│ ---    ┆ ---     │\n│ i64    ┆ i64     │\n╞════════╪═════════╡\n│ 1900   ┆ 4497847 │\n│ 1910   ┆ 3326492 │\n│ 1920   ┆ 8726293 │\n│ 1930   ┆ 4701024 │\n│ 1940   ┆ 3871695 │\n│ …      ┆ …       │\n│ 1970   ┆ 986867  │\n│ 1980   ┆ 796782  │\n│ 1990   ┆ 527613  │\n│ 2000   ┆ 839986  │\n│ 2010   ┆ 454950  │\n└────────┴─────────┘\n```\n:::\n:::\n\n\nOr one with the number of deaths for that decade for each type of disaster:\n\n::: {#154a9e23 .cell execution_count=21}\n``` {.python .cell-code}\ndecade_totals_by_type = df.with_columns(\n    (pl.col(\"Year\") // 10 * 10).alias(\"Decade\"),\n).group_by([pl.col(\"Decade\"), pl.col(\"Entity\")],\n    maintain_order=True\n).agg(\n    pl.col(\"Deaths\").sum()\n)\n\nprint(decade_totals_by_type)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nshape: (122, 3)\n┌────────┬───────────────────────┬─────────┐\n│ Decade ┆ Entity                ┆ Deaths  │\n│ ---    ┆ ---                   ┆ ---     │\n│ i64    ┆ str                   ┆ i64     │\n╞════════╪═══════════════════════╪═════════╡\n│ 1900   ┆ All natural disasters ┆ 4497847 │\n│ 1910   ┆ All natural disasters ┆ 3326492 │\n│ 1920   ┆ All natural disasters ┆ 8726293 │\n│ 1930   ┆ All natural disasters ┆ 4701024 │\n│ 1940   ┆ All natural disasters ┆ 3871695 │\n│ …      ┆ …                     ┆ …       │\n│ 1970   ┆ Wildfire              ┆ 5       │\n│ 1980   ┆ Wildfire              ┆ 396     │\n│ 1990   ┆ Wildfire              ┆ 859     │\n│ 2000   ┆ Wildfire              ┆ 629     │\n│ 2010   ┆ Wildfire              ┆ 429     │\n└────────┴───────────────────────┴─────────┘\n```\n:::\n:::\n\n\n",
    "supporting": [
      "polars_subset_files"
    ],
    "filters": [],
    "includes": {}
  }
}
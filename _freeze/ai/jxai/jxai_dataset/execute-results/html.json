{
  "hash": "92b4abc00eb319bb74024284942b1f86",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: The Dataset class\nauthor: Marie-Hélène Burle\n---\n\n:::{.def}\n\n\n\n:::\n\n:::{.callout-note collapse=\"true\"}\n\n## Minimal necessary code from previous sections\n\n```{.python}\nbase_dir = \"<path-of-the-nabirds-dir>\"\n```\n\n:::{.note}\n\nTo be replaced by actual path.\n\n:::\n\n```{.python}\n#| echo: false\n\nbase_dir = \"nabirds\"\n```\n\n::: {#6b15c8ac .cell execution_count=1}\n``` {.python .cell-code}\nimport os\nimport polars as pl\n\nimg_dir = os.path.join(base_dir, \"images\")\n\nbb_file = os.path.join(base_dir, \"bounding_boxes.txt\")\nclasses_translation_file = os.path.join(base_dir, \"classes_fixed.txt\")\nclass_labels_file = os.path.join(base_dir, \"image_class_labels.txt\")\nimg_file = os.path.join(base_dir, \"images.txt\")\nphotographers_file = os.path.join(base_dir, \"photographers_fixed.txt\")\nsizes_file = os.path.join(base_dir, \"sizes.txt\")\ntrain_test_split_file = os.path.join(base_dir, \"train_test_split.txt\")\n\nbb = pl.read_csv(\n    bb_file,\n    separator=\" \",\n    has_header=False,\n    new_columns=[\"UUID\", \"bb_x\", \"bb_y\", \"bb_width\", \"bb_height\"]\n)\n\nclasses = pl.read_csv(\n    class_labels_file,\n    separator=\" \",\n    has_header=False,\n    new_columns=[\"UUID\", \"class\"]\n)\n\nclasses_translation = pl.read_csv(\n    classes_translation_file,\n    separator=\" \",\n    has_header=False,\n    new_columns=[\"class\", \"id\"]\n)\n\nimg_paths = pl.read_csv(\n    img_file,\n    separator=\" \",\n    has_header=False,\n    new_columns=[\"UUID\", \"path\"]\n)\n\nphotographers = pl.read_csv(\n    photographers_file,\n    separator=\" \",\n    has_header=False,\n    new_columns=[\"UUID\", \"photographer\"]\n)\n\nsizes = pl.read_csv(\n    sizes_file,\n    separator=\" \",\n    has_header=False,\n    new_columns=[\"UUID\", \"img_width\", \"img_height\"]\n)\n\ntrain_test_split = pl.read_csv(\n    train_test_split_file,\n    separator=\" \",\n    has_header=False,\n    new_columns=[\"UUID\", \"is_training_img\"]\n)\n\nclasses_metadata = (\n    classes.join(classes_translation, on=\"class\")\n)\n\nmetadata = (\n    bb.join(classes_metadata, on=\"UUID\")\n    .join(img_paths, on=\"UUID\")\n    .join(photographers, on=\"UUID\")\n    .join(sizes, on=\"UUID\")\n    .join(train_test_split, on=\"UUID\")\n)\n\nmetadata_train = metadata.filter(pl.col(\"is_training_img\") == 1)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-bright-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-bright-red-fg\">NameError</span>                                 Traceback (most recent call last)\n<span class=\"ansi-bright-cyan-fg\">Cell</span><span class=\"ansi-bright-cyan-fg\"> </span><span class=\"ansi-green-fg\">In[1]</span><span class=\"ansi-green-fg\">, line 4</span>\n<span class=\"ansi-bright-green-fg\">      1</span> <span style=\"color:rgb(255,95,135)\">import</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">os</span>\n<span class=\"ansi-bright-green-fg\">      2</span> <span style=\"color:rgb(255,95,135)\">import</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">polars</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">as</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">pl</span>\n<span class=\"ansi-bright-green-fg\">----&gt; </span><span class=\"ansi-bright-green-fg\">4</span> <span class=\"ansi-bright-white-fg\">img_dir</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">os</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">path</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">join</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">base_dir</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(215,215,135)\">\"</span><span style=\"color:rgb(215,215,135)\">images</span><span style=\"color:rgb(215,215,135)\">\"</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">      6</span> <span class=\"ansi-bright-white-fg\">bb_file</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">os</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">path</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">join</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">base_dir</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(215,215,135)\">\"</span><span style=\"color:rgb(215,215,135)\">bounding_boxes.txt</span><span style=\"color:rgb(215,215,135)\">\"</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">      7</span> <span class=\"ansi-bright-white-fg\">classes_translation_file</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">os</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">path</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">join</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">base_dir</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(215,215,135)\">\"</span><span style=\"color:rgb(215,215,135)\">classes_fixed.txt</span><span style=\"color:rgb(215,215,135)\">\"</span><span class=\"ansi-bright-white-fg\">)</span>\n\n<span class=\"ansi-bright-red-fg\">NameError</span>: name 'base_dir' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n:::\n\n## Create class for our dataset\n\nTo read in the images, there are many options, including:\n\n- [PIL.Image.open](https://pillow.readthedocs.io/en/stable/reference/Image.html#PIL.Image.open) from [Pillow](https://github.com/python-pillow/Pillow),\n- `cv2.imread` from [OpenCV](https://github.com/opencv/opencv),\n- [skimage.io.imread](https://scikit-image.org/docs/stable/api/skimage.io.html#skimage.io.imread) from [scikit-image](https://github.com/scikit-image/scikit-image).\n\nHere, we are using `imageio.imread` from [imageio](https://github.com/imageio/imageio) which is an excellent option because it automatically creates a NumPy ndarrays, choosing a dtype based on the image, and it is faster than other options ([scikit-image](https://github.com/scikit-image/scikit-image) actually use it now instead of their own implementation).\n\n\n\n:::{.callout-note collapse=\"true\"}\n\n## Equivalent using PyTorch\n\nThe same thing can be achieved using [PyTorch](https://github.com/pytorch/pytorch), [TensorFlow Datasets](https://github.com/tensorflow/datasets), [Hugging Face Datasets](https://github.com/huggingface/datasets), or any method you are used to. Here, I am showing how this would be done with PyTorch.\n\nPyTorch provides [`torch.utils.data.Dataset`](https://docs.pytorch.org/docs/stable/data.html#torch.utils.data.Dataset), an abstract class representing a dataset. You need to write a subclass of `torch.utils.data.Dataset` (let's call it `NABirdsDataset`) so that it inherits from `torch.utils.data.Dataset`, but with characteristics matching our own dataset.\n\nLoad the packages:\n\n::: {#81820e04 .cell execution_count=2}\n``` {.python .cell-code}\nfrom torch.utils.data import Dataset, DataLoader\nimport imageio.v3 as iio\nimport matplotlib.pyplot as plt\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-bright-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-bright-red-fg\">ModuleNotFoundError</span>                       Traceback (most recent call last)\n<span class=\"ansi-bright-cyan-fg\">Cell</span><span class=\"ansi-bright-cyan-fg\"> </span><span class=\"ansi-green-fg\">In[2]</span><span class=\"ansi-green-fg\">, line 1</span>\n<span class=\"ansi-bright-green-fg\">----&gt; </span><span class=\"ansi-bright-green-fg\">1</span> <span style=\"color:rgb(255,95,135)\">from</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">torch</span><span class=\"ansi-bright-white-fg\">.</span><span class=\"ansi-bright-white-fg\">utils</span><span class=\"ansi-bright-white-fg\">.</span><span class=\"ansi-bright-white-fg\">data</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">import</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">Dataset</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">DataLoader</span>\n<span class=\"ansi-bright-green-fg\">      2</span> <span style=\"color:rgb(255,95,135)\">import</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">imageio</span><span class=\"ansi-bright-white-fg\">.</span><span class=\"ansi-bright-white-fg\">v3</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">as</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">iio</span>\n<span class=\"ansi-bright-green-fg\">      3</span> <span style=\"color:rgb(255,95,135)\">import</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">matplotlib</span><span class=\"ansi-bright-white-fg\">.</span><span class=\"ansi-bright-white-fg\">pyplot</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">as</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">plt</span>\n\n<span class=\"ansi-bright-red-fg\">ModuleNotFoundError</span>: No module named 'torch'</pre>\n```\n:::\n\n:::\n:::\n\n\nA PyTorch custom Dataset class must implement three methods:\n\n- `__init__`: initializes a new instance (object) of the class,\n- `__len__`: returns the number of samples in the new dataset class, and\n- `__getitem__`: loads and returns a sample from the dataset at a given index `idx`:\n\n::: {#f2b0b9e5 .cell execution_count=3}\n``` {.python .cell-code}\nclass NABirdsDataset(Dataset):\n    \"\"\"NABirds dataset class.\"\"\"\n    def __init__(self, metadata_file, data_dir, transform=None):\n        self.metadata = metadata_file\n        self.data_dir = data_dir\n        self.transform = transform\n    def __len__(self):\n        return len(self.metadata)\n    def __getitem__(self, idx):\n        img_path = os.path.join(\n            self.data_dir,\n            self.metadata.get_column(\"path\")[idx]\n        )\n        img = iio.imread(img_path)\n        img_id = self.metadata.get_column(\"id\")[idx].replace(\"_\", \" \")\n        img_photographer = self.metadata.get_column(\"photographer\")[idx].replace(\"_\", \" \")\n        img_bb_x = self.metadata.get_column(\"bb_x\")[idx]\n        img_bb_y = self.metadata.get_column(\"bb_y\")[idx]\n        img_bb_width = self.metadata.get_column(\"bb_width\")[idx]\n        img_bb_height = self.metadata.get_column(\"bb_height\")[idx]\n        sample = {\n            \"image\": img,\n            \"id\": img_id,\n            \"photographer\": img_photographer,\n            \"bb\" : (img_bb_x, img_bb_y, img_bb_width, img_bb_height)\n        }\n        if self.transform:\n            sample = self.transform(sample)\n        return sample\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-bright-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-bright-red-fg\">NameError</span>                                 Traceback (most recent call last)\n<span class=\"ansi-bright-cyan-fg\">Cell</span><span class=\"ansi-bright-cyan-fg\"> </span><span class=\"ansi-green-fg\">In[3]</span><span class=\"ansi-green-fg\">, line 1</span>\n<span class=\"ansi-bright-green-fg\">----&gt; </span><span class=\"ansi-bright-green-fg\">1</span> <span style=\"color:rgb(95,215,255)\">class</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(175,215,0)\">NABirdsDataset</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">Dataset</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">      2</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(215,215,135)\">\"\"\"NABirds dataset class.\"\"\"</span>\n<span class=\"ansi-bright-green-fg\">      3</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(95,215,255)\">def</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(175,215,0)\">__init__</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">self</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">metadata_file</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">data_dir</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">transform</span><span style=\"color:rgb(255,95,135)\">=</span><span style=\"color:rgb(95,215,255)\">None</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">:</span>\n\n<span class=\"ansi-bright-red-fg\">NameError</span>: name 'Dataset' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n:::\n\n## Instantiate our dataset class\n\n::: {#f96c2976 .cell execution_count=4}\n``` {.python .cell-code}\nnabirds_train = NABirdsDataset(\n    metadata_train,\n    os.path.join(base_dir, img_dir)\n    )\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-bright-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-bright-red-fg\">NameError</span>                                 Traceback (most recent call last)\n<span class=\"ansi-bright-cyan-fg\">Cell</span><span class=\"ansi-bright-cyan-fg\"> </span><span class=\"ansi-green-fg\">In[4]</span><span class=\"ansi-green-fg\">, line 1</span>\n<span class=\"ansi-bright-green-fg\">----&gt; </span><span class=\"ansi-bright-green-fg\">1</span> <span class=\"ansi-bright-white-fg\">nabirds_train</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">NABirdsDataset</span><span class=\"ansi-bright-white-fg\">(</span>\n<span class=\"ansi-bright-green-fg\">      2</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">metadata_train</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">      3</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">os</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">path</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">join</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">base_dir</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">img_dir</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">      4</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">)</span>\n\n<span class=\"ansi-bright-red-fg\">NameError</span>: name 'NABirdsDataset' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n## Display a data sample\n\nLet's display the first 4 images and their bounding boxes:\n\n::: {#631c4a2a .cell execution_count=5}\n``` {.python .cell-code}\nfig = plt.figure()\n\nfor i, sample in enumerate(nabirds_train):\n    print(i, sample['image'].shape)\n    ax = plt.subplot(1, 4, i + 1)\n    plt.tight_layout()\n    ax.set_title(\n        f\"Sample {i}, identification: {sample['id']}, picture by {sample['photographer']}\"\n    )\n    ax.axis('off')\n    ax.imshow(sample['image'])\n    rect = patches.Rectangle(\n        (sample['bb'][0], sample['bb'][1]),\n        sample['bb'][2],\n        sample['bb'][3],\n        linewidth=2,\n        edgecolor='r',\n        facecolor='none'\n    )\n    ax.add_patch(rect)\n    if i == 3:\n        plt.show()\n        break\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-bright-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-bright-red-fg\">NameError</span>                                 Traceback (most recent call last)\n<span class=\"ansi-bright-cyan-fg\">Cell</span><span class=\"ansi-bright-cyan-fg\"> </span><span class=\"ansi-green-fg\">In[5]</span><span class=\"ansi-green-fg\">, line 1</span>\n<span class=\"ansi-bright-green-fg\">----&gt; </span><span class=\"ansi-bright-green-fg\">1</span> <span class=\"ansi-bright-white-fg\">fig</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">plt</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">figure</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">      3</span> <span style=\"color:rgb(95,215,255)\">for</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">i</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">sample</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">in</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">enumerate</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">nabirds_train</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">      4</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">print</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">i</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">sample</span><span class=\"ansi-bright-white-fg\">[</span><span style=\"color:rgb(215,215,135)\">'</span><span style=\"color:rgb(215,215,135)\">image</span><span style=\"color:rgb(215,215,135)\">'</span><span class=\"ansi-bright-white-fg\">]</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">shape</span><span class=\"ansi-bright-white-fg\">)</span>\n\n<span class=\"ansi-bright-red-fg\">NameError</span>: name 'plt' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\nNotice how the images are all of different sizes. This is a problem. We are also not making use of the bounding boxes this dataset comes with, hence using parts of images we know do not contain any bird unnecessarily.\n\nWe will address these problems in the next section.\n\n",
    "supporting": [
      "jxai_dataset_files"
    ],
    "filters": [],
    "includes": {}
  }
}
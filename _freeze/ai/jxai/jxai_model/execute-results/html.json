{
  "hash": "3799563bd409943129d4eef6e42cc102",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: Model and training strategy\nauthor: Marie-Hélène Burle\nbibliography: jxai.bib\ncsl: diabetologia.csl\n---\n\n:::{.def}\n\n\n\n:::\n\n:::{.callout-note collapse=\"true\"}\n\n## Minimal necessary code from previous sections\n\n```{.python}\nbase_dir = \"<path-of-the-nabirds-dir>\"\n```\n\n:::{.notenoit}\n\nTo be replaced by actual path: in our training cluster, the `base_dir` is at `/project/def-sponsor00/nabirds`:\n\n```{.python}\nbase_dir = '/project/def-sponsor00/nabirds'\n```\n\n:::\n\n\n\n::: {#fc0a6102 .cell execution_count=2}\n``` {.python .cell-code}\nimport os\nimport polars as pl\nimport imageio.v3 as iio\nimport grain.python as grain\n\nmetadata = pl.read_parquet(\"metadata.parquet\")\nmetadata_train = metadata.filter(pl.col(\"is_training_img\") == 1)\nmetadata_val = metadata.filter(pl.col(\"is_training_img\") == 0)\ncleaned_img_dir = os.path.join(base_dir, \"cleaned_images\")\n\nclass NABirdsDataset:\n    \"\"\"NABirds dataset class.\"\"\"\n\n    def __init__(self, metadata_file, data_dir):\n        self.metadata_file = metadata_file\n        self.data_dir = data_dir\n\n    def __len__(self):\n        return len(self.metadata_file)\n\n    def __getitem__(self, idx):\n        path = os.path.join(self.data_dir, self.metadata_file.get_column(\"path\")[idx])\n        img = iio.imread(path)\n        species = self.metadata_file.get_column(\"species\")[idx].replace(\"_\", \" \")\n        subcategory = self.metadata_file.get_column(\"subcategory\")[idx]\n        if subcategory is not None:\n            subcategory = subcategory.replace(\"_\", \" \")\n        photographer = self.metadata_file.get_column(\"photographer\")[idx].replace(\"_\", \" \")\n        element = {\n            \"img\": img,\n            \"species\": species,\n            \"subcategory\": subcategory,\n            \"photographer\": photographer,\n        }\n\n        return element\n\nnabirds_train = NABirdsDataset(metadata_train, cleaned_img_dir)\nnabirds_val = NABirdsDataset(metadata_val, cleaned_img_dir)\n```\n:::\n\n\n:::\n\n## Our strategy\n\n### Technique\n\n\n\n### Architecture\n\nOptions that would make sense for our example include ResNet, EfficientNet, and ViT.\n\n#### ResNet\n\n[ResNet](https://en.wikipedia.org/wiki/Residual_neural_network), or residual network, is a type of architecture in which the layers are reformulated as learning residual functions with reference to the layer inputs. This allows for deeper (and thus more performant) networks [@he2015deepresiduallearningimage]. This is the oldest of the options that make sense for us, but it is also the most robust.\n\n![from @he2015deepresiduallearningimage](img/resnet.jpg){fig-alt=\"noshadow\" width=\"70%\"}\n\n[ResNet-50](https://huggingface.co/microsoft/resnet-50) is available from [Hugging Face](https://huggingface.co/) and has become a classic CNN for image classification.\n\n#### EfficientNet\n\n[EfficientNet](https://en.wikipedia.org/wiki/EfficientNet) is a family of newer computer vision CNNs from Google that uses a compound coefficient to uniformly scale depth, width, and resolution of networks and achieves better accuracy with fewer parameters than other CNNs [@tan2020efficientnetrethinkingmodelscaling]. This makes them easier to train on fewer resources and can lead to better results. Tuning them is however harder than the more robust ResNet family.\n\n![from @tan2020efficientnetrethinkingmodelscaling](img/efficientnet.jpg){fig-alt=\"noshadow\"}\n\nThere are variations for different image sizes sizes, all available in Hugging Face. For instance:\n\n- [EfficientNet b0](https://huggingface.co/google/efficientnet-b0) for images of size 224x224\n- [EfficientNet b2](https://huggingface.co/google/efficientnet-b2) for images 260x260\n- [EfficientNet b3](https://huggingface.co/google/efficientnet-b3) for images 300x300\n- [EfficientNet b7](https://huggingface.co/google/efficientnet-b7) for images 600x600\n\n#### ViT\n\nWhile the other options were CNN, [ViT](https://en.wikipedia.org/wiki/Vision_transformer), or vision transformer, is a transformer architecture (initially created for NLP tasks) applied to computer vision tasks [@dosovitskiy2021imageworth16x16words]. This is a more recent technique that attains excellent results while training substantially fewer computational resources.\n\n![from @dosovitskiy2021imageworth16x16words](img/vit.jpg){fig-alt=\"noshadow\"}\n\n[ViT](https://huggingface.co/docs/transformers/en/model_doc/vit) is available in Hugging Face.\n\nWhich one to choose depends on the available hardware, libraries in the framework you want to use, and other practical considerations. If time permits, this is a good case of [experiment tracking](/ai/mlops/wb_mlflow) with [MLflow](https://github.com/mlflow/mlflow).\n\n### Pre-trained weights\n\n\n### Choice of library\n\n\n### Strategy summary\n\nCategory | Answer\n-- | -----\nTechnique | Transfer learning\nArchitecture | EfficientNet-B2 (EfficientNet-B0 or ResNet-50 are other reasonable options)\nPre-trained weights | ImageNet\nLibrary | \n\n## Implementation\n\n[Flax](https://github.com/google/flax) is the neural network library in the JAX AI stack.\n\n[Hugging Face transformers](https://github.com/huggingface/transformers) package.\n\n::: {#5d595aeb .cell execution_count=3}\n``` {.python .cell-code}\nimport jax\nimport jax.numpy as jnp\nfrom flax import nnx\nimport optax\nfrom transformers import FlaxViTForImageClassification\n```\n:::\n\n\n::: {#8b3b1dad .cell execution_count=4}\n``` {.python .cell-code}\nclass VisionTransformer(nnx.Module):\n    \"\"\" Implements the ViT model, inheriting from `flax.nnx.Module`.\n\n    Args:\n        num_classes (int): Number of classes in the classification. Defaults to 1000.\n        in_channels (int): Number of input channels in the image (such as 3 for RGB). Defaults to 3.\n        img_size (int): Input image size. Defaults to 224.\n        patch_size (int): Size of the patches extracted from the image. Defaults to 16.\n        num_layers (int): Number of transformer encoder layers. Defaults to 12.\n        num_heads (int): Number of attention heads in each transformer layer. Defaults to 12.\n        mlp_dim (int): Dimension of the hidden layers in the feed-forward/MLP block. Defaults to 3072.\n        hidden_size (int): Dimensionality of the embedding vectors. Defaults to 3072.\n        dropout_rate (int): Dropout rate (for regularization). Defaults to 0.1.\n        rngs (flax.nnx.Rngs): A set of named `flax.nnx.RngStream` objects that generate a stream of JAX pseudo-random number generator (PRNG) keys. Defaults to `flax.nnx.Rngs(0)`.\n\n    \"\"\"\n    def __init__(\n        self,\n        num_classes: int = 1000,\n        in_channels: int = 3,\n        img_size: int = 224,\n        patch_size: int = 16,\n        num_layers: int = 12,\n        num_heads: int = 12,\n        mlp_dim: int = 3072,\n        hidden_size: int = 768,\n        dropout_rate: float = 0.1,\n        *,\n        rngs: nnx.Rngs = nnx.Rngs(0),\n    ):\n        # Calculate the number of patches generated from the image.\n        n_patches = (img_size // patch_size) ** 2\n        # Patch embeddings:\n        # - Extracts patches from the input image and maps them to embedding vectors\n        #   using `flax.nnx.Conv` (convolutional layer).\n        self.patch_embeddings = nnx.Conv(\n            in_channels,\n            hidden_size,\n            kernel_size=(patch_size, patch_size),\n            strides=(patch_size, patch_size),\n            padding=\"VALID\",\n            use_bias=True,\n            rngs=rngs,\n        )\n\n        # Positional embeddings (add information about image patch positions):\n        # Set the truncated normal initializer (using `jax.nn.initializers.truncated_normal`).\n        initializer = jax.nn.initializers.truncated_normal(stddev=0.02)\n        # The learnable parameter for positional embeddings (using `flax.nnx.Param`).\n        self.position_embeddings = nnx.Param(\n            initializer(rngs.params(), (1, n_patches + 1, hidden_size), jnp.float32)\n        ) # Shape `(1, n_patches +1, hidden_size`)\n        # The dropout layer.\n        self.dropout = nnx.Dropout(dropout_rate, rngs=rngs)\n\n        # CLS token (a special token prepended to the sequence of patch embeddings)\n        # using `flax.nnx.Param`.\n        self.cls_token = nnx.Param(jnp.zeros((1, 1, hidden_size)))\n\n        # Transformer encoder (a sequence of encoder blocks for feature extraction).\n        # - Create multiple Transformer encoder blocks (with `nnx.Sequential`\n        # and `TransformerEncoder(nnx.Module)` which is defined later).\n        self.encoder = nnx.Sequential(*[\n            TransformerEncoder(hidden_size, mlp_dim, num_heads, dropout_rate, rngs=rngs)\n            for i in range(num_layers)\n        ])\n        # Layer normalization with `flax.nnx.LayerNorm`.\n        self.final_norm = nnx.LayerNorm(hidden_size, rngs=rngs)\n\n        # Classification head (maps the transformer encoder to class probabilities).\n        self.classifier = nnx.Linear(hidden_size, num_classes, rngs=rngs)\n\n    # The forward pass in the ViT model.\n    def __call__(self, x: jax.Array) -> jax.Array:\n        # Image patch embeddings.\n        # Extract image patches and embed them.\n        patches = self.patch_embeddings(x)\n        # Get the batch size of image patches.\n        batch_size = patches.shape[0]\n        # Reshape the image patches.\n        patches = patches.reshape(batch_size, -1, patches.shape[-1])\n\n        # Replicate the CLS token for each image with `jax.numpy.tile`\n        # by constructing an array by repeating `cls_token` along `[batch_size, 1, 1]` dimensions.\n        cls_token = jnp.tile(self.cls_token, [batch_size, 1, 1])\n        # Concatenate the CLS token and image patch embeddings.\n        x = jnp.concat([cls_token, patches], axis=1)\n        # Create embedded patches by adding positional embeddings to the concatenated CLS token and image patch embeddings.\n        embeddings = x + self.position_embeddings\n        # Apply the dropout layer to embedded patches.\n        embeddings = self.dropout(embeddings)\n\n        # Transformer encoder blocks.\n        # Process the embedded patches through the transformer encoder layers.\n        x = self.encoder(embeddings)\n        # Apply layer normalization\n        x = self.final_norm(x)\n\n        # Extract the CLS token (first token), which represents the overall image embedding.\n        x = x[:, 0]\n\n        # Predict class probabilities based on the CLS token embedding.\n        return self.classifier(x)\n\n\nclass TransformerEncoder(nnx.Module):\n    \"\"\"\n    A single transformer encoder block in the ViT model, inheriting from `flax.nnx.Module`.\n\n    Args:\n        hidden_size (int): Input/output embedding dimensionality.\n        mlp_dim (int): Dimension of the feed-forward/MLP block hidden layer.\n        num_heads (int): Number of attention heads.\n        dropout_rate (float): Dropout rate. Defaults to 0.0.\n        rngs (flax.nnx.Rngs): A set of named `flax.nnx.RngStream` objects that generate a stream of JAX pseudo-random number generator (PRNG) keys. Defaults to `flax.nnx.Rngs(0)`.\n    \"\"\"\n    def __init__(\n        self,\n        hidden_size: int,\n        mlp_dim: int,\n        num_heads: int,\n        dropout_rate: float = 0.0,\n        *,\n        rngs: nnx.Rngs = nnx.Rngs(0),\n    ) -> None:\n        # First layer normalization using `flax.nnx.LayerNorm`\n        # before we apply Multi-Head Attentn.\n        self.norm1 = nnx.LayerNorm(hidden_size, rngs=rngs)\n        # The Multi-Head Attention layer (using `flax.nnx.MultiHeadAttention`).\n        self.attn = nnx.MultiHeadAttention(\n            num_heads=num_heads,\n            in_features=hidden_size,\n            dropout_rate=dropout_rate,\n            broadcast_dropout=False,\n            decode=False,\n            deterministic=False,\n            rngs=rngs,\n        )\n        # Second layer normalization using `flax.nnx.LayerNorm`.\n        self.norm2 = nnx.LayerNorm(hidden_size, rngs=rngs)\n\n        # The MLP for point-wise feedforward (using `flax.nnx.Sequential`, `flax.nnx.Linear, flax.nnx.Dropout`)\n        # with the GeLU activation function (`flax.nnx.gelu`).\n        self.mlp = nnx.Sequential(\n            nnx.Linear(hidden_size, mlp_dim, rngs=rngs),\n            nnx.gelu,\n            nnx.Dropout(dropout_rate, rngs=rngs),\n            nnx.Linear(mlp_dim, hidden_size, rngs=rngs),\n            nnx.Dropout(dropout_rate, rngs=rngs),\n        )\n\n    # The forward pass through the transformer encoder block.\n    def __call__(self, x: jax.Array) -> jax.Array:\n        # The Multi-Head Attention layer with layer normalization.\n        x = x + self.attn(self.norm1(x))\n        # The feed-forward network with layer normalization.\n        x = x + self.mlp(self.norm2(x))\n        return x\n\n# Example usage for testing:\nx = jnp.ones((4, 224, 224, 3))\nmodel = VisionTransformer(num_classes=1000)\ny = model(x)\nprint(\"Predictions shape: \", y.shape)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nE1215 11:14:52.683211  662132 cuda_blas.cc:196] failed to create cublas handle: the resource allocation failed\nE1215 11:14:52.683244  662132 cuda_blas.cc:199] Failure to initialize cublas may be due to OOM (cublas needs some free memory when you initialize it, and your deep-learning framework may have preallocated more than its fair share), or may be because this binary was not built with support for the GPU in your machine.\n```\n:::\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-bright-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-bright-red-fg\">JaxRuntimeError</span>                           Traceback (most recent call last)\n<span class=\"ansi-bright-cyan-fg\">Cell</span><span class=\"ansi-bright-cyan-fg\"> </span><span class=\"ansi-green-fg\">In[4]</span><span class=\"ansi-green-fg\">, line 163</span>\n<span class=\"ansi-bright-green-fg\">    161</span> <span class=\"ansi-bright-white-fg\">x</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">jnp</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">ones</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">(</span><span style=\"color:rgb(175,135,255)\">4</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(175,135,255)\">224</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(175,135,255)\">224</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(175,135,255)\">3</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">    162</span> <span class=\"ansi-bright-white-fg\">model</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">VisionTransformer</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">num_classes</span><span style=\"color:rgb(255,95,135)\">=</span><span style=\"color:rgb(175,135,255)\">1000</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">163</span> <span class=\"ansi-bright-white-fg\">y</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">model</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">x</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">    164</span> <span class=\"ansi-bright-white-fg\">print</span><span class=\"ansi-bright-white-fg\">(</span><span style=\"color:rgb(215,215,135)\">\"</span><span style=\"color:rgb(215,215,135)\">Predictions shape: </span><span style=\"color:rgb(215,215,135)\">\"</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">y</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">shape</span><span class=\"ansi-bright-white-fg\">)</span>\n\n<span class=\"ansi-bright-cyan-fg\">Cell</span><span class=\"ansi-bright-cyan-fg\"> </span><span class=\"ansi-green-fg\">In[4]</span><span class=\"ansi-green-fg\">, line 95</span>, in <span class=\"ansi-cyan-fg\">VisionTransformer.__call__</span><span class=\"ansi-bright-blue-fg\">(self, x)</span>\n<span class=\"ansi-bright-green-fg\">     91</span> <span class=\"ansi-bright-white-fg\">embeddings</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">dropout</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">embeddings</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">     93</span> <span style=\"color:rgb(138,138,138)\"># Transformer encoder blocks.</span>\n<span class=\"ansi-bright-green-fg\">     94</span> <span style=\"color:rgb(138,138,138)\"># Process the embedded patches through the transformer encoder layers.</span>\n<span class=\"ansi-bright-green-fg\">---&gt; </span><span class=\"ansi-bright-green-fg\">95</span> <span class=\"ansi-bright-white-fg\">x</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">self</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">encoder</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">embeddings</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">     96</span> <span style=\"color:rgb(138,138,138)\"># Apply layer normalization</span>\n<span class=\"ansi-bright-green-fg\">     97</span> <span class=\"ansi-bright-white-fg\">x</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">final_norm</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">x</span><span class=\"ansi-bright-white-fg\">)</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/flax/nnx/helpers.py:275</span>, in <span class=\"ansi-cyan-fg\">Sequential.__call__</span><span class=\"ansi-bright-blue-fg\">(self, rngs, *args, **kwargs)</span>\n<span class=\"ansi-bright-green-fg\">    272</span> <span class=\"ansi-bright-white-fg\">  </span><span style=\"color:rgb(95,215,255)\">if</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">rngs</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">is</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">not</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">None</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">and</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">has_keyword_arg</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">f</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(215,215,135)\">'</span><span style=\"color:rgb(215,215,135)\">rngs</span><span style=\"color:rgb(215,215,135)\">'</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    273</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">kwargs</span><span class=\"ansi-bright-white-fg\">[</span><span style=\"color:rgb(215,215,135)\">'</span><span style=\"color:rgb(215,215,135)\">rngs</span><span style=\"color:rgb(215,215,135)\">'</span><span class=\"ansi-bright-white-fg\">]</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">rngs</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">275</span> <span class=\"ansi-bright-white-fg\">  </span><span class=\"ansi-bright-white-fg\">output</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">f</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">*</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">args</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">*</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">*</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">kwargs</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">    277</span> <span style=\"color:rgb(95,215,255)\">return</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">output</span>\n\n<span class=\"ansi-bright-cyan-fg\">Cell</span><span class=\"ansi-bright-cyan-fg\"> </span><span class=\"ansi-green-fg\">In[4]</span><span class=\"ansi-green-fg\">, line 155</span>, in <span class=\"ansi-cyan-fg\">TransformerEncoder.__call__</span><span class=\"ansi-bright-blue-fg\">(self, x)</span>\n<span class=\"ansi-bright-green-fg\">    153</span> <span style=\"color:rgb(95,215,255)\">def</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(175,215,0)\">__call__</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">self</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">x</span><span class=\"ansi-bright-white-fg\">:</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">jax</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">Array</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">-</span><span style=\"color:rgb(255,95,135)\">&gt;</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">jax</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">Array</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    154</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(138,138,138)\"># The Multi-Head Attention layer with layer normalization.</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">155</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">x</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">x</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">+</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">self</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">attn</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">self</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">norm1</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">x</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">    156</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(138,138,138)\"># The feed-forward network with layer normalization.</span>\n<span class=\"ansi-bright-green-fg\">    157</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">x</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">x</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">+</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">mlp</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">norm2</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">x</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">)</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/flax/nnx/nn/attention.py:507</span>, in <span class=\"ansi-cyan-fg\">MultiHeadAttention.__call__</span><span class=\"ansi-bright-blue-fg\">(self, inputs_q, inputs_k, inputs_v, mask, deterministic, rngs, sow_weights, decode)</span>\n<span class=\"ansi-bright-green-fg\">    501</span> <span style=\"color:rgb(95,215,255)\">if</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">inputs_q</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">shape</span><span class=\"ansi-bright-white-fg\">[</span><span style=\"color:rgb(255,95,135)\">-</span><span style=\"color:rgb(175,135,255)\">1</span><span class=\"ansi-bright-white-fg\">]</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">!=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">in_features</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    502</span> <span class=\"ansi-bright-white-fg\">  </span><span style=\"color:rgb(95,215,255)\">raise</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(175,215,0)\">ValueError</span><span class=\"ansi-bright-white-fg\">(</span>\n<span class=\"ansi-bright-green-fg\">    503</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(215,215,135)\">f</span><span style=\"color:rgb(215,215,135)\">'</span><span style=\"color:rgb(215,215,135)\">Incompatible input dimension, got </span><span style=\"color:rgb(215,215,135)\">{</span><span class=\"ansi-bright-white-fg\">inputs_q</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">shape</span><span class=\"ansi-bright-white-fg\">[</span><span style=\"color:rgb(255,95,135)\">-</span><span style=\"color:rgb(175,135,255)\">1</span><span class=\"ansi-bright-white-fg\">]</span><span style=\"color:rgb(215,215,135)\">}</span><span style=\"color:rgb(215,215,135)\"> </span><span style=\"color:rgb(215,215,135)\">'</span>\n<span class=\"ansi-bright-green-fg\">    504</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(215,215,135)\">f</span><span style=\"color:rgb(215,215,135)\">'</span><span style=\"color:rgb(215,215,135)\">but module expects </span><span style=\"color:rgb(215,215,135)\">{</span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">in_features</span><span style=\"color:rgb(215,215,135)\">}</span><span style=\"color:rgb(215,215,135)\">.</span><span style=\"color:rgb(215,215,135)\">'</span>\n<span class=\"ansi-bright-green-fg\">    505</span> <span class=\"ansi-bright-white-fg\">  </span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">507</span> <span class=\"ansi-bright-white-fg\">query</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">self</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">query</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">inputs_q</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">    508</span> <span class=\"ansi-bright-white-fg\">key</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">key</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">inputs_k</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">    509</span> <span class=\"ansi-bright-white-fg\">value</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">value</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">inputs_v</span><span class=\"ansi-bright-white-fg\">)</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/flax/nnx/nn/linear.py:290</span>, in <span class=\"ansi-cyan-fg\">LinearGeneral.__call__</span><span class=\"ansi-bright-blue-fg\">(self, inputs)</span>\n<span class=\"ansi-bright-green-fg\">    288</span> <span style=\"color:rgb(95,215,255)\">if</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">preferred_element_type</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">is</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">not</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">None</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    289</span> <span class=\"ansi-bright-white-fg\">  </span><span class=\"ansi-bright-white-fg\">dot_general_kwargs</span><span class=\"ansi-bright-white-fg\">[</span><span style=\"color:rgb(215,215,135)\">\"</span><span style=\"color:rgb(215,215,135)\">preferred_element_type</span><span style=\"color:rgb(215,215,135)\">\"</span><span class=\"ansi-bright-white-fg\">]</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">preferred_element_type</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">290</span> <span class=\"ansi-bright-white-fg\">out</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">dot_general</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span>\n<span class=\"ansi-bright-green-fg\">    291</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">  </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">inputs</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    292</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">  </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">kernel</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    293</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">  </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">axis</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">contract_ind</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">batch_axis</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">batch_ind</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    294</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">  </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">precision</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">self</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">precision</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    295</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">  </span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">*</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">*</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">dot_general_kwargs</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    296</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">    297</span> <span style=\"color:rgb(138,138,138)\"># dot_general output has shape [batch_dims/group_dims] + [feature_dims]</span>\n<span class=\"ansi-bright-green-fg\">    298</span> <span style=\"color:rgb(95,215,255)\">if</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">bias</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">is</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">not</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">None</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    299</span> <span class=\"ansi-bright-white-fg\">  </span><span style=\"color:rgb(138,138,138)\"># expand bias shape to broadcast bias over batch dims.</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/jax/_src/lax/lax.py:2448</span>, in <span class=\"ansi-cyan-fg\">dot_general</span><span class=\"ansi-bright-blue-fg\">(lhs, rhs, dimension_numbers, precision, preferred_element_type, out_sharding)</span>\n<span class=\"ansi-bright-green-fg\">   2436</span> <span style=\"color:rgb(95,215,255)\">def</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(175,215,0)\">dot_general</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">lhs</span><span class=\"ansi-bright-white-fg\">:</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">ArrayLike</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">rhs</span><span class=\"ansi-bright-white-fg\">:</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">ArrayLike</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">   2437</span> <span class=\"ansi-bright-white-fg\">                </span><span class=\"ansi-bright-white-fg\">dimension_numbers</span><span class=\"ansi-bright-white-fg\">:</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">DotDimensionNumbers</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">   2438</span> <span class=\"ansi-bright-white-fg\">                </span><span class=\"ansi-bright-white-fg\">precision</span><span class=\"ansi-bright-white-fg\">:</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">PrecisionLike</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">None</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">   2439</span> <span class=\"ansi-bright-white-fg\">                </span><span class=\"ansi-bright-white-fg\">preferred_element_type</span><span class=\"ansi-bright-white-fg\">:</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">DTypeLike</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">|</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">None</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">None</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">   2440</span> <span class=\"ansi-bright-white-fg\">                </span><span style=\"color:rgb(255,95,135)\">*</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">   2441</span> <span class=\"ansi-bright-white-fg\">                </span><span class=\"ansi-bright-white-fg\">out_sharding</span><span style=\"color:rgb(255,95,135)\">=</span><span style=\"color:rgb(95,215,255)\">None</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">-</span><span style=\"color:rgb(255,95,135)\">&gt;</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">Array</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">   2442</span> <span class=\"ansi-bright-white-fg\">  </span><span style=\"color:rgb(215,215,135)\">\"\"\"Alias of :func:`jax.lax.dot`.</span>\n<span class=\"ansi-bright-green-fg\">   2443</span> \n<span class=\"ansi-bright-green-fg\">   2444</span> <span style=\"color:rgb(215,215,135)\">  Prefer use of :func:`jax.lax.dot` directly, but note that it requires</span>\n<span class=\"ansi-bright-green-fg\">   2445</span> <span style=\"color:rgb(215,215,135)\">  all arguments after ``lhs`` and ``rhs`` to be specified by keyword</span>\n<span class=\"ansi-bright-green-fg\">   2446</span> <span style=\"color:rgb(215,215,135)\">  rather than position.</span>\n<span class=\"ansi-bright-green-fg\">   2447</span> <span style=\"color:rgb(215,215,135)\">  \"\"\"</span>\n<span class=\"ansi-bright-green-fg\">-&gt; </span><span class=\"ansi-bright-green-fg\">2448</span> <span class=\"ansi-bright-white-fg\">  </span><span style=\"color:rgb(95,215,255)\">return</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">dot</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">lhs</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">rhs</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">dimension_numbers</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">dimension_numbers</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">precision</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">precision</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">   2449</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">             </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">preferred_element_type</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">preferred_element_type</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">out_sharding</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">out_sharding</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/jax/_src/lax/lax.py:2557</span>, in <span class=\"ansi-cyan-fg\">dot</span><span class=\"ansi-bright-blue-fg\">(***failed resolving arguments***)</span>\n<span class=\"ansi-bright-green-fg\">   2553</span> <span class=\"ansi-bright-white-fg\">preferred_element_type</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">(</span>\n<span class=\"ansi-bright-green-fg\">   2554</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(95,215,255)\">None</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">if</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">preferred_element_type</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">is</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">None</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">else</span>\n<span class=\"ansi-bright-green-fg\">   2555</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">dtypes</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">check_and_canonicalize_user_dtype</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">preferred_element_type</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(215,215,135)\">'</span><span style=\"color:rgb(215,215,135)\">dot</span><span style=\"color:rgb(215,215,135)\">'</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">   2556</span> <span class=\"ansi-bright-white-fg\">lhs</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">rhs</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">core</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">standard_insert_pvary</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">lhs</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">rhs</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">-&gt; </span><span class=\"ansi-bright-green-fg\">2557</span> <span style=\"color:rgb(95,215,255)\">return</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">dot_general_p</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">bind</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">lhs</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">rhs</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">   2558</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">                          </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">dimension_numbers</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">cdims</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">bdims</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">   2559</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">                          </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">precision</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">canonicalize_precision</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">precision</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">   2560</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">                          </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">preferred_element_type</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">preferred_element_type</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">   2561</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">                          </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">out_sharding</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">out_sharding</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/jax/_src/core.py:632</span>, in <span class=\"ansi-cyan-fg\">Primitive.bind</span><span class=\"ansi-bright-blue-fg\">(self, *args, **params)</span>\n<span class=\"ansi-bright-green-fg\">    630</span> <span style=\"color:rgb(95,215,255)\">def</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(175,215,0)\">bind</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">self</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">*</span><span class=\"ansi-bright-white-fg\">args</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">*</span><span style=\"color:rgb(255,95,135)\">*</span><span class=\"ansi-bright-white-fg\">params</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    631</span> <span class=\"ansi-bright-white-fg\">  </span><span class=\"ansi-bright-white-fg\">args</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">args</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">if</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">skip_canonicalization</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">else</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">map</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">canonicalize_value</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">args</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">632</span> <span class=\"ansi-bright-white-fg\">  </span><span style=\"color:rgb(95,215,255)\">return</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">self</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">_true_bind</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">*</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">args</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">*</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">*</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">params</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/jax/_src/core.py:648</span>, in <span class=\"ansi-cyan-fg\">Primitive._true_bind</span><span class=\"ansi-bright-blue-fg\">(self, *args, **params)</span>\n<span class=\"ansi-bright-green-fg\">    646</span> <span class=\"ansi-bright-white-fg\">trace_ctx</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">set_trace</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">eval_trace</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">    647</span> <span style=\"color:rgb(95,215,255)\">try</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">648</span> <span class=\"ansi-bright-white-fg\">  </span><span style=\"color:rgb(95,215,255)\">return</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">self</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">bind_with_trace</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">prev_trace</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">args</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">params</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">    649</span> <span style=\"color:rgb(95,215,255)\">finally</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    650</span> <span class=\"ansi-bright-white-fg\">  </span><span class=\"ansi-bright-white-fg\">trace_ctx</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">set_trace</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">prev_trace</span><span class=\"ansi-bright-white-fg\">)</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/jax/_src/core.py:660</span>, in <span class=\"ansi-cyan-fg\">Primitive.bind_with_trace</span><span class=\"ansi-bright-blue-fg\">(self, trace, args, params)</span>\n<span class=\"ansi-bright-green-fg\">    658</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(95,215,255)\">with</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">set_current_trace</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">trace</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    659</span> <span class=\"ansi-bright-white-fg\">      </span><span style=\"color:rgb(95,215,255)\">return</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">to_lojax</span><span class=\"ansi-bright-white-fg\">(</span><span style=\"color:rgb(255,95,135)\">*</span><span class=\"ansi-bright-white-fg\">args</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">*</span><span style=\"color:rgb(255,95,135)\">*</span><span class=\"ansi-bright-white-fg\">params</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">  </span><span style=\"color:rgb(138,138,138)\"># type: ignore</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">660</span> <span class=\"ansi-bright-white-fg\">  </span><span style=\"color:rgb(95,215,255)\">return</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">trace</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">process_primitive</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">self</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">args</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">params</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">    661</span> <span class=\"ansi-bright-white-fg\">trace</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">process_primitive</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">self</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">args</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">params</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">  </span><span style=\"color:rgb(138,138,138)\"># may raise lojax error</span>\n<span class=\"ansi-bright-green-fg\">    662</span> <span style=\"color:rgb(95,215,255)\">raise</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(175,215,0)\">Exception</span><span class=\"ansi-bright-white-fg\">(</span><span style=\"color:rgb(215,215,135)\">f</span><span style=\"color:rgb(215,215,135)\">\"</span><span style=\"color:rgb(215,215,135)\">couldn</span><span style=\"color:rgb(215,215,135)\">'</span><span style=\"color:rgb(215,215,135)\">t apply typeof to args: </span><span style=\"color:rgb(215,215,135)\">{</span><span class=\"ansi-bright-white-fg\">args</span><span style=\"color:rgb(215,215,135)\">}</span><span style=\"color:rgb(215,215,135)\">\"</span><span class=\"ansi-bright-white-fg\">)</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/jax/_src/core.py:1189</span>, in <span class=\"ansi-cyan-fg\">EvalTrace.process_primitive</span><span class=\"ansi-bright-blue-fg\">(self, primitive, args, params)</span>\n<span class=\"ansi-bright-green-fg\">   1187</span> <span class=\"ansi-bright-white-fg\">args</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">map</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">full_lower</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">args</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">   1188</span> <span class=\"ansi-bright-white-fg\">check_eval_args</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">args</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">-&gt; </span><span class=\"ansi-bright-green-fg\">1189</span> <span style=\"color:rgb(95,215,255)\">return</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">primitive</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">impl</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">*</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">args</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">*</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">*</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">params</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/jax/_src/dispatch.py:94</span>, in <span class=\"ansi-cyan-fg\">apply_primitive</span><span class=\"ansi-bright-blue-fg\">(prim, *args, **params)</span>\n<span class=\"ansi-bright-green-fg\">     92</span> <span class=\"ansi-bright-white-fg\">prev</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">config</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">disable_jit</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">swap_local</span><span class=\"ansi-bright-white-fg\">(</span><span style=\"color:rgb(95,215,255)\">False</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">     93</span> <span style=\"color:rgb(95,215,255)\">try</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">---&gt; </span><span class=\"ansi-bright-green-fg\">94</span> <span class=\"ansi-bright-white-fg\">  </span><span class=\"ansi-bright-white-fg\">outs</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">fun</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">*</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">args</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">     95</span> <span style=\"color:rgb(95,215,255)\">finally</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">     96</span> <span class=\"ansi-bright-white-fg\">  </span><span class=\"ansi-bright-white-fg\">config</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">disable_jit</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">set_local</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">prev</span><span class=\"ansi-bright-white-fg\">)</span>\n\n    <span class=\"ansi-bright-red-fg\">[... skipping hidden 11 frame]</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/jax/_src/compiler.py:375</span>, in <span class=\"ansi-cyan-fg\">backend_compile_and_load</span><span class=\"ansi-bright-blue-fg\">(backend, module, executable_devices, options, host_callbacks)</span>\n<span class=\"ansi-bright-green-fg\">    366</span> <span class=\"ansi-bright-white-fg\">      </span><span style=\"color:rgb(95,215,255)\">return</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">backend</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">compile_and_load</span><span class=\"ansi-bright-white-fg\">(</span>\n<span class=\"ansi-bright-green-fg\">    367</span> <span class=\"ansi-bright-white-fg\">          </span><span class=\"ansi-bright-white-fg\">built_c</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">    368</span> <span class=\"ansi-bright-white-fg\">          </span><span class=\"ansi-bright-white-fg\">executable_devices</span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\">executable_devices</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">    369</span> <span class=\"ansi-bright-white-fg\">          </span><span class=\"ansi-bright-white-fg\">compile_options</span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\">options</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">    370</span> <span class=\"ansi-bright-white-fg\">          </span><span class=\"ansi-bright-white-fg\">host_callbacks</span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\">host_callbacks</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">    371</span> <span class=\"ansi-bright-white-fg\">      </span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">    372</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(138,138,138)\"># Some backends don't have `host_callbacks` option yet</span>\n<span class=\"ansi-bright-green-fg\">    373</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(138,138,138)\"># TODO(sharadmv): remove this fallback when all backends allow `compile`</span>\n<span class=\"ansi-bright-green-fg\">    374</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(138,138,138)\"># to take in `host_callbacks`</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">375</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(95,215,255)\">return</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">backend</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">compile_and_load</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span>\n<span class=\"ansi-bright-green-fg\">    376</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">        </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">built_c</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    377</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">        </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">executable_devices</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">executable_devices</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    378</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">        </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">compile_options</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">options</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    379</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">    </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">    380</span> <span style=\"color:rgb(95,215,255)\">except</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">_jax</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">JaxRuntimeError</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">as</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">e</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    381</span> <span class=\"ansi-bright-white-fg\">  </span><span style=\"color:rgb(95,215,255)\">for</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">error_handler</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">in</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">_XLA_RUNTIME_ERROR_HANDLERS</span><span class=\"ansi-bright-white-fg\">:</span>\n\n<span class=\"ansi-bright-red-fg\">JaxRuntimeError</span>: INTERNAL: Failed to getBlas support.</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#f37318a9 .cell execution_count=5}\n``` {.python .cell-code}\ntf_model = FlaxViTForImageClassification.from_pretrained('google/vit-base-patch16-224')\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nTensorFlow and JAX classes are deprecated and will be removed in Transformers v5. We recommend migrating to PyTorch classes or pinning your version of Transformers.\nE1215 11:14:55.938523  662132 cuda_blas.cc:196] failed to create cublas handle: the resource allocation failed\nE1215 11:14:55.938535  662132 cuda_blas.cc:199] Failure to initialize cublas may be due to OOM (cublas needs some free memory when you initialize it, and your deep-learning framework may have preallocated more than its fair share), or may be because this binary was not built with support for the GPU in your machine.\n```\n:::\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-bright-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-bright-red-fg\">JaxRuntimeError</span>                           Traceback (most recent call last)\n<span class=\"ansi-bright-cyan-fg\">Cell</span><span class=\"ansi-bright-cyan-fg\"> </span><span class=\"ansi-green-fg\">In[5]</span><span class=\"ansi-green-fg\">, line 1</span>\n<span class=\"ansi-bright-green-fg\">----&gt; </span><span class=\"ansi-bright-green-fg\">1</span> <span class=\"ansi-bright-white-fg\">tf_model</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">FlaxViTForImageClassification</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">from_pretrained</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span style=\"color:rgb(215,215,135)\" class=\"ansi-yellow-bg\">'</span><span style=\"color:rgb(215,215,135)\" class=\"ansi-yellow-bg\">google/vit-base-patch16-224</span><span style=\"color:rgb(215,215,135)\" class=\"ansi-yellow-bg\">'</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/transformers/modeling_flax_utils.py:895</span>, in <span class=\"ansi-cyan-fg\">FlaxPreTrainedModel.from_pretrained</span><span class=\"ansi-bright-blue-fg\">(cls, pretrained_model_name_or_path, dtype, config, cache_dir, ignore_mismatched_sizes, force_download, local_files_only, token, revision, *model_args, **kwargs)</span>\n<span class=\"ansi-bright-green-fg\">    892</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">safetensors_from_pt</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">safetensors_metadata</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">get</span><span class=\"ansi-bright-white-fg\">(</span><span style=\"color:rgb(215,215,135)\">\"</span><span style=\"color:rgb(215,215,135)\">format</span><span style=\"color:rgb(215,215,135)\">\"</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">==</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(215,215,135)\">\"</span><span style=\"color:rgb(215,215,135)\">pt</span><span style=\"color:rgb(215,215,135)\">\"</span>\n<span class=\"ansi-bright-green-fg\">    894</span> <span style=\"color:rgb(138,138,138)\"># init random models</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">895</span> <span class=\"ansi-bright-white-fg\">model</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">cls</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">config</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">*</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">model_args</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">_do_init</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">_do_init</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">*</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">*</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">model_kwargs</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">    897</span> <span style=\"color:rgb(95,215,255)\">if</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">from_pt</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">or</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">safetensors_from_pt</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    898</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">state</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">load_pytorch_checkpoint_in_flax_state_dict</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">model</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">resolved_archive_file</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">is_sharded</span><span class=\"ansi-bright-white-fg\">)</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/transformers/models/vit/modeling_flax_vit.py:452</span>, in <span class=\"ansi-cyan-fg\">FlaxViTPreTrainedModel.__init__</span><span class=\"ansi-bright-blue-fg\">(self, config, input_shape, seed, dtype, _do_init, **kwargs)</span>\n<span class=\"ansi-bright-green-fg\">    450</span> <span style=\"color:rgb(95,215,255)\">if</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">input_shape</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">is</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">None</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    451</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">input_shape</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">(</span><span style=\"color:rgb(175,135,255)\">1</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">config</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">image_size</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">config</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">image_size</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">config</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">num_channels</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">452</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">super</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span style=\"color:rgb(175,215,0)\" class=\"ansi-yellow-bg\">__init__</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">config</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">module</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">input_shape</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">input_shape</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">seed</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">seed</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">dtype</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">dtype</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">_do_init</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">_do_init</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/transformers/modeling_flax_utils.py:207</span>, in <span class=\"ansi-cyan-fg\">FlaxPreTrainedModel.__init__</span><span class=\"ansi-bright-blue-fg\">(self, config, module, input_shape, seed, dtype, _do_init)</span>\n<span class=\"ansi-bright-green-fg\">    203</span> <span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">_is_initialized</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">_do_init</span>\n<span class=\"ansi-bright-green-fg\">    205</span> <span style=\"color:rgb(95,215,255)\">if</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">_do_init</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    206</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(138,138,138)\"># randomly initialized parameters</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">207</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">random_params</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">self</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">init_weights</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">self</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">key</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">input_shape</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">    208</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">params_shape_tree</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">jax</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">eval_shape</span><span class=\"ansi-bright-white-fg\">(</span><span style=\"color:rgb(95,215,255)\">lambda</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">params</span><span class=\"ansi-bright-white-fg\">:</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">params</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">random_params</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">    209</span> <span style=\"color:rgb(95,215,255)\">else</span><span class=\"ansi-bright-white-fg\">:</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/transformers/models/vit/modeling_flax_vit.py:461</span>, in <span class=\"ansi-cyan-fg\">FlaxViTPreTrainedModel.init_weights</span><span class=\"ansi-bright-blue-fg\">(self, rng, input_shape, params)</span>\n<span class=\"ansi-bright-green-fg\">    458</span> <span class=\"ansi-bright-white-fg\">params_rng</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">dropout_rng</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">jax</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">random</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">split</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">rng</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">    459</span> <span class=\"ansi-bright-white-fg\">rngs</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">{</span><span style=\"color:rgb(215,215,135)\">\"</span><span style=\"color:rgb(215,215,135)\">params</span><span style=\"color:rgb(215,215,135)\">\"</span><span class=\"ansi-bright-white-fg\">:</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">params_rng</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(215,215,135)\">\"</span><span style=\"color:rgb(215,215,135)\">dropout</span><span style=\"color:rgb(215,215,135)\">\"</span><span class=\"ansi-bright-white-fg\">:</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">dropout_rng</span><span class=\"ansi-bright-white-fg\">}</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">461</span> <span class=\"ansi-bright-white-fg\">random_params</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">self</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">module</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">init</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">rngs</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">pixel_values</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">return_dict</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span style=\"color:rgb(95,215,255)\" class=\"ansi-yellow-bg\">False</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span><span class=\"ansi-bright-white-fg\">[</span><span style=\"color:rgb(215,215,135)\">\"</span><span style=\"color:rgb(215,215,135)\">params</span><span style=\"color:rgb(215,215,135)\">\"</span><span class=\"ansi-bright-white-fg\">]</span>\n<span class=\"ansi-bright-green-fg\">    463</span> <span style=\"color:rgb(95,215,255)\">if</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">params</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">is</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">not</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">None</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    464</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">random_params</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">flatten_dict</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">unfreeze</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">random_params</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">)</span>\n\n    <span class=\"ansi-bright-red-fg\">[... skipping hidden 9 frame]</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/transformers/models/vit/modeling_flax_vit.py:611</span>, in <span class=\"ansi-cyan-fg\">FlaxViTForImageClassificationModule.__call__</span><span class=\"ansi-bright-blue-fg\">(self, pixel_values, deterministic, output_attentions, output_hidden_states, return_dict)</span>\n<span class=\"ansi-bright-green-fg\">    601</span> <span style=\"color:rgb(95,215,255)\">def</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(175,215,0)\">__call__</span><span class=\"ansi-bright-white-fg\">(</span>\n<span class=\"ansi-bright-green-fg\">    602</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">self</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">    603</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">pixel_values</span><span style=\"color:rgb(255,95,135)\">=</span><span style=\"color:rgb(95,215,255)\">None</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">   (...)</span><span class=\"ansi-bright-green-fg\">    607</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">return_dict</span><span style=\"color:rgb(255,95,135)\">=</span><span style=\"color:rgb(95,215,255)\">None</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">    608</span> <span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    609</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">return_dict</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">return_dict</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">if</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">return_dict</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">is</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">not</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">None</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">else</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">config</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">use_return_dict</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">611</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">outputs</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">self</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">vit</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span>\n<span class=\"ansi-bright-green-fg\">    612</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">        </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">pixel_values</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    613</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">        </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">deterministic</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">deterministic</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    614</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">        </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">output_attentions</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">output_attentions</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    615</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">        </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">output_hidden_states</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">output_hidden_states</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    616</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">        </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">return_dict</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">return_dict</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    617</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">    </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">    619</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">hidden_states</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">outputs</span><span class=\"ansi-bright-white-fg\">[</span><span style=\"color:rgb(175,135,255)\">0</span><span class=\"ansi-bright-white-fg\">]</span>\n<span class=\"ansi-bright-green-fg\">    620</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">logits</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">classifier</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">hidden_states</span><span class=\"ansi-bright-white-fg\">[</span><span class=\"ansi-bright-white-fg\">:</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(175,135,255)\">0</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">:</span><span class=\"ansi-bright-white-fg\">]</span><span class=\"ansi-bright-white-fg\">)</span>\n\n    <span class=\"ansi-bright-red-fg\">[... skipping hidden 2 frame]</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/transformers/models/vit/modeling_flax_vit.py:528</span>, in <span class=\"ansi-cyan-fg\">FlaxViTModule.__call__</span><span class=\"ansi-bright-blue-fg\">(self, pixel_values, deterministic, output_attentions, output_hidden_states, return_dict)</span>\n<span class=\"ansi-bright-green-fg\">    518</span> <span style=\"color:rgb(95,215,255)\">def</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(175,215,0)\">__call__</span><span class=\"ansi-bright-white-fg\">(</span>\n<span class=\"ansi-bright-green-fg\">    519</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">self</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">    520</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">pixel_values</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">   (...)</span><span class=\"ansi-bright-green-fg\">    524</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">return_dict</span><span class=\"ansi-bright-white-fg\">:</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">bool</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">True</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">    525</span> <span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    526</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">hidden_states</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">embeddings</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">pixel_values</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">deterministic</span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\">deterministic</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">528</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">outputs</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">self</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">encoder</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span>\n<span class=\"ansi-bright-green-fg\">    529</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">        </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">hidden_states</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    530</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">        </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">deterministic</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">deterministic</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    531</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">        </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">output_attentions</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">output_attentions</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    532</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">        </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">output_hidden_states</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">output_hidden_states</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    533</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">        </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">return_dict</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">return_dict</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    534</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">    </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">    535</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">hidden_states</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">outputs</span><span class=\"ansi-bright-white-fg\">[</span><span style=\"color:rgb(175,135,255)\">0</span><span class=\"ansi-bright-white-fg\">]</span>\n<span class=\"ansi-bright-green-fg\">    536</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">hidden_states</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">layernorm</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">hidden_states</span><span class=\"ansi-bright-white-fg\">)</span>\n\n    <span class=\"ansi-bright-red-fg\">[... skipping hidden 2 frame]</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/transformers/models/vit/modeling_flax_vit.py:400</span>, in <span class=\"ansi-cyan-fg\">FlaxViTEncoder.__call__</span><span class=\"ansi-bright-blue-fg\">(self, hidden_states, deterministic, output_attentions, output_hidden_states, return_dict)</span>\n<span class=\"ansi-bright-green-fg\">    392</span> <span style=\"color:rgb(95,215,255)\">def</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(175,215,0)\">__call__</span><span class=\"ansi-bright-white-fg\">(</span>\n<span class=\"ansi-bright-green-fg\">    393</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">self</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">    394</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">hidden_states</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">   (...)</span><span class=\"ansi-bright-green-fg\">    398</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">return_dict</span><span class=\"ansi-bright-white-fg\">:</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">bool</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">True</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">    399</span> <span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">400</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(95,215,255)\">return</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">self</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">layer</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span>\n<span class=\"ansi-bright-green-fg\">    401</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">        </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">hidden_states</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    402</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">        </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">deterministic</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">deterministic</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    403</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">        </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">output_attentions</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">output_attentions</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    404</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">        </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">output_hidden_states</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">output_hidden_states</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    405</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">        </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">return_dict</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">return_dict</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    406</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">    </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n\n    <span class=\"ansi-bright-red-fg\">[... skipping hidden 2 frame]</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/transformers/models/vit/modeling_flax_vit.py:366</span>, in <span class=\"ansi-cyan-fg\">FlaxViTLayerCollection.__call__</span><span class=\"ansi-bright-blue-fg\">(self, hidden_states, deterministic, output_attentions, output_hidden_states, return_dict)</span>\n<span class=\"ansi-bright-green-fg\">    363</span> <span style=\"color:rgb(95,215,255)\">if</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">output_hidden_states</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    364</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">all_hidden_states</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">+</span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">hidden_states</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">366</span> <span class=\"ansi-bright-white-fg\">layer_outputs</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">layer</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">hidden_states</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">deterministic</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">deterministic</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">output_attentions</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">output_attentions</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">    368</span> <span class=\"ansi-bright-white-fg\">hidden_states</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">layer_outputs</span><span class=\"ansi-bright-white-fg\">[</span><span style=\"color:rgb(175,135,255)\">0</span><span class=\"ansi-bright-white-fg\">]</span>\n<span class=\"ansi-bright-green-fg\">    370</span> <span style=\"color:rgb(95,215,255)\">if</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">output_attentions</span><span class=\"ansi-bright-white-fg\">:</span>\n\n    <span class=\"ansi-bright-red-fg\">[... skipping hidden 2 frame]</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/transformers/models/vit/modeling_flax_vit.py:318</span>, in <span class=\"ansi-cyan-fg\">FlaxViTLayer.__call__</span><span class=\"ansi-bright-blue-fg\">(self, hidden_states, deterministic, output_attentions)</span>\n<span class=\"ansi-bright-green-fg\">    317</span> <span style=\"color:rgb(95,215,255)\">def</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(175,215,0)\">__call__</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">self</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">hidden_states</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">deterministic</span><span class=\"ansi-bright-white-fg\">:</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">bool</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">True</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">output_attentions</span><span class=\"ansi-bright-white-fg\">:</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">bool</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">False</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">318</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">attention_outputs</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">self</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">attention</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span>\n<span class=\"ansi-bright-green-fg\">    319</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">        </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">self</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">layernorm_before</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">hidden_states</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">  </span><span style=\"color:rgb(138,138,138)\" class=\"ansi-yellow-bg\"># in ViT, layernorm is applied before self-attention</span>\n<span class=\"ansi-bright-green-fg\">    320</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">        </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">deterministic</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">deterministic</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    321</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">        </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">output_attentions</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">output_attentions</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    322</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">    </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">    324</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">attention_output</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">attention_outputs</span><span class=\"ansi-bright-white-fg\">[</span><span style=\"color:rgb(175,135,255)\">0</span><span class=\"ansi-bright-white-fg\">]</span>\n<span class=\"ansi-bright-green-fg\">    326</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(138,138,138)\"># first residual connection</span>\n\n    <span class=\"ansi-bright-red-fg\">[... skipping hidden 2 frame]</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/transformers/models/vit/modeling_flax_vit.py:253</span>, in <span class=\"ansi-cyan-fg\">FlaxViTAttention.__call__</span><span class=\"ansi-bright-blue-fg\">(self, hidden_states, deterministic, output_attentions)</span>\n<span class=\"ansi-bright-green-fg\">    252</span> <span style=\"color:rgb(95,215,255)\">def</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(175,215,0)\">__call__</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">self</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">hidden_states</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">deterministic</span><span style=\"color:rgb(255,95,135)\">=</span><span style=\"color:rgb(95,215,255)\">True</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">output_attentions</span><span class=\"ansi-bright-white-fg\">:</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">bool</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">False</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">253</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">attn_outputs</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">self</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">attention</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">hidden_states</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">deterministic</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">deterministic</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">output_attentions</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">output_attentions</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">    254</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">attn_output</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">attn_outputs</span><span class=\"ansi-bright-white-fg\">[</span><span style=\"color:rgb(175,135,255)\">0</span><span class=\"ansi-bright-white-fg\">]</span>\n<span class=\"ansi-bright-green-fg\">    255</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">hidden_states</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">output</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">attn_output</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">hidden_states</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">deterministic</span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\">deterministic</span><span class=\"ansi-bright-white-fg\">)</span>\n\n    <span class=\"ansi-bright-red-fg\">[... skipping hidden 2 frame]</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/transformers/models/vit/modeling_flax_vit.py:192</span>, in <span class=\"ansi-cyan-fg\">FlaxViTSelfAttention.__call__</span><span class=\"ansi-bright-blue-fg\">(self, hidden_states, deterministic, output_attentions)</span>\n<span class=\"ansi-bright-green-fg\">    189</span> <span style=\"color:rgb(95,215,255)\">def</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(175,215,0)\">__call__</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">self</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">hidden_states</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">deterministic</span><span class=\"ansi-bright-white-fg\">:</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">bool</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">True</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">output_attentions</span><span class=\"ansi-bright-white-fg\">:</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">bool</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">False</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    190</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">head_dim</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">config</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">hidden_size</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">/</span><span style=\"color:rgb(255,95,135)\">/</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">config</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">num_attention_heads</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">192</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">query_states</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">self</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">query</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">hidden_states</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">reshape</span><span class=\"ansi-bright-white-fg\">(</span>\n<span class=\"ansi-bright-green-fg\">    193</span> <span class=\"ansi-bright-white-fg\">        </span><span class=\"ansi-bright-white-fg\">hidden_states</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">shape</span><span class=\"ansi-bright-white-fg\">[</span><span class=\"ansi-bright-white-fg\">:</span><span style=\"color:rgb(175,135,255)\">2</span><span class=\"ansi-bright-white-fg\">]</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">+</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">config</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">num_attention_heads</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">head_dim</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">    194</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">    195</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">value_states</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">value</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">hidden_states</span><span class=\"ansi-bright-white-fg\">)</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">reshape</span><span class=\"ansi-bright-white-fg\">(</span>\n<span class=\"ansi-bright-green-fg\">    196</span> <span class=\"ansi-bright-white-fg\">        </span><span class=\"ansi-bright-white-fg\">hidden_states</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">shape</span><span class=\"ansi-bright-white-fg\">[</span><span class=\"ansi-bright-white-fg\">:</span><span style=\"color:rgb(175,135,255)\">2</span><span class=\"ansi-bright-white-fg\">]</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">+</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">config</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">num_attention_heads</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">head_dim</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">    197</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">    198</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">key_states</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">key</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">hidden_states</span><span class=\"ansi-bright-white-fg\">)</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">reshape</span><span class=\"ansi-bright-white-fg\">(</span>\n<span class=\"ansi-bright-green-fg\">    199</span> <span class=\"ansi-bright-white-fg\">        </span><span class=\"ansi-bright-white-fg\">hidden_states</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">shape</span><span class=\"ansi-bright-white-fg\">[</span><span class=\"ansi-bright-white-fg\">:</span><span style=\"color:rgb(175,135,255)\">2</span><span class=\"ansi-bright-white-fg\">]</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">+</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">config</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">num_attention_heads</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">head_dim</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">    200</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">)</span>\n\n    <span class=\"ansi-bright-red-fg\">[... skipping hidden 2 frame]</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/flax/linen/linear.py:287</span>, in <span class=\"ansi-cyan-fg\">Dense.__call__</span><span class=\"ansi-bright-blue-fg\">(self, inputs)</span>\n<span class=\"ansi-bright-green-fg\">    285</span> <span style=\"color:rgb(95,215,255)\">else</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    286</span> <span class=\"ansi-bright-white-fg\">  </span><span class=\"ansi-bright-white-fg\">dot_general</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">lax</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">dot_general</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">287</span> <span class=\"ansi-bright-white-fg\">y</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">dot_general</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span>\n<span class=\"ansi-bright-green-fg\">    288</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">  </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">inputs</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    289</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">  </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">kernel</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    290</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">  </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">inputs</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">ndim</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">-</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span style=\"color:rgb(175,135,255)\" class=\"ansi-yellow-bg\">1</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span style=\"color:rgb(175,135,255)\" class=\"ansi-yellow-bg\">0</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    291</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">  </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">precision</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">self</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">precision</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    292</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">    293</span> <span style=\"color:rgb(95,215,255)\">if</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">bias</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">is</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">not</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">None</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    294</span> <span class=\"ansi-bright-white-fg\">  </span><span class=\"ansi-bright-white-fg\">y</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">+</span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">jnp</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">reshape</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">bias</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">(</span><span style=\"color:rgb(175,135,255)\">1</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">*</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">y</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">ndim</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">-</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(175,135,255)\">1</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">+</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">(</span><span style=\"color:rgb(255,95,135)\">-</span><span style=\"color:rgb(175,135,255)\">1</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">)</span>\n\n    <span class=\"ansi-bright-red-fg\">[... skipping hidden 18 frame]</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/jax/_src/compiler.py:375</span>, in <span class=\"ansi-cyan-fg\">backend_compile_and_load</span><span class=\"ansi-bright-blue-fg\">(backend, module, executable_devices, options, host_callbacks)</span>\n<span class=\"ansi-bright-green-fg\">    366</span> <span class=\"ansi-bright-white-fg\">      </span><span style=\"color:rgb(95,215,255)\">return</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">backend</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">compile_and_load</span><span class=\"ansi-bright-white-fg\">(</span>\n<span class=\"ansi-bright-green-fg\">    367</span> <span class=\"ansi-bright-white-fg\">          </span><span class=\"ansi-bright-white-fg\">built_c</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">    368</span> <span class=\"ansi-bright-white-fg\">          </span><span class=\"ansi-bright-white-fg\">executable_devices</span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\">executable_devices</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">    369</span> <span class=\"ansi-bright-white-fg\">          </span><span class=\"ansi-bright-white-fg\">compile_options</span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\">options</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">    370</span> <span class=\"ansi-bright-white-fg\">          </span><span class=\"ansi-bright-white-fg\">host_callbacks</span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\">host_callbacks</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">    371</span> <span class=\"ansi-bright-white-fg\">      </span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">    372</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(138,138,138)\"># Some backends don't have `host_callbacks` option yet</span>\n<span class=\"ansi-bright-green-fg\">    373</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(138,138,138)\"># TODO(sharadmv): remove this fallback when all backends allow `compile`</span>\n<span class=\"ansi-bright-green-fg\">    374</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(138,138,138)\"># to take in `host_callbacks`</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">375</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(95,215,255)\">return</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">backend</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">compile_and_load</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span>\n<span class=\"ansi-bright-green-fg\">    376</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">        </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">built_c</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    377</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">        </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">executable_devices</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">executable_devices</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    378</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">        </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">compile_options</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">options</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    379</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">    </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">    380</span> <span style=\"color:rgb(95,215,255)\">except</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">_jax</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">JaxRuntimeError</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">as</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">e</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    381</span> <span class=\"ansi-bright-white-fg\">  </span><span style=\"color:rgb(95,215,255)\">for</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">error_handler</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">in</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">_XLA_RUNTIME_ERROR_HANDLERS</span><span class=\"ansi-bright-white-fg\">:</span>\n\n<span class=\"ansi-bright-red-fg\">JaxRuntimeError</span>: INTERNAL: Failed to getBlas support.</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#b7850df3 .cell execution_count=6}\n``` {.python .cell-code}\n# Copies weights from a TF ViT model to a Flax ViT model, reshaping layers\n# to match the expected shapes in Flax.\ndef vit_inplace_copy_weights(*, src_model, dst_model):\n    assert isinstance(src_model, FlaxViTForImageClassification)\n    assert isinstance(dst_model, VisionTransformer)\n\n    tf_model_params = src_model.params\n    tf_model_params_fstate = nnx.traversals.flatten_mapping(tf_model_params)\n\n    # Notice the use of `flax.nnx.state`.\n    flax_model_params = nnx.state(dst_model, nnx.Param)\n    flax_model_params_fstate = dict(flax_model_params.flat_state())\n\n    # Mapping from Flax parameter names to TF parameter names.\n    params_name_mapping = {\n        (\"cls_token\",): (\"vit\", \"embeddings\", \"cls_token\"),\n        (\"position_embeddings\",): (\"vit\", \"embeddings\", \"position_embeddings\"),\n        **{\n            (\"patch_embeddings\", x): (\"vit\", \"embeddings\", \"patch_embeddings\", \"projection\", x)\n            for x in [\"kernel\", \"bias\"]\n        },\n        **{\n            (\"encoder\", \"layers\", i, \"attn\", y, x): (\n                \"vit\", \"encoder\", \"layer\", str(i), \"attention\", \"attention\", y, x\n            )\n            for x in [\"kernel\", \"bias\"]\n            for y in [\"key\", \"value\", \"query\"]\n            for i in range(12)\n        },\n        **{\n            (\"encoder\", \"layers\", i, \"attn\", \"out\", x): (\n                \"vit\", \"encoder\", \"layer\", str(i), \"attention\", \"output\", \"dense\", x\n            )\n            for x in [\"kernel\", \"bias\"]\n            for i in range(12)\n        },\n        **{\n            (\"encoder\", \"layers\", i, \"mlp\", \"layers\", y1, x): (\n                \"vit\", \"encoder\", \"layer\", str(i), y2, \"dense\", x\n            )\n            for x in [\"kernel\", \"bias\"]\n            for y1, y2 in [(0, \"intermediate\"), (3, \"output\")]\n            for i in range(12)\n        },\n        **{\n            (\"encoder\", \"layers\", i, y1, x): (\n                \"vit\", \"encoder\", \"layer\", str(i), y2, x\n            )\n            for x in [\"scale\", \"bias\"]\n            for y1, y2 in [(\"norm1\", \"layernorm_before\"), (\"norm2\", \"layernorm_after\")]\n            for i in range(12)\n        },\n        **{\n            (\"final_norm\", x): (\"vit\", \"layernorm\", x)\n            for x in [\"scale\", \"bias\"]\n        },\n        **{\n            (\"classifier\", x): (\"classifier\", x)\n            for x in [\"kernel\", \"bias\"]\n        }\n    }\n\n    nonvisited = set(flax_model_params_fstate.keys())\n\n    for key1, key2 in params_name_mapping.items():\n        assert key1 in flax_model_params_fstate, key1\n        assert key2 in tf_model_params_fstate, (key1, key2)\n\n        nonvisited.remove(key1)\n\n        src_value = tf_model_params_fstate[key2]\n        if key2[-1] == \"kernel\" and key2[-2] in (\"key\", \"value\", \"query\"):\n            shape = src_value.shape\n            src_value = src_value.reshape((shape[0], 12, 64))\n\n        if key2[-1] == \"bias\" and key2[-2] in (\"key\", \"value\", \"query\"):\n            src_value = src_value.reshape((12, 64))\n\n        if key2[-4:] == (\"attention\", \"output\", \"dense\", \"kernel\"):\n            shape = src_value.shape\n            src_value = src_value.reshape((12, 64, shape[-1]))\n\n        dst_value = flax_model_params_fstate[key1]\n        assert src_value.shape == dst_value.value.shape, (key2, src_value.shape, key1, dst_value.value.shape)\n        dst_value.value = src_value.copy()\n        assert dst_value.value.mean() == src_value.mean(), (dst_value.value, src_value.mean())\n\n    assert len(nonvisited) == 0, nonvisited\n    # Notice the use of `flax.nnx.update` and `flax.nnx.State`.\n    nnx.update(dst_model, nnx.State.from_flat_path(flax_model_params_fstate))\n\n\nvit_inplace_copy_weights(src_model=tf_model, dst_model=model)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-bright-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-bright-red-fg\">NameError</span>                                 Traceback (most recent call last)\n<span class=\"ansi-bright-cyan-fg\">Cell</span><span class=\"ansi-bright-cyan-fg\"> </span><span class=\"ansi-green-fg\">In[6]</span><span class=\"ansi-green-fg\">, line 93</span>\n<span class=\"ansi-bright-green-fg\">     89</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(138,138,138)\"># Notice the use of `flax.nnx.update` and `flax.nnx.State`.</span>\n<span class=\"ansi-bright-green-fg\">     90</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">nnx</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">update</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">dst_model</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">nnx</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">State</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">from_flat_path</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">flax_model_params_fstate</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">---&gt; </span><span class=\"ansi-bright-green-fg\">93</span> <span class=\"ansi-bright-white-fg\">vit_inplace_copy_weights</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">src_model</span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">tf_model</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">dst_model</span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\">model</span><span class=\"ansi-bright-white-fg\">)</span>\n\n<span class=\"ansi-bright-red-fg\">NameError</span>: name 'tf_model' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#f60fb193 .cell execution_count=7}\n``` {.python .cell-code}\nmodel.classifier = nnx.Linear(model.classifier.in_features, 405, rngs=nnx.Rngs(0))\n\nx = jnp.ones((4, 224, 224, 3))\ny = model(x)\nprint(\"Predictions shape: \", y.shape)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nE1215 11:14:56.788769  662132 cuda_blas.cc:196] failed to create cublas handle: the resource allocation failed\nE1215 11:14:56.788781  662132 cuda_blas.cc:199] Failure to initialize cublas may be due to OOM (cublas needs some free memory when you initialize it, and your deep-learning framework may have preallocated more than its fair share), or may be because this binary was not built with support for the GPU in your machine.\n```\n:::\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-bright-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-bright-red-fg\">JaxRuntimeError</span>                           Traceback (most recent call last)\n<span class=\"ansi-bright-cyan-fg\">Cell</span><span class=\"ansi-bright-cyan-fg\"> </span><span class=\"ansi-green-fg\">In[7]</span><span class=\"ansi-green-fg\">, line 4</span>\n<span class=\"ansi-bright-green-fg\">      1</span> <span class=\"ansi-bright-white-fg\">model</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">classifier</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">nnx</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">Linear</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">model</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">classifier</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">in_features</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(175,135,255)\">405</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">rngs</span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\">nnx</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">Rngs</span><span class=\"ansi-bright-white-fg\">(</span><span style=\"color:rgb(175,135,255)\">0</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">      3</span> <span class=\"ansi-bright-white-fg\">x</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">jnp</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">ones</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">(</span><span style=\"color:rgb(175,135,255)\">4</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(175,135,255)\">224</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(175,135,255)\">224</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(175,135,255)\">3</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">----&gt; </span><span class=\"ansi-bright-green-fg\">4</span> <span class=\"ansi-bright-white-fg\">y</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">model</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">x</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">      5</span> <span class=\"ansi-bright-white-fg\">print</span><span class=\"ansi-bright-white-fg\">(</span><span style=\"color:rgb(215,215,135)\">\"</span><span style=\"color:rgb(215,215,135)\">Predictions shape: </span><span style=\"color:rgb(215,215,135)\">\"</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">y</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">shape</span><span class=\"ansi-bright-white-fg\">)</span>\n\n<span class=\"ansi-bright-cyan-fg\">Cell</span><span class=\"ansi-bright-cyan-fg\"> </span><span class=\"ansi-green-fg\">In[4]</span><span class=\"ansi-green-fg\">, line 95</span>, in <span class=\"ansi-cyan-fg\">VisionTransformer.__call__</span><span class=\"ansi-bright-blue-fg\">(self, x)</span>\n<span class=\"ansi-bright-green-fg\">     91</span> <span class=\"ansi-bright-white-fg\">embeddings</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">dropout</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">embeddings</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">     93</span> <span style=\"color:rgb(138,138,138)\"># Transformer encoder blocks.</span>\n<span class=\"ansi-bright-green-fg\">     94</span> <span style=\"color:rgb(138,138,138)\"># Process the embedded patches through the transformer encoder layers.</span>\n<span class=\"ansi-bright-green-fg\">---&gt; </span><span class=\"ansi-bright-green-fg\">95</span> <span class=\"ansi-bright-white-fg\">x</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">self</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">encoder</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">embeddings</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">     96</span> <span style=\"color:rgb(138,138,138)\"># Apply layer normalization</span>\n<span class=\"ansi-bright-green-fg\">     97</span> <span class=\"ansi-bright-white-fg\">x</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">final_norm</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">x</span><span class=\"ansi-bright-white-fg\">)</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/flax/nnx/helpers.py:275</span>, in <span class=\"ansi-cyan-fg\">Sequential.__call__</span><span class=\"ansi-bright-blue-fg\">(self, rngs, *args, **kwargs)</span>\n<span class=\"ansi-bright-green-fg\">    272</span> <span class=\"ansi-bright-white-fg\">  </span><span style=\"color:rgb(95,215,255)\">if</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">rngs</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">is</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">not</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">None</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">and</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">has_keyword_arg</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">f</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(215,215,135)\">'</span><span style=\"color:rgb(215,215,135)\">rngs</span><span style=\"color:rgb(215,215,135)\">'</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    273</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">kwargs</span><span class=\"ansi-bright-white-fg\">[</span><span style=\"color:rgb(215,215,135)\">'</span><span style=\"color:rgb(215,215,135)\">rngs</span><span style=\"color:rgb(215,215,135)\">'</span><span class=\"ansi-bright-white-fg\">]</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">rngs</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">275</span> <span class=\"ansi-bright-white-fg\">  </span><span class=\"ansi-bright-white-fg\">output</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">f</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">*</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">args</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">*</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">*</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">kwargs</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">    277</span> <span style=\"color:rgb(95,215,255)\">return</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">output</span>\n\n<span class=\"ansi-bright-cyan-fg\">Cell</span><span class=\"ansi-bright-cyan-fg\"> </span><span class=\"ansi-green-fg\">In[4]</span><span class=\"ansi-green-fg\">, line 155</span>, in <span class=\"ansi-cyan-fg\">TransformerEncoder.__call__</span><span class=\"ansi-bright-blue-fg\">(self, x)</span>\n<span class=\"ansi-bright-green-fg\">    153</span> <span style=\"color:rgb(95,215,255)\">def</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(175,215,0)\">__call__</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">self</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">x</span><span class=\"ansi-bright-white-fg\">:</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">jax</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">Array</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">-</span><span style=\"color:rgb(255,95,135)\">&gt;</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">jax</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">Array</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    154</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(138,138,138)\"># The Multi-Head Attention layer with layer normalization.</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">155</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">x</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">x</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">+</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">self</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">attn</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">self</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">norm1</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">x</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">    156</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(138,138,138)\"># The feed-forward network with layer normalization.</span>\n<span class=\"ansi-bright-green-fg\">    157</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">x</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">x</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">+</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">mlp</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">norm2</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">x</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">)</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/flax/nnx/nn/attention.py:507</span>, in <span class=\"ansi-cyan-fg\">MultiHeadAttention.__call__</span><span class=\"ansi-bright-blue-fg\">(self, inputs_q, inputs_k, inputs_v, mask, deterministic, rngs, sow_weights, decode)</span>\n<span class=\"ansi-bright-green-fg\">    501</span> <span style=\"color:rgb(95,215,255)\">if</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">inputs_q</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">shape</span><span class=\"ansi-bright-white-fg\">[</span><span style=\"color:rgb(255,95,135)\">-</span><span style=\"color:rgb(175,135,255)\">1</span><span class=\"ansi-bright-white-fg\">]</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">!=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">in_features</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    502</span> <span class=\"ansi-bright-white-fg\">  </span><span style=\"color:rgb(95,215,255)\">raise</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(175,215,0)\">ValueError</span><span class=\"ansi-bright-white-fg\">(</span>\n<span class=\"ansi-bright-green-fg\">    503</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(215,215,135)\">f</span><span style=\"color:rgb(215,215,135)\">'</span><span style=\"color:rgb(215,215,135)\">Incompatible input dimension, got </span><span style=\"color:rgb(215,215,135)\">{</span><span class=\"ansi-bright-white-fg\">inputs_q</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">shape</span><span class=\"ansi-bright-white-fg\">[</span><span style=\"color:rgb(255,95,135)\">-</span><span style=\"color:rgb(175,135,255)\">1</span><span class=\"ansi-bright-white-fg\">]</span><span style=\"color:rgb(215,215,135)\">}</span><span style=\"color:rgb(215,215,135)\"> </span><span style=\"color:rgb(215,215,135)\">'</span>\n<span class=\"ansi-bright-green-fg\">    504</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(215,215,135)\">f</span><span style=\"color:rgb(215,215,135)\">'</span><span style=\"color:rgb(215,215,135)\">but module expects </span><span style=\"color:rgb(215,215,135)\">{</span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">in_features</span><span style=\"color:rgb(215,215,135)\">}</span><span style=\"color:rgb(215,215,135)\">.</span><span style=\"color:rgb(215,215,135)\">'</span>\n<span class=\"ansi-bright-green-fg\">    505</span> <span class=\"ansi-bright-white-fg\">  </span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">507</span> <span class=\"ansi-bright-white-fg\">query</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">self</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">query</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">inputs_q</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">    508</span> <span class=\"ansi-bright-white-fg\">key</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">key</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">inputs_k</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">    509</span> <span class=\"ansi-bright-white-fg\">value</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">value</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">inputs_v</span><span class=\"ansi-bright-white-fg\">)</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/flax/nnx/nn/linear.py:290</span>, in <span class=\"ansi-cyan-fg\">LinearGeneral.__call__</span><span class=\"ansi-bright-blue-fg\">(self, inputs)</span>\n<span class=\"ansi-bright-green-fg\">    288</span> <span style=\"color:rgb(95,215,255)\">if</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">preferred_element_type</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">is</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">not</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">None</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    289</span> <span class=\"ansi-bright-white-fg\">  </span><span class=\"ansi-bright-white-fg\">dot_general_kwargs</span><span class=\"ansi-bright-white-fg\">[</span><span style=\"color:rgb(215,215,135)\">\"</span><span style=\"color:rgb(215,215,135)\">preferred_element_type</span><span style=\"color:rgb(215,215,135)\">\"</span><span class=\"ansi-bright-white-fg\">]</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">preferred_element_type</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">290</span> <span class=\"ansi-bright-white-fg\">out</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">dot_general</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span>\n<span class=\"ansi-bright-green-fg\">    291</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">  </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">inputs</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    292</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">  </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">kernel</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    293</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">  </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">axis</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">contract_ind</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">batch_axis</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">batch_ind</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    294</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">  </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">precision</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">self</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">precision</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    295</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">  </span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">*</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">*</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">dot_general_kwargs</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    296</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">    297</span> <span style=\"color:rgb(138,138,138)\"># dot_general output has shape [batch_dims/group_dims] + [feature_dims]</span>\n<span class=\"ansi-bright-green-fg\">    298</span> <span style=\"color:rgb(95,215,255)\">if</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">bias</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">is</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">not</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">None</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    299</span> <span class=\"ansi-bright-white-fg\">  </span><span style=\"color:rgb(138,138,138)\"># expand bias shape to broadcast bias over batch dims.</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/jax/_src/lax/lax.py:2448</span>, in <span class=\"ansi-cyan-fg\">dot_general</span><span class=\"ansi-bright-blue-fg\">(lhs, rhs, dimension_numbers, precision, preferred_element_type, out_sharding)</span>\n<span class=\"ansi-bright-green-fg\">   2436</span> <span style=\"color:rgb(95,215,255)\">def</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(175,215,0)\">dot_general</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">lhs</span><span class=\"ansi-bright-white-fg\">:</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">ArrayLike</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">rhs</span><span class=\"ansi-bright-white-fg\">:</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">ArrayLike</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">   2437</span> <span class=\"ansi-bright-white-fg\">                </span><span class=\"ansi-bright-white-fg\">dimension_numbers</span><span class=\"ansi-bright-white-fg\">:</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">DotDimensionNumbers</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">   2438</span> <span class=\"ansi-bright-white-fg\">                </span><span class=\"ansi-bright-white-fg\">precision</span><span class=\"ansi-bright-white-fg\">:</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">PrecisionLike</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">None</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">   2439</span> <span class=\"ansi-bright-white-fg\">                </span><span class=\"ansi-bright-white-fg\">preferred_element_type</span><span class=\"ansi-bright-white-fg\">:</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">DTypeLike</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">|</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">None</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">None</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">   2440</span> <span class=\"ansi-bright-white-fg\">                </span><span style=\"color:rgb(255,95,135)\">*</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">   2441</span> <span class=\"ansi-bright-white-fg\">                </span><span class=\"ansi-bright-white-fg\">out_sharding</span><span style=\"color:rgb(255,95,135)\">=</span><span style=\"color:rgb(95,215,255)\">None</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">-</span><span style=\"color:rgb(255,95,135)\">&gt;</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">Array</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">   2442</span> <span class=\"ansi-bright-white-fg\">  </span><span style=\"color:rgb(215,215,135)\">\"\"\"Alias of :func:`jax.lax.dot`.</span>\n<span class=\"ansi-bright-green-fg\">   2443</span> \n<span class=\"ansi-bright-green-fg\">   2444</span> <span style=\"color:rgb(215,215,135)\">  Prefer use of :func:`jax.lax.dot` directly, but note that it requires</span>\n<span class=\"ansi-bright-green-fg\">   2445</span> <span style=\"color:rgb(215,215,135)\">  all arguments after ``lhs`` and ``rhs`` to be specified by keyword</span>\n<span class=\"ansi-bright-green-fg\">   2446</span> <span style=\"color:rgb(215,215,135)\">  rather than position.</span>\n<span class=\"ansi-bright-green-fg\">   2447</span> <span style=\"color:rgb(215,215,135)\">  \"\"\"</span>\n<span class=\"ansi-bright-green-fg\">-&gt; </span><span class=\"ansi-bright-green-fg\">2448</span> <span class=\"ansi-bright-white-fg\">  </span><span style=\"color:rgb(95,215,255)\">return</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">dot</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">lhs</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">rhs</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">dimension_numbers</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">dimension_numbers</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">precision</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">precision</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">   2449</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">             </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">preferred_element_type</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">preferred_element_type</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">out_sharding</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">out_sharding</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/jax/_src/lax/lax.py:2557</span>, in <span class=\"ansi-cyan-fg\">dot</span><span class=\"ansi-bright-blue-fg\">(***failed resolving arguments***)</span>\n<span class=\"ansi-bright-green-fg\">   2553</span> <span class=\"ansi-bright-white-fg\">preferred_element_type</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">(</span>\n<span class=\"ansi-bright-green-fg\">   2554</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(95,215,255)\">None</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">if</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">preferred_element_type</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">is</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">None</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">else</span>\n<span class=\"ansi-bright-green-fg\">   2555</span> <span class=\"ansi-bright-white-fg\">    </span><span class=\"ansi-bright-white-fg\">dtypes</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">check_and_canonicalize_user_dtype</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">preferred_element_type</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(215,215,135)\">'</span><span style=\"color:rgb(215,215,135)\">dot</span><span style=\"color:rgb(215,215,135)\">'</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">   2556</span> <span class=\"ansi-bright-white-fg\">lhs</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">rhs</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">core</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">standard_insert_pvary</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">lhs</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">rhs</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">-&gt; </span><span class=\"ansi-bright-green-fg\">2557</span> <span style=\"color:rgb(95,215,255)\">return</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">dot_general_p</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">bind</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">lhs</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">rhs</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">   2558</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">                          </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">dimension_numbers</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">cdims</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">bdims</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">   2559</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">                          </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">precision</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">canonicalize_precision</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">precision</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">   2560</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">                          </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">preferred_element_type</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">preferred_element_type</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">   2561</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">                          </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">out_sharding</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">out_sharding</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/jax/_src/core.py:632</span>, in <span class=\"ansi-cyan-fg\">Primitive.bind</span><span class=\"ansi-bright-blue-fg\">(self, *args, **params)</span>\n<span class=\"ansi-bright-green-fg\">    630</span> <span style=\"color:rgb(95,215,255)\">def</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(175,215,0)\">bind</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">self</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">*</span><span class=\"ansi-bright-white-fg\">args</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">*</span><span style=\"color:rgb(255,95,135)\">*</span><span class=\"ansi-bright-white-fg\">params</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    631</span> <span class=\"ansi-bright-white-fg\">  </span><span class=\"ansi-bright-white-fg\">args</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">args</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">if</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">skip_canonicalization</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">else</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">map</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">canonicalize_value</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">args</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">632</span> <span class=\"ansi-bright-white-fg\">  </span><span style=\"color:rgb(95,215,255)\">return</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">self</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">_true_bind</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">*</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">args</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">*</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">*</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">params</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/jax/_src/core.py:648</span>, in <span class=\"ansi-cyan-fg\">Primitive._true_bind</span><span class=\"ansi-bright-blue-fg\">(self, *args, **params)</span>\n<span class=\"ansi-bright-green-fg\">    646</span> <span class=\"ansi-bright-white-fg\">trace_ctx</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">set_trace</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">eval_trace</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">    647</span> <span style=\"color:rgb(95,215,255)\">try</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">648</span> <span class=\"ansi-bright-white-fg\">  </span><span style=\"color:rgb(95,215,255)\">return</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">self</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">bind_with_trace</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">prev_trace</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">args</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">params</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">    649</span> <span style=\"color:rgb(95,215,255)\">finally</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    650</span> <span class=\"ansi-bright-white-fg\">  </span><span class=\"ansi-bright-white-fg\">trace_ctx</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">set_trace</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">prev_trace</span><span class=\"ansi-bright-white-fg\">)</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/jax/_src/core.py:660</span>, in <span class=\"ansi-cyan-fg\">Primitive.bind_with_trace</span><span class=\"ansi-bright-blue-fg\">(self, trace, args, params)</span>\n<span class=\"ansi-bright-green-fg\">    658</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(95,215,255)\">with</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">set_current_trace</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">trace</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    659</span> <span class=\"ansi-bright-white-fg\">      </span><span style=\"color:rgb(95,215,255)\">return</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">self</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">to_lojax</span><span class=\"ansi-bright-white-fg\">(</span><span style=\"color:rgb(255,95,135)\">*</span><span class=\"ansi-bright-white-fg\">args</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">*</span><span style=\"color:rgb(255,95,135)\">*</span><span class=\"ansi-bright-white-fg\">params</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">  </span><span style=\"color:rgb(138,138,138)\"># type: ignore</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">660</span> <span class=\"ansi-bright-white-fg\">  </span><span style=\"color:rgb(95,215,255)\">return</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">trace</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">process_primitive</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">self</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">args</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">params</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">    661</span> <span class=\"ansi-bright-white-fg\">trace</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">process_primitive</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">self</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">args</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">params</span><span class=\"ansi-bright-white-fg\">)</span><span class=\"ansi-bright-white-fg\">  </span><span style=\"color:rgb(138,138,138)\"># may raise lojax error</span>\n<span class=\"ansi-bright-green-fg\">    662</span> <span style=\"color:rgb(95,215,255)\">raise</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(175,215,0)\">Exception</span><span class=\"ansi-bright-white-fg\">(</span><span style=\"color:rgb(215,215,135)\">f</span><span style=\"color:rgb(215,215,135)\">\"</span><span style=\"color:rgb(215,215,135)\">couldn</span><span style=\"color:rgb(215,215,135)\">'</span><span style=\"color:rgb(215,215,135)\">t apply typeof to args: </span><span style=\"color:rgb(215,215,135)\">{</span><span class=\"ansi-bright-white-fg\">args</span><span style=\"color:rgb(215,215,135)\">}</span><span style=\"color:rgb(215,215,135)\">\"</span><span class=\"ansi-bright-white-fg\">)</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/jax/_src/core.py:1189</span>, in <span class=\"ansi-cyan-fg\">EvalTrace.process_primitive</span><span class=\"ansi-bright-blue-fg\">(self, primitive, args, params)</span>\n<span class=\"ansi-bright-green-fg\">   1187</span> <span class=\"ansi-bright-white-fg\">args</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">map</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">full_lower</span><span class=\"ansi-bright-white-fg\">,</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">args</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">   1188</span> <span class=\"ansi-bright-white-fg\">check_eval_args</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">args</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">-&gt; </span><span class=\"ansi-bright-green-fg\">1189</span> <span style=\"color:rgb(95,215,255)\">return</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">primitive</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">impl</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">*</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">args</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\"> </span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">*</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">*</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">params</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/jax/_src/dispatch.py:94</span>, in <span class=\"ansi-cyan-fg\">apply_primitive</span><span class=\"ansi-bright-blue-fg\">(prim, *args, **params)</span>\n<span class=\"ansi-bright-green-fg\">     92</span> <span class=\"ansi-bright-white-fg\">prev</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">config</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">disable_jit</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">swap_local</span><span class=\"ansi-bright-white-fg\">(</span><span style=\"color:rgb(95,215,255)\">False</span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">     93</span> <span style=\"color:rgb(95,215,255)\">try</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">---&gt; </span><span class=\"ansi-bright-green-fg\">94</span> <span class=\"ansi-bright-white-fg\">  </span><span class=\"ansi-bright-white-fg\">outs</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">fun</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">*</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">args</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">     95</span> <span style=\"color:rgb(95,215,255)\">finally</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">     96</span> <span class=\"ansi-bright-white-fg\">  </span><span class=\"ansi-bright-white-fg\">config</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">disable_jit</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">set_local</span><span class=\"ansi-bright-white-fg\">(</span><span class=\"ansi-bright-white-fg\">prev</span><span class=\"ansi-bright-white-fg\">)</span>\n\n    <span class=\"ansi-bright-red-fg\">[... skipping hidden 11 frame]</span>\n\n<span class=\"ansi-bright-cyan-fg\">File </span><span class=\"ansi-green-fg\">~/parvus/prog/mint/ai/jxai/.venv/lib/python3.13/site-packages/jax/_src/compiler.py:375</span>, in <span class=\"ansi-cyan-fg\">backend_compile_and_load</span><span class=\"ansi-bright-blue-fg\">(backend, module, executable_devices, options, host_callbacks)</span>\n<span class=\"ansi-bright-green-fg\">    366</span> <span class=\"ansi-bright-white-fg\">      </span><span style=\"color:rgb(95,215,255)\">return</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">backend</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">compile_and_load</span><span class=\"ansi-bright-white-fg\">(</span>\n<span class=\"ansi-bright-green-fg\">    367</span> <span class=\"ansi-bright-white-fg\">          </span><span class=\"ansi-bright-white-fg\">built_c</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">    368</span> <span class=\"ansi-bright-white-fg\">          </span><span class=\"ansi-bright-white-fg\">executable_devices</span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\">executable_devices</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">    369</span> <span class=\"ansi-bright-white-fg\">          </span><span class=\"ansi-bright-white-fg\">compile_options</span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\">options</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">    370</span> <span class=\"ansi-bright-white-fg\">          </span><span class=\"ansi-bright-white-fg\">host_callbacks</span><span style=\"color:rgb(255,95,135)\">=</span><span class=\"ansi-bright-white-fg\">host_callbacks</span><span class=\"ansi-bright-white-fg\">,</span>\n<span class=\"ansi-bright-green-fg\">    371</span> <span class=\"ansi-bright-white-fg\">      </span><span class=\"ansi-bright-white-fg\">)</span>\n<span class=\"ansi-bright-green-fg\">    372</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(138,138,138)\"># Some backends don't have `host_callbacks` option yet</span>\n<span class=\"ansi-bright-green-fg\">    373</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(138,138,138)\"># TODO(sharadmv): remove this fallback when all backends allow `compile`</span>\n<span class=\"ansi-bright-green-fg\">    374</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(138,138,138)\"># to take in `host_callbacks`</span>\n<span class=\"ansi-bright-green-fg\">--&gt; </span><span class=\"ansi-bright-green-fg\">375</span> <span class=\"ansi-bright-white-fg\">    </span><span style=\"color:rgb(95,215,255)\">return</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">backend</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">compile_and_load</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">(</span>\n<span class=\"ansi-bright-green-fg\">    376</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">        </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">built_c</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    377</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">        </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">executable_devices</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">executable_devices</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    378</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">        </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">compile_options</span><span style=\"color:rgb(255,95,135)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">options</span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">,</span>\n<span class=\"ansi-bright-green-fg\">    379</span> <span class=\"ansi-bright-white-fg ansi-yellow-bg\">    </span><span class=\"ansi-bright-white-fg ansi-yellow-bg\">)</span>\n<span class=\"ansi-bright-green-fg\">    380</span> <span style=\"color:rgb(95,215,255)\">except</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">_jax</span><span style=\"color:rgb(255,95,135)\">.</span><span class=\"ansi-bright-white-fg\">JaxRuntimeError</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(95,215,255)\">as</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">e</span><span class=\"ansi-bright-white-fg\">:</span>\n<span class=\"ansi-bright-green-fg\">    381</span> <span class=\"ansi-bright-white-fg\">  </span><span style=\"color:rgb(95,215,255)\">for</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">error_handler</span><span class=\"ansi-bright-white-fg\"> </span><span style=\"color:rgb(255,95,135)\">in</span><span class=\"ansi-bright-white-fg\"> </span><span class=\"ansi-bright-white-fg\">_XLA_RUNTIME_ERROR_HANDLERS</span><span class=\"ansi-bright-white-fg\">:</span>\n\n<span class=\"ansi-bright-red-fg\">JaxRuntimeError</span>: INTERNAL: Failed to getBlas support.</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#606d42d7 .cell execution_count=8}\n``` {.python .cell-code}\ndef normalize(img):\n    # We use the normalization parameters matching\n    # the pretrained ViT from HF Transformers:\n    # ViTImageProcessor.from_pretrained('google/vit-base-patch16-224')\n    mean = np.array([0.5, 0.5, 0.5], dtype=np.float32)\n    std = np.array([0.5, 0.5, 0.5], dtype=np.float32)\n    image = image.astype(np.float32) / 255.0\n    return (image - mean) / std\n```\n:::\n\n\n<!-- ```{python} -->\n<!-- import jax -->\n<!-- import jax.numpy as jnp -->\n<!-- from flax import nnx -->\n<!-- from flax.nnx import bridge -->\n<!-- from transformers import FlaxViTForImageClassification -->\n\n<!-- class NABirdsViT(nnx.Module): -->\n<!--     def __init__(self, num_classes, *, rngs: nnx.Rngs): -->\n<!--         # 1. Load the pre-trained Linen model structure & weights from Hugging Face -->\n<!--         hf_model = FlaxViTForImageClassification.from_pretrained( -->\n<!--             \"google/vit-base-patch16-224\", -->\n<!--             num_labels=num_classes, -->\n<!--             ignore_mismatched_sizes=True # Necessary to overwrite the 1000-class head -->\n<!--         ) -->\n\n<!--         # 2. Bridge the Linen module to NNX -->\n<!--         # 'hf_model.module' is the underlying Linen module -->\n<!--         # 'hf_model.params' contains the pre-trained weights -->\n<!--         self.backbone = bridge.ToNNX(hf_model.module, rngs=rngs) -->\n\n<!--         # 3. Initialize and Load Weights -->\n<!--         # ToNNX requires a lazy initialization to structure the variables -->\n<!--         dummy_input = jnp.zeros((1, 3, 224, 224)) # ResNet expects NCHW by default in HF -->\n<!--         self.backbone.lazy_init(dummy_input) -->\n\n<!--         # Extract the empty NNX state -->\n<!--         _, backbone_state = nnx.split(self.backbone) -->\n\n<!--         # Copy weights from the loaded HF model into the NNX state -->\n<!--         # We define a helper to recursively copy the dictionary structure -->\n<!--         def copy_weights(target_state, source_dict): -->\n<!--             for key, value in source_dict.items(): -->\n<!--                 if isinstance(value, dict) or hasattr(value, 'items'): -->\n<!--                     copy_weights(target_state[key], value) -->\n<!--                 else: -->\n<!--                     # Assign the weight to the NNX Variable -->\n<!--                     target_state[key].value = value -->\n\n<!--         # HF stores weights in .params and batch stats in .batch_stats (if applicable) -->\n<!--         # We merge them to match the structure expected by the bridge -->\n<!--         full_linen_vars = {**hf_model.params} -->\n<!--         if hasattr(hf_model, 'batch_stats'): -->\n<!--             full_linen_vars['batch_stats'] = hf_model.batch_stats -->\n\n<!--         copy_weights(backbone_state, full_linen_vars) -->\n\n<!--         # Update the bridge with the loaded weights -->\n<!--         nnx.update(self.backbone, backbone_state) -->\n\n<!--     def __call__(self, x): -->\n<!--         # HF ResNet expects NCHW format (channels first) -->\n<!--         # If your data is NHWC (standard for JAX), transpose it: -->\n<!--         # x = jnp.transpose(x, (0, 3, 1, 2)) -->\n\n<!--         # Run the bridged model -->\n<!--         logits = self.backbone(x).logits -->\n<!--         return logits -->\n<!-- ``` -->\n\n<!-- Initialize the model: -->\n\n<!-- ```{python} -->\n<!-- rngs = nnx.Rngs(params=0, dropout=1) -->\n<!-- model = NABirdsViT(num_classes=405, rngs=rngs) -->\n<!-- ``` -->\n\n<!-- Test forward pass: -->\n\n<!-- ```{python} -->\n<!-- dummy_img = jax.random.normal(jax.random.key(0), (1, 3, 224, 224)) -->\n<!-- logits = model(dummy_img) -->\n<!-- print(f\"Output shape: {logits.shape}\") # (1, 555) -->\n<!-- ``` -->\n\n<!-- Forward pass: -->\n\n<!-- ```{python} -->\n<!-- x = jax.random.normal(jax.random.key(0), (1, 224, 224, 3)) -->\n<!-- logits = model(x) -->\n\n<!-- print(f\"Logits shape: {logits.shape}\") # (1, 555) -->\n<!-- print(\"Model initialized and pre-trained weights loaded via NNX bridge.\") -->\n<!-- ``` -->\n\n",
    "supporting": [
      "jxai_model_files"
    ],
    "filters": [],
    "includes": {}
  }
}
{
  "hash": "af02e6a07b5e96fd6f8dae91fd5d4319",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: Data loader\nauthor: Marie-Hélène Burle\n---\n\n:::{.def}\n\n\n\n:::\n\n:::{.callout-note collapse=\"true\"}\n\n## Minimal necessary code from previous sections\n\n```{.python}\nbase_dir = \"<path-of-the-nabirds-dir>\"\n```\n\n:::{.note}\n\nTo be replaced by proper path.\n\n:::\n\n\n\n::: {#6dccc4c5 .cell execution_count=2}\n``` {.python .cell-code}\nimport os\nimport polars as pl\nimport imageio.v3 as iio\nfrom skimage.transform import resize\nimport numpy as np\nimport matplotlib.pyplot as plt\nimport matplotlib.patches as patches\nimport grain.python as grain\nimport jax.numpy as jnp\n\nimg_dir = os.path.join(base_dir, \"images\")\n\nbb_file = os.path.join(base_dir, \"bounding_boxes.txt\")\nclasses_translation_file = os.path.join(base_dir, \"classes_fixed.txt\")\nclass_labels_file = os.path.join(base_dir, \"image_class_labels.txt\")\nimg_file = os.path.join(base_dir, \"images.txt\")\nphotographers_file = os.path.join(base_dir, \"photographers_fixed.txt\")\nsizes_file = os.path.join(base_dir, \"sizes.txt\")\ntrain_test_split_file = os.path.join(base_dir, \"train_test_split.txt\")\n\nbb = pl.read_csv(\n    bb_file,\n    separator=\" \",\n    has_header=False,\n    new_columns=[\"UUID\", \"bb_x\", \"bb_y\", \"bb_width\", \"bb_height\"]\n)\n\nclasses = pl.read_csv(\n    class_labels_file,\n    separator=\" \",\n    has_header=False,\n    new_columns=[\"UUID\", \"class\"]\n)\n\nclasses_translation = pl.read_csv(\n    classes_translation_file,\n    separator=\" \",\n    has_header=False,\n    new_columns=[\"class\", \"id\"]\n)\n\nimg_paths = pl.read_csv(\n    img_file,\n    separator=\" \",\n    has_header=False,\n    new_columns=[\"UUID\", \"path\"]\n)\n\nphotographers = pl.read_csv(\n    photographers_file,\n    separator=\" \",\n    has_header=False,\n    new_columns=[\"UUID\", \"photographer\"]\n)\n\nsizes = pl.read_csv(\n    sizes_file,\n    separator=\" \",\n    has_header=False,\n    new_columns=[\"UUID\", \"img_width\", \"img_height\"]\n)\n\ntrain_test_split = pl.read_csv(\n    train_test_split_file,\n    separator=\" \",\n    has_header=False,\n    new_columns=[\"UUID\", \"is_training_img\"]\n)\n\nclasses_metadata = (\n    classes.join(classes_translation, on=\"class\")\n)\n\nmetadata = (\n    bb.join(classes_metadata, on=\"UUID\")\n    .join(img_paths, on=\"UUID\")\n    .join(photographers, on=\"UUID\")\n    .join(sizes, on=\"UUID\")\n    .join(train_test_split, on=\"UUID\")\n)\n\nmetadata_train = metadata.filter(pl.col(\"is_training_img\") == 1)\n\nclass NABirdsDataset:\n    \"\"\"NABirds dataset class.\"\"\"\n    def __init__(self, metadata_file, data_dir):\n        self.metadata = metadata_file\n        self.data_dir = data_dir\n    def __len__(self):\n        return len(self.metadata)\n    def __getitem__(self, idx):\n        img_path = os.path.join(\n            self.data_dir,\n            self.metadata.get_column('path')[idx]\n        )\n        img = iio.imread(img_path)\n        img_id = self.metadata.get_column('id')[idx].replace('_', ' ')\n        img_photographer = self.metadata.get_column('photographer')[idx].replace('_', ' ')\n        img_bb_x = self.metadata.get_column('bb_x')[idx]\n        img_bb_y = self.metadata.get_column('bb_y')[idx]\n        img_bb_width = self.metadata.get_column('bb_width')[idx]\n        img_bb_height = self.metadata.get_column('bb_height')[idx]\n        element = {\n            'image': img,\n            'id': img_id,\n            'photographer': img_photographer,\n            'bbx' : img_bb_x,\n            'bby' : img_bb_y,\n            'bbwidth' : img_bb_width,\n            'bbheight' : img_bb_height\n        }\n        return element\n\nnabirds_train = NABirdsDataset(\n    metadata_train,\n    img_dir\n)\n\nclass NormAndCast(grain.MapTransform):\n    \"\"\"Transform class to normalize and cast images to float32.\"\"\"\n    def map(self, element):\n        element['image'] = jnp.array(element['image'], dtype=jnp.float32) / 255.0\n        return element\n\nclass BbCrop(grain.MapTransform):\n    \"\"\"Transform class to crop images to their bounding boxes.\"\"\"\n    def map(self, element):\n        img = element['image']\n        bbx = element['bbx']\n        bby = element['bby']\n        bbwidth = element['bbwidth']\n        bbheight = element['bbheight']\n        img_cropped = img[bby:bby+bbheight, bbx:bbx+bbwidth]\n        element['image'] = img_cropped\n        return element\n\ntarget = (224, 224)\n\nclass PaddingResize(grain.MapTransform):\n    \"\"\"Transform class to resize images to a given size with padding to avoid distortion.\"\"\"\n    def map(self, element):\n        img = element['image']\n        h, w, _ = img.shape\n        target_h, target_w = target\n\n        # Calculate the scaling factor to fit the image inside the box\n        scale = min(target_h / h, target_w / w)\n\n        # Calculate the new dimensions of the image\n        new_h = int(h * scale)\n        new_w = int(w * scale)\n\n        # Resize the image to these new dimensions\n        img_resized = resize(img, (new_h, new_w), anti_aliasing=True)\n\n        # Create a black canvas (zeros) of the target size\n        out_img = np.zeros((target_h, target_w, img.shape[2]), dtype=img_resized.dtype)\n\n        # Place the resized image in the center of the canvas\n        y_offset = (target_h - new_h) // 2\n        x_offset = (target_w - new_w) // 2\n        out_img[y_offset:y_offset+new_h, x_offset:x_offset+new_w] = img_resized\n\n        element['image'] = out_img\n        return element\n\ntransformations = [NormAndCast(), BbCrop(), PaddingResize()]\n```\n:::\n\n\n:::\n\n## Goal of a data loader\n\nWe can access elements of our Dataclass (as we did before to display some images) with:\n\n::: {#6c813649 .cell execution_count=3}\n``` {.python .cell-code}\nfor i, element in enumerate(nabirds_train):\n    print(element['image'].shape)\n    if i == 3:\n        break\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n(680, 1024, 3)\n(819, 1024, 3)\n(768, 1024, 3)\n(817, 1024, 3)\n```\n:::\n:::\n\n\n## Grain DataLoaders\n\n\n- Source:\n- Transforms:\n- Sampler:\n\n## Sequential sampler\n\n::: {#96e5005f .cell execution_count=4}\n``` {.python .cell-code}\nnabirds_train_seqsampler = grain.SequentialSampler(\n    num_records=4,\n    shard_options=grain.NoSharding()\n)\n```\n:::\n\n\n::: {#15a72592 .cell execution_count=5}\n``` {.python .cell-code}\nfor record_metadata in nabirds_train_seqsampler:\n    print(record_metadata)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRecordMetadata(index=0, record_key=0, rng=None)\nRecordMetadata(index=1, record_key=1, rng=None)\nRecordMetadata(index=2, record_key=2, rng=None)\nRecordMetadata(index=3, record_key=3, rng=None)\n```\n:::\n:::\n\n\n## First DataLoader\n\nWe now have our source, transformations, and sampler, so we can build our first DataLoader:\n\n::: {#66182cf8 .cell execution_count=6}\n``` {.python .cell-code}\nnabirds_train_dl = grain.DataLoader(\n    data_source=nabirds_train,\n    operations=transformations,\n    sampler=nabirds_train_seqsampler,\n    worker_count=0\n)\n```\n:::\n\n\n::: {#54abc8d3 .cell execution_count=7}\n``` {.python .cell-code}\nfig = plt.figure(figsize=(8, 8))\n\nfor i, element in enumerate(nabirds_train_dl):\n    ax = plt.subplot(2, 2, i + 1)\n    plt.tight_layout()\n    ax.set_title(\n        f'Element {i}\\nIdentification: {element['id']}\\nPicture by {element['photographer']}',\n        fontsize=9\n    )\n    ax.axis('off')\n    plt.imshow(element['image'])\n\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![](jxai_dataloader_files/figure-html/cell-8-output-1.png){width=745 height=733}\n:::\n:::\n\n\n:::{.note}\n\nNotice that, unlike [last time we displayed some images](jxai_dataset.html#display-an-element), we aren't looping through our Dataset (`nabirds_train`) anymore, but through our DataLoader (`nabirds_train_dl`).\n\nBecause we set the number of records to 4 in the sampler, we don't have to break the loop.\n\n:::\n\n## Index sampler\n\n::: {#c808a777 .cell execution_count=8}\n``` {.python .cell-code}\nnabirds_train_isampler = grain.IndexSampler(\n  num_records=200,\n  num_epochs=1,\n  # shard_options=grain.sharding.ShardOptions(shard_index=0, shard_count=1, drop_remainder=True),\n  shard_options=grain.ShardOptions(shard_index=0, shard_count=1, drop_remainder=True),\n  shuffle=True,\n  seed=0)\n```\n:::\n\n\n::: {#f28c0803 .cell execution_count=9}\n``` {.python .cell-code}\nfor record_metadata in nabirds_train_isampler:\n  print(record_metadata)\n  if i == 3:\n      plt.show()\n      break\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRecordMetadata(index=0, record_key=134, rng=Generator(Philox))\n```\n:::\n:::\n\n\n::: {#54b35fec .cell execution_count=10}\n``` {.python .cell-code}\nnabirds_train_dl = grain.DataLoader(\n    data_source=nabirds_train,\n    operations=transformations,\n    sampler=nabirds_train_isampler,\n    worker_count=0\n)\n```\n:::\n\n\n::: {#63a65370 .cell execution_count=11}\n``` {.python .cell-code}\nfig = plt.figure(figsize=(8, 8))\n\nfor i, element in enumerate(nabirds_train_dl):\n    ax = plt.subplot(2, 2, i + 1)\n    plt.tight_layout()\n    ax.set_title(\n        f'Element {i}\\nIdentification: {element['id']}\\nPicture by {element['photographer']}',\n        fontsize=9\n    )\n    ax.axis('off')\n    plt.imshow(element['image'])\n    if i == 3:\n        plt.show()\n        break\n```\n\n::: {.cell-output .cell-output-display}\n![](jxai_dataloader_files/figure-html/cell-12-output-1.png){width=705 height=733}\n:::\n:::\n\n\n",
    "supporting": [
      "jxai_dataloader_files"
    ],
    "filters": [],
    "includes": {}
  }
}
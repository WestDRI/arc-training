{
  "hash": "31f4234c10555aec831fa6f829c46719",
  "result": {
    "markdown": "---\ntitle: Plotting\nauthor: Marie-Hélène Burle\n---\n\n\n:::{.def}\n\nThis section focuses on plotting in R with the package [ggplot2](https://cran.r-project.org/web/packages/ggplot2/index.html) from [the tidyverse](https://www.tidyverse.org/).\n\n:::\n\n## The data\n\nR comes with a number of datasets. You can get a list by running `data()`. The `ggplot2` package provides [additional ones](https://ggplot2.tidyverse.org/reference/#data). We will use the `mpg` dataset from `ggplot2`.\n\nTo access the data, let's load the package:\n\n\n::: {.cell hash='plotting_cache/html/unnamed-chunk-1_06c22ac36c9249ebcfbd99f68cdb6286'}\n\n```{.r .cell-code}\nlibrary(ggplot2)\n```\n:::\n\n\nHere is what that dataset looks like:\n\n\n::: {.cell hash='plotting_cache/html/unnamed-chunk-2_3a9d2e8300fbe18a81c1e4b0f5618b3b'}\n\n```{.r .cell-code}\nmpg\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 234 × 11\n   manufacturer model      displ  year   cyl trans      drv     cty   hwy fl   \n   <chr>        <chr>      <dbl> <int> <int> <chr>      <chr> <int> <int> <chr>\n 1 audi         a4           1.8  1999     4 auto(l5)   f        18    29 p    \n 2 audi         a4           1.8  1999     4 manual(m5) f        21    29 p    \n 3 audi         a4           2    2008     4 manual(m6) f        20    31 p    \n 4 audi         a4           2    2008     4 auto(av)   f        21    30 p    \n 5 audi         a4           2.8  1999     6 auto(l5)   f        16    26 p    \n 6 audi         a4           2.8  1999     6 manual(m5) f        18    26 p    \n 7 audi         a4           3.1  2008     6 auto(av)   f        18    27 p    \n 8 audi         a4 quattro   1.8  1999     4 manual(m5) 4        18    26 p    \n 9 audi         a4 quattro   1.8  1999     4 auto(l5)   4        16    25 p    \n10 audi         a4 quattro   2    2008     4 manual(m6) 4        20    28 p    \n   class  \n   <chr>  \n 1 compact\n 2 compact\n 3 compact\n 4 compact\n 5 compact\n 6 compact\n 7 compact\n 8 compact\n 9 compact\n10 compact\n# ℹ 224 more rows\n```\n:::\n:::\n\n\n`?mpg` will give you information on the variables. In particular:\n\n- `displ` contains data on [engine displacement](https://en.wikipedia.org/wiki/Engine_displacement) (a measure of engine size and thus power) in litres (L).\n- `hwy` contains data on [fuel economy](https://en.wikipedia.org/wiki/Fuel_economy_in_automobiles) while driving on highways in miles per gallon (mpg).\n- `drv` represents the type of drive train (front-wheel drive, rear wheel drive, 4WD).\n- `class` represents the type of car.\n\nWe are interested in the relationship between engine size and fuel economy and see how the type of drive train and/or the type of car might affect this relationship.\n\n## Base R plotting\n\nR contains built-in plotting capability thanks to the `plot()` function.\n\nA basic version of our plot would be:\n\n\n::: {.cell hash='plotting_cache/html/unnamed-chunk-3_7f4c60b5eabed32126b300b93f683a45'}\n\n```{.r .cell-code}\nplot(\n  mpg$displ,\n  mpg$hwy,\n  main = \"Fuel consumption per engine size on highways\",\n  xlab = \"Engine size (L)\",\n  ylab = \"Fuel economy (mpg) on highways\"\n)\n```\n\n::: {.cell-output-display}\n![](plotting_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n## Grammar of graphics\n\n[Leland Wilkinson](https://en.wikipedia.org/wiki/Leland_Wilkinson) developed the concept of grammar of graphics in his 2005 book [The Grammar of Graphics](https://link.springer.com/book/10.1007/0-387-28695-0). By breaking down statistical graphs into components following a set of rules, any plot can be described and constructed in a rigorous fashion.\n\nThis was further refined by Hadley Wickham in his 2010 article [A Layered Grammar of Graphics](https://www.tandfonline.com/doi/abs/10.1198/jcgs.2009.07098) and implemented in the package [`ggplot2`](https://cran.r-project.org/web/packages/ggplot2/index.html) (that's what the 2 \"g\" stand for in \"ggplot\").\n\n`ggplot2` has become the dominant graphing package in R. Let's see how to construct a plot with this package.\n\n## Plotting with `ggplot2`\n\n:::{.note}\n\nYou can find the `ggplot2` cheatsheet [here](https://posit.co/wp-content/uploads/2022/10/data-visualization-1.pdf).\n\n:::\n\n### The Canvas\n\nThe first component is the data:\n\n\n::: {.cell hash='plotting_cache/html/unnamed-chunk-4_e267c1664d6d338d6140af846a7780fd'}\n\n```{.r .cell-code}\nggplot(data = mpg)\n```\n\n::: {.cell-output-display}\n![](plotting_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n:::{.note}\n\nThis can be simplified into `ggplot(mpg)`.\n\n:::\n\nThe second component sets the way variables are mapped on the axes. This is done with the `aes()` (aesthetics) function:\n\n\n::: {.cell hash='plotting_cache/html/unnamed-chunk-5_985b94549fdd894f609fb9554c3f2604'}\n\n```{.r .cell-code}\nggplot(data = mpg, mapping = aes(x = displ, y = hwy))\n```\n\n::: {.cell-output-display}\n![](plotting_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n:::{.note}\n\nThis can be simplified into `ggplot(mpg, aes(x = displ, y = hwy))`.\n\n:::\n\n### Geometric representations of the data\n\nOnto this canvas, we can add \"geoms\" (geometrical objects) representing the data. The type of \"geom\" defines the type of representation (e.g. boxplot, histogram, bar chart).\n\nTo represent the data as a scatterplot, we use the `geom_point()` function:\n\n\n::: {.cell hash='plotting_cache/html/unnamed-chunk-6_8e58edafcd49ad40b73db693e29e498d'}\n\n```{.r .cell-code}\nggplot(mpg, aes(x = displ, y = hwy)) +\n  geom_point()\n```\n\n::: {.cell-output-display}\n![](plotting_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\nWe can colour-code the points in the scatterplot based on the `drv` variable, showing the lower fuel efficiency of 4WD vehicles:\n\n\n::: {.cell hash='plotting_cache/html/unnamed-chunk-7_dc26e8ab2a81df8593fad82da38cde29'}\n\n```{.r .cell-code}\nggplot(mpg, aes(x = displ, y = hwy)) +\n  geom_point(aes(color = drv))\n```\n\n::: {.cell-output-display}\n![](plotting_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\nOr we can colour-code them based on the `class` variable:\n\n\n::: {.cell hash='plotting_cache/html/unnamed-chunk-8_4c48de2bd5b61f483ea2d3437aa937c5'}\n\n```{.r .cell-code}\nggplot(mpg, aes(x = displ, y = hwy)) +\n  geom_point(aes(color = class))\n```\n\n::: {.cell-output-display}\n![](plotting_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\nMultiple \"geoms\" can be added on top of each other. For instance, we can add a smoothed conditional means function that aids at seeing patterns in the data with `geom_smooth()`:\n\n\n::: {.cell hash='plotting_cache/html/unnamed-chunk-9_2eba7516b5ddc95a9e43945d23e8078c'}\n\n```{.r .cell-code}\nggplot(mpg, aes(x = displ, y = hwy)) +\n  geom_point(aes(color = class)) +\n  geom_smooth()\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using method = 'loess' and formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](plotting_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\nThanks to the colour-coding of the types of car, we can see that the cluster of points in the top right corner all belong to the same type: 2 seaters. Those are outliers with high power, yet high few efficiency due to their smaller size.\n\nThe default smoothing function uses the LOESS (locally estimated scatterplot smoothing) method, which is a nonlinear regression. But maybe a linear model would actually show the general trend better. We can change the method by passing it as an argument to `geom_smooth()`:\n\n\n::: {.cell hash='plotting_cache/html/unnamed-chunk-10_a9f4a8fe9386c2d6337126f91f4f989c'}\n\n```{.r .cell-code}\nggplot(mpg, aes(x = displ, y = hwy)) +\n  geom_point(aes(color = class)) +\n  geom_smooth(method = lm)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](plotting_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\nOf course, we could apply the smoothing function to each class instead of the entire data. It creates a busy plot but shows that the downward trend remains true within each type of car:\n\n\n::: {.cell hash='plotting_cache/html/unnamed-chunk-11_e0cfadf8f75219aed8f8457ef06af614'}\n\n```{.r .cell-code}\nggplot(mpg, aes(x = displ, y = hwy, color = class)) +\n  geom_point(aes(color = class)) +\n  geom_smooth(method = lm)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](plotting_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\nOther arguments to `geom_smooth()` can set the line width, color, or whether or not the standard error (`se`) is shown:\n\n\n::: {.cell hash='plotting_cache/html/unnamed-chunk-12_2cf227db995c8f065b173877f41490e0'}\n\n```{.r .cell-code}\nggplot(mpg, aes(x = displ, y = hwy)) +\n  geom_point(aes(color = class)) +\n  geom_smooth(\n    method = lm,\n    se = FALSE,\n    color = \"#999999\",\n    linewidth = 0.5\n  )\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](plotting_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n### Colour scales\n\nIf we want to change the colour scale, we add another layer for this:\n\n\n::: {.cell hash='plotting_cache/html/unnamed-chunk-13_5174e4a01b78901786e3c283a4e91942'}\n\n```{.r .cell-code}\nggplot(mpg, aes(x = displ, y = hwy)) +\n  geom_point(aes(color = class)) +\n  scale_color_brewer(palette = \"Dark2\") +\n  geom_smooth(\n    method = lm,\n    se = FALSE,\n    color = \"#999999\",\n    linewidth = 0.5\n  )\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](plotting_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n`scale_color_brewer()`, based on [color brewer 2.0](https://colorbrewer2.org/#type=sequential&scheme=BuGn&n=3), is one of many methods to change the color scale. Here is the list of available scales for this particular method:\n\n![](img/color_scale.png){width=\"90%\"}\n\n### Labels\n\nWe can keep on adding layers. For instance, the `labs()` function allows to set title, subtitle, captions, tags, axes labels, etc.\n\n\n::: {.cell hash='plotting_cache/html/unnamed-chunk-14_23803938e8c05d478f93f1da809db377'}\n\n```{.r .cell-code}\nggplot(mpg, aes(x = displ, y = hwy)) +\n  geom_point(aes(color = class)) +\n  scale_color_brewer(palette = \"Dark2\") +\n  geom_smooth(\n    method = lm,\n    se = FALSE,\n    color = \"#999999\",\n    linewidth = 0.5\n  ) +\n  labs(\n    title = \"Fuel consumption per engine size on highways\",\n    x = \"Engine size (L)\",\n    y = \"Fuel economy (mpg) on highways\",\n    color = \"Type of car\",\n    caption = \"EPA data from https://fueleconomy.gov/\"\n  )\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](plotting_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\n### Themes\n\nAnother optional layer sets one of several preset themes.\n\n[Edward Tufte](https://en.wikipedia.org/wiki/Edward_Tufte) developed, amongst others, the principle of *data-ink ratio* which emphasizes that ink should be used primarily where it communicates meaningful messages. It is indeed common to see charts where more ink is used in labels or background than in the actual representation of the data.\n\nThe default `ggplot2` theme could be criticized as not following this principle. Let's change it:\n\n\n\n::: {.cell hash='plotting_cache/html/unnamed-chunk-15_6ca8b5d0d06d7535f8dfe73fbadb3224'}\n\n```{.r .cell-code}\nggplot(mpg, aes(x = displ, y = hwy)) +\n  geom_point(aes(color = class)) +\n  scale_color_brewer(palette = \"Dark2\") +\n  geom_smooth(\n    method = lm,\n    se = FALSE,\n    color = \"#999999\",\n    linewidth = 0.5\n  ) +\n  labs(\n    title = \"Fuel consumption per engine size on highways\",\n    x = \"Engine size (L)\",\n    y = \"Fuel economy (mpg) on highways\",\n    color = \"Type of car\",\n    caption = \"EPA data from https://fueleconomy.gov/\"\n  ) +\n  theme_classic()\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](plotting_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\nThe `theme()` function allows to tweak the theme in any number of ways. For instance, what if we don't like the default position of the title and we'd rather have it centered?\n\n\n::: {.cell hash='plotting_cache/html/unnamed-chunk-16_99307e0b380cb56bbcae568ad505bba3'}\n\n```{.r .cell-code}\nggplot(mpg, aes(x = displ, y = hwy)) +\n  geom_point(aes(color = class)) +\n  scale_color_brewer(palette = \"Dark2\") +\n  geom_smooth(\n    method = lm,\n    se = FALSE,\n    color = \"#999999\",\n    linewidth = 0.5\n  ) +\n  labs(\n    title = \"Fuel consumption per engine size on highways\",\n    x = \"Engine size (L)\",\n    y = \"Fuel economy (mpg) on highways\",\n    color = \"Type of car\",\n    caption = \"EPA data from https://fueleconomy.gov/\"\n  ) +\n  theme_classic() +\n  theme(plot.title = element_text(hjust = 0.5))\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](plotting_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\nMany things can be changed thanks to the `theme()` function. For instance, we can move the legend to give more space to the actual graph:\n\n\n::: {.cell hash='plotting_cache/html/unnamed-chunk-17_5f88bf784c320002c3477a61369cb464'}\n\n```{.r .cell-code}\nggplot(mpg, aes(x = displ, y = hwy)) +\n  geom_point(aes(color = class)) +\n  scale_color_brewer(palette = \"Dark2\") +\n  geom_smooth(\n    method = lm,\n    se = FALSE,\n    color = \"#999999\",\n    linewidth = 0.5\n  ) +\n  labs(\n    title = \"Fuel consumption per engine size on highways\",\n    x = \"Engine size (L)\",\n    y = \"Fuel economy (mpg) on highways\",\n    color = \"Type of car\",\n    caption = \"EPA data from https://fueleconomy.gov/\"\n  ) +\n  theme_classic() +\n  theme(plot.title = element_text(hjust = 0.5), legend.position = \"bottom\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](plotting_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n\nAs you could see, `ggplot2` works by adding a number of layers on top of each other, all following a standard set of rules, or \"grammar\". This way, a vast array of graphs can be created by organizing simple components.\n\n## `ggplot2` extensions\n\nThanks to its vast popularity, `ggplot2` has seen a proliferation of packages extending its capabilities.\n\n### Combining plots\n\nFor instance the [`patchwork`](https://patchwork.data-imaginist.com/) package allows to easily combine multiple plots on the same frame.\n\nLet's add a second plot next to our plot. To add plots side by side, we simply add them to each other. We also make a few changes to the labels to improve the plots integration:\n\n\n::: {.cell hash='plotting_cache/html/unnamed-chunk-18_574818682d34fac5b465bb86d4235844'}\n\n```{.r .cell-code}\nlibrary(patchwork)\n\nggplot(mpg, aes(x = displ, y = hwy)) +        # First plot\n  geom_point(aes(color = class)) +\n  scale_color_brewer(palette = \"Dark2\") +\n  geom_smooth(\n    method = lm,\n    se = FALSE,\n    color = \"#999999\",\n    linewidth = 0.5\n  ) +\n  labs(\n    x = \"Engine size (L)\",\n    y = \"Fuel economy (mpg) on highways\",\n    color = \"Type of car\"\n  ) +\n  theme_classic() +\n  theme(\n    plot.title = element_text(hjust = 0.5),\n    legend.position = c(0.7, 0.75),           # Better legend position\n    legend.background = element_rect(         # Add a frame to the legend\n      linewidth=0.1,\n      linetype=\"solid\",\n      colour = \"black\"\n    )\n  ) +\n  ggplot(mpg, aes(x = displ, y = hwy)) +      # Second plot\n  geom_point(aes(color = drv)) +\n  scale_color_brewer(palette = \"Dark2\") +\n  labs(\n    x = \"Engine size (L)\",\n    y = element_blank(),                      # Remove redundant label\n    color = \"Type of drive train\",\n    caption = \"EPA data from https://fueleconomy.gov/\"\n  ) +\n  theme_classic() +\n  theme(\n    plot.title = element_text(hjust = 0.5),\n    legend.position = c(0.7, 0.87),\n    legend.background = element_rect(\n      linewidth=0.1,\n      linetype=\"solid\",\n      colour = \"black\"\n    )\n  )\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](plotting_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n### Extensions list\n\nAnother popular extension is the [`gganimate`](https://gganimate.com/) package which allows to create data animations.\n\nA full list of extensions for `ggplot2` is shown below ([here](https://exts.ggplot2.tidyverse.org/gallery/) is the website):\n\n\n```{=html}\n<iframe width=\"780\" height=\"1000\" src=\"https://exts.ggplot2.tidyverse.org/gallery/\"></iframe>\n```\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
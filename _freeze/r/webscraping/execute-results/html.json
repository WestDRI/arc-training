{
  "hash": "19f111712e285165dbba16f8f8f8b1b5",
  "result": {
    "markdown": "---\ntitle: Web scraping with R\nauthor: Marie-Hélène Burle\nexecute:\n  cache: false\n---\n\n\n:::{.def}\n\nThe internet is a trove of information. A lot of it is publicly available and thus suitable for use in research. Extracting that information and putting it in an organized format for analysis can, however, be extremely tedious. Web scraping tools allow to automate parts of that process and R is a popular language for the task.\n\nIn this workshop, we will guide you through a simple example using the package [rvest](https://rvest.tidyverse.org/).\n\n:::\n\n:::{.callout-accordion collapse=\"true\"}\n\n## ***Running R***\n\nFor this workshop, we will use our temporary RStudio server. To access it:\n\n1.  Go to the website given during the workshop,\n2.  Sign in using your username and password given during the workshop (you can ignore the OTP entry),\n3.  Choose the following `Server Options`:\n\n    - Time: `1.5` hours\n    - Number of cores: `1`\n    - Memory: `3600` MB\n    - User interface: `JupyterLab`\n\n<!-- ![](img/jupyter_options.png){fig-alt=\"noshadow\"} -->\n\n4.  In JupyterLab, click on the RStudio button (big blue symbol with a white R in it).\n\n:::{.note}\n\nOur RStudio server already has the two packages that we will be using installed ([rvest](https://cran.r-project.org/web/packages/rvest/index.html) and [tibble](https://cran.r-project.org/web/packages/tibble/index.html)). If you want to run the code on your machine, you need to install them with `install.packages()` first.\n\n:::\n\n:::\n\n## HTML and CSS\n\n\n\n## Web scrapping\n\n\n\n## Example\n\n### Goal\n\nWe will use [a website](https://trace.tennessee.edu/utk_graddiss/index.html) from the [University of Tennessee](https://www.utk.edu/) containing a database of PhD theses from that university.\n\nOur goal is to scrape data from this site to produce a dataframe with the date, major, and principal investigator (PI) for each dissertation.\n\n:::{.note}\n\nWe will only do this for the first page which contains the links for the 100 most recent theses. If you really wanted to gather all the data, you would have to do this for all pages.\n\n:::\n\n### Let's look at the sites\n\nFirst of all, let's have a close look at the websites we want to scrape to think carefully about what we want to do. Before starting to write code, it is always a good idea to think about what you are trying to achieve with your code.\n\nTo create a dataframe with the data for all the dissertations on that first page, we need to do two things:\n\n- Step 1: from the [dissertations database first page](https://trace.tennessee.edu/utk_graddiss/index.html), we want to scrape the list of URLs for the dissertation pages.\n\n- Step 2: once we have the links, we want to scrape those pages too to get the date, major, and principal investigator (PI) for each dissertation.\n\n### Package\n\nTo do all this, we will use the package [rvest](https://cran.r-project.org/web/packages/rvest/index.html), part of the [tidyverse](https://www.tidyverse.org/) (a modern set of R packages). It is a package influenced by the popular Python package [Beautiful Soup](https://en.wikipedia.org/wiki/Beautiful_Soup_(HTML_parser)) and it makes scraping websites with R really easy.\n\nLet's load it:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(rvest)\n```\n:::\n\n\n### Read in HTML data\n\nAs mentioned above, our site is the [database of PhD dissertations of the University of Tennessee](https://trace.tennessee.edu/utk_graddiss/index.html).\n\nLet's create a character vector with the url:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurl <- \"https://trace.tennessee.edu/utk_graddiss/index.html\"\n```\n:::\n\n\nFirst, we read in the html data from that page:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhtml <- read_html(url)\n```\n:::\n\n\nLet's have a look at the raw data:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhtml\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n{html_document}\n<html lang=\"en\">\n[1] <head>\\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8 ...\n[2] <body>\\n<!-- FILE /srv/sequoia/main/data/trace.tennessee.edu/assets/heade ...\n```\n:::\n:::\n\n\n### Extracting relevant data\n\n#### Method\n\nThe html code for this webpage contains the data we are interested in, but it is mixed in with a lot of HTML formatting information and data we aren't interested in. We need to extract it and turn it into a workable format.\n\nThe first step is to find the CSS elements that contain the data we want. For this, you can use a web inspector or—even easier—the [SelectorGadget](https://selectorgadget.com/), a JavaScript bookmarklet built by [Andrew Cantino](https://andrewcantino.com/).\n\nThis bookmarklet allows us to see that the elements we want (the links to the dissertation information) are under the CSS class `.article-listing`.\n\n#### Extracting a single link\n\nLet's try to extract the first link. The function `html_element()` from the package `rvest` does exactly this. Let's assign the result to an object that we will call `test`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntest <- html %>% html_element(\".article-listing\")\n```\n:::\n\n\nOur new object is a list:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntypeof(test)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"list\"\n```\n:::\n:::\n\n\nLet's print it:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntest\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n{html_node}\n<p class=\"article-listing\">\n[1] <a href=\"https://trace.tennessee.edu/utk_graddiss/7600\">The Novel Chlorin ...\n```\n:::\n:::\n\n\nThe link is in there, so we successfully extracted the correct element, but we need to do more cleaning.\n\nAs you can see from printing `test`, the link is in an `a` anchor element. Let's extract it with the function `html_element()` we already used:\n\n\n::: {.cell}\n\n```{.r .cell-code}\na_test <- test %>% html_element(\"a\")\na_test\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n{html_node}\n<a href=\"https://trace.tennessee.edu/utk_graddiss/7600\">\n```\n:::\n:::\n\n\nThis is much better, but we now need to extract the `href` attribute:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlink_test <- a_test %>% html_attr(\"href\")\nlink_test\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"https://trace.tennessee.edu/utk_graddiss/7600\"\n```\n:::\n:::\n\n\nThis is our link.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstr(link_test)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n chr \"https://trace.tennessee.edu/utk_graddiss/7600\"\n```\n:::\n:::\n\n\nIt is saved in a character vector, which is perfect.\n\n#### Getting data from our test link\n\nNow that we have the URL of the first dissertation, we want to extract the date, major, and principal investigator (PI) for that dissertation.\n\n`link_test` is a character vector representing a URL. We know how to deal with this.\n\nThe first thing to do—as we did earlier with the database site—is to read in the html data. Let's assign it to a new object that we will call `html_test`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhtml_test <- read_html(link_test)\nhtml_test\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n{html_document}\n<html lang=\"en\">\n[1] <head>\\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8 ...\n[2] <body>\\n<!-- FILE /srv/sequoia/main/data/trace.tennessee.edu/assets/heade ...\n```\n:::\n:::\n\n\nNow, we want to extract the publication date. Let's use the [SelectorGadget](https://selectorgadget.com/) again.\n\nWe need the element `#publication_date p`. Let's extract it:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndate <- html_test %>% html_element(\"#publication_date p\") %>% html_text2()\ndate\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"5-2023\"\n```\n:::\n:::\n\n\nWe also want the major for this thesis. The [SelectorGadget](https://selectorgadget.com/) allows us to find that this time, it is the `#department p` element that we need. Let's extract it:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmajor <- html_test %>% html_element(\"#department p\") %>% html_text2()\nmajor\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"Chemistry\"\n```\n:::\n:::\n\n\nAnd for the PI, we need the `#advisor1 p` element:\n\n\n::: {.cell}\n\n```{.r .cell-code}\npi <- html_test %>% html_element(\"#advisor1 p\") %>% html_text2()\npi\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"Craig E. Barnes\"\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncbind(date, major, pi)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n     date     major       pi               \n[1,] \"5-2023\" \"Chemistry\" \"Craig E. Barnes\"\n```\n:::\n:::\n\n\n:::{.exo}\n\n:::{.yourturn}\n\nYour turn:\n\n:::\n\nTry using the [SelectorGadget](https://selectorgadget.com/) to identify the element necessary to extract the abstract of this dissertation.\n\nNow, write the code to extract it.\n\n:::\n\n#### Extracting all links\n\nInstead of using `html_element()`, this time we will use `html_elements()` which extracts *all* matching elements (instead of just the first one):\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat <- html %>% html_elements(\".article-listing\")\ndat\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n{xml_nodeset (100)}\n [1] <p class=\"article-listing\"><a href=\"https://trace.tennessee.edu/utk_grad ...\n [2] <p class=\"article-listing\"><a href=\"https://trace.tennessee.edu/utk_grad ...\n [3] <p class=\"article-listing\"><a href=\"https://trace.tennessee.edu/utk_grad ...\n [4] <p class=\"article-listing\"><a href=\"https://trace.tennessee.edu/utk_grad ...\n [5] <p class=\"article-listing\"><a href=\"https://trace.tennessee.edu/utk_grad ...\n [6] <p class=\"article-listing\"><a href=\"https://trace.tennessee.edu/utk_grad ...\n [7] <p class=\"article-listing\"><a href=\"https://trace.tennessee.edu/utk_grad ...\n [8] <p class=\"article-listing\"><a href=\"https://trace.tennessee.edu/utk_grad ...\n [9] <p class=\"article-listing\"><a href=\"https://trace.tennessee.edu/utk_grad ...\n[10] <p class=\"article-listing\"><a href=\"https://trace.tennessee.edu/utk_grad ...\n[11] <p class=\"article-listing\"><a href=\"https://trace.tennessee.edu/utk_grad ...\n[12] <p class=\"article-listing\"><a href=\"https://trace.tennessee.edu/utk_grad ...\n[13] <p class=\"article-listing\"><a href=\"https://trace.tennessee.edu/utk_grad ...\n[14] <p class=\"article-listing\"><a href=\"https://trace.tennessee.edu/utk_grad ...\n[15] <p class=\"article-listing\"><a href=\"https://trace.tennessee.edu/utk_grad ...\n[16] <p class=\"article-listing\"><a href=\"https://trace.tennessee.edu/utk_grad ...\n[17] <p class=\"article-listing\"><a href=\"https://trace.tennessee.edu/utk_grad ...\n[18] <p class=\"article-listing\"><a href=\"https://trace.tennessee.edu/utk_grad ...\n[19] <p class=\"article-listing\"><a href=\"https://trace.tennessee.edu/utk_grad ...\n[20] <p class=\"article-listing\"><a href=\"https://trace.tennessee.edu/utk_grad ...\n...\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntypeof(dat)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"list\"\n```\n:::\n\n```{.r .cell-code}\nlength(dat)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 100\n```\n:::\n\n```{.r .cell-code}\ntypeof(dat[[1]])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"list\"\n```\n:::\n:::\n\n\nWe now have a list of lists.\n\nAs we did for a single link, we want to extract all the links to have a list of links.\n\nBefore running for loops, it is important to initialize empty loops. It is much more efficient than growing the result at each iteration.\n\nSo let's initialize an empty list:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlist_links <- vector(\"list\", length(dat))\n```\n:::\n\n\nLet's have a look at one element of our list (the second one for instance):\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlist_links[[2]]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nNULL\n```\n:::\n:::\n\n\nWe now have an empty list of the appropriate size. We can run our loop:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfor (i in seq_along(dat)) {\n  list_links[[i]] <- dat[[i]] %>%\n    html_element(\"a\") %>%\n    html_attr(\"href\")\n}\n```\n:::\n\n\nLet's print again the second element of our list to make sure all looks good:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlist_links[[2]]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"https://trace.tennessee.edu/utk_graddiss/7714\"\n```\n:::\n:::\n\n\nWe have a character vector with one link. That's great! `list_links` is a list of links (in the form of character vectors) as we wanted.\n\n#### Getting the data from the list of links\n\nWe will now extract the data (date, major, and PI) for all links in our list.\n\nAgain, before running a for loop, we need to allocate memory first by creating an empty container:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlist_data <- vector(\"list\", length(list_links))\n```\n:::\n\n\nAnd here is our big loop to get the data from our list of links:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfor (i in seq_along(list_links)) {\n  html <- read_html(list_links[[i]])\n  date <- html %>%\n    html_element(\"#publication_date p\") %>%\n    html_text2()\n  major <- html %>%\n    html_element(\"#department p\") %>%\n    html_text2()\n  pi <- html %>%\n    html_element(\"#advisor1 p\") %>%\n    html_text2()\n  list_data[[i]] <- cbind(date, major, pi)\n}\n```\n:::\n\n\nLet's make sure all looks good by printing the second element of `list_data`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlist_data[[2]]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n     date      major       pi                   \n[1,] \"12-2022\" \"Chemistry\" \"Dr. Ampofo K. Darko\"\n```\n:::\n:::\n\n\nAll looking good, so let's turn this big list into a tibble:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nresult <- do.call(rbind.data.frame, list_data) %>%\n  tibble::as_tibble()\n```\n:::\n\n\n:::{.note}\n\nThe notation `tibble::as_tibble()` means that we are using the function `as_tibble()` from the package [tibble](https://tibble.tidyverse.org/). A tibble is the [tidyverse](https://www.tidyverse.org/) version of a dataframe. One advantage is that it will only print the first 10 rows by default instead of printing the whole dataframe.\n\n:::\n\nHere is our result:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nresult\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 100 × 3\n   date    major                                      pi                   \n   <chr>   <chr>                                      <chr>                \n 1 5-2023  Chemistry                                  Craig E. Barnes      \n 2 12-2022 Chemistry                                  Dr. Ampofo K. Darko  \n 3 12-2022 Industrial Engineering                     James Ostrowski      \n 4 5-2022  Entomology, Plant Pathology and Nematology Heather Kelly        \n 5 5-2022  Mechanical Engineering                     Caleb D. Rucker      \n 6 12-2022 Electrical Engineering                     Yilu Liu             \n 7 5-2022  Comparative and Experimental Medicine      Brian K. Whitlock    \n 8 5-2022  History                                    Jay Rubenstein       \n 9 12-2022 Anthropology                               Dawnie W. Steadman   \n10 12-2022 Mechanical Engineering                     Stephanie C. TerMaath\n# … with 90 more rows\n```\n:::\n:::\n\n\nWe can rename the headers:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnames(result) <- c(\"Date\", \"Major\", \"PI\")\n```\n:::\n\n\nThis is what our final result looks like:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nresult\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 100 × 3\n   Date    Major                                      PI                   \n   <chr>   <chr>                                      <chr>                \n 1 5-2023  Chemistry                                  Craig E. Barnes      \n 2 12-2022 Chemistry                                  Dr. Ampofo K. Darko  \n 3 12-2022 Industrial Engineering                     James Ostrowski      \n 4 5-2022  Entomology, Plant Pathology and Nematology Heather Kelly        \n 5 5-2022  Mechanical Engineering                     Caleb D. Rucker      \n 6 12-2022 Electrical Engineering                     Yilu Liu             \n 7 5-2022  Comparative and Experimental Medicine      Brian K. Whitlock    \n 8 5-2022  History                                    Jay Rubenstein       \n 9 12-2022 Anthropology                               Dawnie W. Steadman   \n10 12-2022 Mechanical Engineering                     Stephanie C. TerMaath\n# … with 90 more rows\n```\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
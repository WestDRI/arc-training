{
  "hash": "50283f81c732588b77afbe9b354145d7",
  "result": {
    "markdown": "---\ntitle: GIS mapping with R\nauthor: Marie-Hélène Burle\n---\n\n\n:::{.def}\n\nIn this webinar, we will see how to create all sorts of GIS maps with the packages [sf](https://github.com/r-spatial/sf), [tmap](https://github.com/mtennekes/tmap), [raster](https://github.com/rspatial/raster), [leaflet](https://github.com/rstudio/leaflet), [ggplot2](https://github.com/tidyverse/ggplot2), grid (part of Base R), and [mapview](https://github.com/r-spatial/mapview):\n\n- simple maps\n- inset maps\n- faceted maps\n- animated maps\n- interactive maps\n- raster maps\n\nFinally, we will learn how to add basemaps from [OpenStreetMap](https://www.openstreetmap.org/#map=3/71.34/-96.82) and [Google Maps](https://www.google.com/maps).\n\n:::\n\n[Slides](gis_mapping_slides.qmd){.btn .btn-outline-primary} [(Click and wait: this reveal.js presentation is heavy and takes some time to load...)]{.inlinenote}\n<br><br>\n\n\n{{< video https://www.youtube.com/embed/7QoccXWqeUs >}}\n\n\n\n## GIS concepts\n\n### Types of spatial data\n\n#### Vector data\n\nVector data represent *discrete objects*.\n\nThey contain:\n\n- a geometry: the shape and location of the objects,\n- attributes: additional variables (e.g. name, year, type).\n\nCommon file formats include [GeoJSON](https://en.wikipedia.org/wiki/GeoJSON) and [shapefile](https://en.wikipedia.org/wiki/Shapefile).\n\n:::{.example}\n\nExamples: countries, roads, rivers, towns.\n\n:::\n\n#### Raster data\n\nRaster data represent *continuous phenomena* or *spatial fields*.\n\nCommon file formats include [TIFF](https://en.wikipedia.org/wiki/TIFF), [GeoTIFF](https://en.wikipedia.org/wiki/GeoTIFF), [NetCDF](https://en.wikipedia.org/wiki/NetCDF), and [Esri grid](https://en.wikipedia.org/wiki/Esri_grid).\n\n:::{.example}\n\nExamples: temperature, air quality, elevation, water depth.\n\n:::\n\n### Vector data\n\nVector data come in multiple types:\n\n- *point:* &emsp;&emsp;&emsp;&emsp;single set of coordinates,\n- *multi-point:* &emsp;&ensp;multiple sets of coordinates,\n- *polyline:* &emsp;&emsp;&emsp;multiple sets for which the order matters,\n- *multi-polyline:* &ensp;multiple of the above,\n- *polygon:* &emsp;&emsp;&emsp;same as polyline but first and last sets are the same,\n- *multi-polygon:* &ensp;multiple of the above.\n\n### Raster data\n\n*Grid* of equally sized rectangular cells containing values for some variables.\n\nSize of cells = resolution.\n\nFor computing efficiency, rasters do not have coordinates of each cell, but the bounding box and the number of rows and columns.\n\n### Coordinate Reference Systems (CRS)\n\nA location on Earth's surface can be identified by its *coordinates* and some *reference system* called CRS.\n\nThe coordinates (`x`, `y`) are called *longitude* and *latitude*.\n\nThere can be a 3^rd^ coordinate (`z`) for elevation or other measurement—usually a vertical one.\n\nAnd a 4^th^ (`m`) for some other data attribute—usually a horizontal measurement.\n\nIn 3D, longitude and latitude are expressed in angular units (e.g. degrees) and the reference system needed is an *angular CRS* or *geographic coordinate system (GCS)*.\n\nIn 2D, they are expressed in linear units (e.g. meters) and the reference system needed is a *planar CRS* or *projected coordinate system (PCS)*.\n\n### Datums\n\nSince the Earth is not a perfect sphere, we use spheroidal models to represent its surface. Those are called *geodetic datums*.\n\nSome datums are global, others local (more accurate in a particular area of the globe, but only useful there).\n\n:::{.example}\n\n*Examples of commonly used global datums:*\n\n- WGS84 (World Geodesic System 1984),\n- NAD83 (North American Datum of 1983).\n\n:::\n\n### Angular CRS\n\nAn angular CRS contains a datum, an angular unit and references such as a prime meridian (e.g. the Royal Observatory, Greenwich, England).\n\nIn an angular CRS or GCS:\n\n- Longitude ($\\lambda$) represents the angle between the prime meridian and the meridian that passes through that location.\n\n- Latitude ($\\phi$) represents the angle between the line that passes through the center of the Earth and that location and its projection on the equatorial plane.\n\nLongitude and latitude are thus angular coordinates.\n\n### Projections\n\nTo create a two-dimensional map, you need to project this 3D angular CRS into a 2D one.\n\nVarious projections offer different characteristics. For instance:\n\n- some respect areas (equal-area),\n- some respect the shape of geographic features (conformal),\n- some *almost* respect both for small areas.\n\nIt is important to choose one with sensible properties for your goals.\n\n:::{.example}\n\nExamples of projections:\n\n- Mercator,\n- UTM,\n- Robinson.\n\n:::\n\n### Planar CRS\n\nA planar CRS is defined by a datum, a projection and a set of parameters such as a linear unit and the origins.\n\nCommon planar CRS have been assigned a unique ID called [EPSG](https://en.wikipedia.org/wiki/EPSG_Geodetic_Parameter_Dataset) code which is much more convenient to use.\n\nIn a planar CRS, coordinates will not be in degrees anymore but in meters (or other length unit).\n\n### Projecting into a new CRS\n\nYou can change the projection of your data.\n\nVector data won't suffer any loss of precision, but raster data will.\n\n→ best to try to avoid reprojecting rasters: if you want to combine various datasets which have different projections, reproject vector data instead.\n\n## GIS in R\n\n### Resources\n\n#### Open GIS data\n\n[Free GIS Data](https://freegisdata.rtwilson.com/): list of free GIS datasets.\n\n#### Books\n\n[Geocomputation with R](https://geocompr.robinlovelace.net/) by Robin Lovelace, Jakub Nowosad and Jannes Muenchow. \\\n[Spatial Data Science](https://keen-swartz-3146c4.netlify.app/) by Edzer Pebesma and Roger Bivand. \\\n[Spatial Data Science with R](https://rspatial.org/) by Robert J. Hijmans. \\\n[Using Spatial Data with R](https://cengel.github.io/R-spatial/) by Claudia A. Engel.\n\n#### Tutorial\n\n[An Introduction to Spatial Data Analysis and Visualisation in R](https://data.cdrc.ac.uk/dataset/introduction-spatial-data-analysis-and-visualisation-r) by the CDRC.\n\n### Resources\n\n#### Website\n\n[r-spatial](https://www.r-spatial.org/) by Edzer Pebesma, Marius Appel and Daniel Nüst.\n\n#### CRAN package list\n\n[Analysis of Spatial Data](https://cran.r-project.org/web/views/Spatial.html).\n\n#### Mailing list\n\n[R Special Interest Group on using Geographical data and Mapping](https://stat.ethz.ch/mailman/listinfo/r-sig-geo).\n\n## Packages\n\n[There is now a rich ecosystem of GIS packages in R](https://rdcu.be/cjceF)[^1].\n\n[^1]: Bivand, R.S. Progress in the R ecosystem for representing and handling spatial data. J Geogr Syst (2020). https://doi.org/10.1007/s10109-020-00336-0.\n\n### Data manipulation\n\n#### Older packages\n\n- *sp*\n- *raster*\n- *rgdal*\n- *rgeos*\n\n#### Newer generation\n\n- [sf](https://github.com/r-spatial/sf): &emsp;&ensp;&nbsp;vector data,\n- [terra](https://github.com/rspatial/terra): &ensp;raster data (also has vector data capabilities).\n\n### Mapping\n\n#### Static maps\n\n- *ggplot2* + *ggspatial*\n- *tmap*\n\n#### Dynamic maps\n\n- *leaflet*\n- *ggplot2* + *gganimate*\n- *mapview*\n- *ggmap*\n- *tmap*\n\n### sf: Simple Features in R\n\nGeospatial vectors: points, lines, polygons.\n\n[Simple Features](https://en.wikipedia.org/wiki/Simple_Features)—defined by the [Open Geospatial Consortium (OGC)](https://en.wikipedia.org/wiki/Open_Geospatial_Consortium) and formalized by [ISO](https://en.wikipedia.org/wiki/International_Organization_for_Standardization)—is a set of standards now used by most GIS libraries.\n\n[Well-known text (WKT)](https://en.wikipedia.org/wiki/Well-known_text_representation_of_geometry) is a markup language for representing vector geometry objects according to those standards.\n\nA compact computer version also exists—well-known binary (WKB)—used by spatial databases.\n\nThe package *sp* predates Simple Features.\n\n*sf*—launched in 2016—implements these standards in R in the form of sf objects: data.frames (or tibbles) containing the attributes, extended by sfc objects or simple feature geometries list-columns.\n\n### sf\n\nSome useful links:\n\n- [GitHub repo](https://github.com/r-spatial/sf),\n- [Paper](https://journal.r-project.org/archive/2018/RJ-2018-009/index.html),\n- [Resources](https://r-spatial.github.io/sf/),\n- [Cheatsheet](https://www.rstudio.com/resources/cheatsheets/),\n- 6 vignettes: [1](https://r-spatial.github.io/sf/articles/sf1.html), [2](https://r-spatial.github.io/sf/articles/sf2.html), [3](https://r-spatial.github.io/sf/articles/sf3.html), [4](https://r-spatial.github.io/sf/articles/sf4.html), [5](https://r-spatial.github.io/sf/articles/sf5.html), [6](https://r-spatial.github.io/sf/articles/sf6.html).\n\nAnd the cheatsheet:\n\n[![](img/sf_cs_1.jpg)](https://posit.co/wp-content/uploads/2022/10/sf.pdf)xxxxx\n\n[![](img/sf_cs_2.jpg)](https://posit.co/wp-content/uploads/2022/10/sf.pdf)\n\n### sf objects\n\n![](img/sf_object_1_nw.png){fig-alt=\"noshadow\"}\n\n![](img/sf_object_2_nw.png){fig-alt=\"noshadow\"}\n\n![](img/sf_object_3_nw.png){fig-alt=\"noshadow\"}\n\n![](img/sf_object_4_nw.png){fig-alt=\"noshadow\"}\n\n![](img/sf_object_5_nw.png){fig-alt=\"noshadow\"}\n\n### sf functions\n\nMost functions start with `st_` (which refers to \"spatial type\").\n\n### terra: Geospatial rasters\n\nFaster and simpler replacement for the *raster* package by the same team.\n\nMostly implemented in C++.\n\nCan work with datasets too large to be loaded into memory.\n\n### terra\n\nSome useful links:\n\n- [GitHub repo](https://github.com/rspatial/terra),\n- [Resources](https://rspatial.github.io/terra/reference/terra-package.html),\n- [Full manual](https://rspatial.org/terra/index.html).\n\n### tmap: [Layered grammar of graphics](http://vita.had.co.nz/papers/layered-grammar.pdf) GIS maps\n\nSome useful links:\n\n- [GitHub repo](https://github.com/mtennekes/tmap),\n- [Resources](https://mtennekes.github.io/tmap/).\n\n#### Help pages and vignettes\n\n```{.r}\n?tmap-element\nvignette(\"tmap-getstarted\")\n# All the usual help pages, e.g.:\n?tm_layout\n```\n\n#### tmap functions\n\nMain functions start with `tmap_`\n\nFunctions creating map elements start with `tm_`\n\n#### tmap functioning\n\nVery similar to *ggplot2*\n\nTypically, a map contains:\n\n- One or multiple layer(s) (the order matters as they stack on top of each other)\n- Some layout (e.g. customization of title, background, margins): `tm_layout`\n- A compass: `tm_compass`\n- A scale bar: `tm_scale_bar`\n\nEach layer contains:\n\n- Some data: `tm_shape`\n- How that data will be represented: e.g. `tm_polygons`, `tm_lines`, `tm_raster`\n\n#### tmap example\n\n![](img/tmap1_nw.png){fig-alt=\"noshadow\"}\n\n![](img/tmap2_nw.png){fig-alt=\"noshadow\"}\n\n![](img/tmap3_nw.png){fig-alt=\"noshadow\"}\n\n![](img/tmap4_nw.png){fig-alt=\"noshadow\"}\n\n![](img/tmap5_nw.png){fig-alt=\"noshadow\"}\n\n![](img/tmap6_nw.png){fig-alt=\"noshadow\"}\n\n![](img/tmap7_nw.png){fig-alt=\"noshadow\"}\n\n![](img/tmap8_nw.png){fig-alt=\"noshadow\"}\n\n### ggplot2 (the standard in R plots)\n\nSome useful links:\n\n- [GitHub repo](https://github.com/tidyverse/ggplot2),\n- [Resources](https://ggplot2.tidyverse.org/),\n- [Cheatsheet](https://www.rstudio.com/resources/cheatsheets/).\n\n![](img/ggplot_cs_1.jpg)\n\n![](img/ggplot_cs_2.jpg)\n\n[geom_sf](https://ggplot2.tidyverse.org/reference/ggsf.html) allows to plot sf objects (i.e. make maps).\n\n## Example: <br>Glaciers melt in North America\n\n### Data\n\nFor this webinar, we will use:\n\n- the Alaska as well as the Western Canada and USA subsets of the [Randolph Glacier Inventory](http://www.glims.org/RGI/) version 6.0[^2],\n- the [USGS time series of the named glaciers of Glacier National Park](https://www.sciencebase.gov/catalog/item/58af7022e4b01ccd54f9f542)[^3],\n- the Alaska as well as the Western Canada and USA subsets of the [consensus estimate for the ice thickness distribution of all glaciers on Earth dataset](https://www.research-collection.ethz.ch/handle/20.500.11850/315707)[^4].\n\nThe datasets can be downloaded as zip files from these websites\n\n[^2]: RGI Consortium (2017). Randolph Glacier Inventory – A Dataset of Global Glacier Outlines: Version 6.0: Technical Report, Global Land Ice Measurements from Space, Colorado, USA. Digital Media. DOI: https://doi.org/10.7265/N5-RGI-60.\n[^3]: Fagre, D.B., McKeon, L.A., Dick, K.A. and Fountain, A.G., 2017, Glacier margin time series (1966, 1998, 2005, 2015) of the named glaciers of Glacier National Park, MT, USA: U.S. Geological Survey data release. DOI: https://doi.org/10.5066/F7P26WB1.\n[^4]: Farinotti, Daniel, 2019, A consensus estimate for the ice thickness distribution of all glaciers on Earth - dataset, Zurich. ETH Zurich. DOI: https://doi.org/10.3929/ethz-b-000315707.\n\n### Packages\n\nPackages need to be installed before they can be loaded in a session.\n\nPackages on CRAN can be installed with:\n\n```{.r}\ninstall.packages(\"<package-name>\")\n```\n\n`basemaps` is not on CRAN and needs to be installed from GitHub thanks to `devtools`:\n\n```{.r}\ninstall.packages(\"devtools\")\ndevtools::install_github(\"16EAGLE/basemaps\")\n```\n\nWe load all the packages that we will need at the top of the script:\n\n\n::: {.cell hash='gis_mapping_cache/html/unnamed-chunk-1_0eff898f81621c027da1d2318b9d6f06'}\n\n```{.r .cell-code}\nlibrary(sf)                 # spatial vector data manipulation\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in library(sf): there is no package called 'sf'\n```\n:::\n\n```{.r .cell-code}\nlibrary(tmap)               # map production and tiled web map\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in library(tmap): there is no package called 'tmap'\n```\n:::\n\n```{.r .cell-code}\nlibrary(dplyr)              # non GIS specific (tabular data manipulation)\nlibrary(magrittr)           # non GIS specific (pipes)\nlibrary(purrr)              # non GIS specific (functional programming)\nlibrary(rnaturalearth)      # basemap data access functions\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in library(rnaturalearth): there is no package called 'rnaturalearth'\n```\n:::\n\n```{.r .cell-code}\nlibrary(rnaturalearthdata)  # basemap data\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in library(rnaturalearthdata): there is no package called 'rnaturalearthdata'\n```\n:::\n\n```{.r .cell-code}\nlibrary(mapview)            # tiled web map\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in library(mapview): there is no package called 'mapview'\n```\n:::\n\n```{.r .cell-code}\nlibrary(grid)               # (part of base R) used to create inset map\nlibrary(ggplot2)            # alternative to tmap for map production\nlibrary(ggspatial)          # spatial framework for ggplot2\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in library(ggspatial): there is no package called 'ggspatial'\n```\n:::\n\n```{.r .cell-code}\nlibrary(terra)              # gridded spatial data manipulation\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in library(terra): there is no package called 'terra'\n```\n:::\n\n```{.r .cell-code}\nlibrary(ggmap)              # download basemap data\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in library(ggmap): there is no package called 'ggmap'\n```\n:::\n\n```{.r .cell-code}\nlibrary(basemaps)           # download basemap data\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in library(basemaps): there is no package called 'basemaps'\n```\n:::\n\n```{.r .cell-code}\nlibrary(magick)             # wrapper around ImageMagick STL\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in library(magick): there is no package called 'magick'\n```\n:::\n\n```{.r .cell-code}\nlibrary(leaflet)\t        # integrate Leaflet JS in R\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in library(leaflet): there is no package called 'leaflet'\n```\n:::\n:::\n\n\n## Reading and preparing data\n\n### Randolph Glacier Inventory\n\nThis dataset contains the contour of all glaciers on Earth.\n\nWe will focus on glaciers in Western North America.\n\nYou can download and unzip `02_rgi60_WesternCanadaUS` and `01_rgi60_Alaska`\nfrom the [Randolph Glacier Inventory](http://www.glims.org/RGI/) version 6.0.\n\n### Reading in data\n\nData get imported and turned into sf objects with the function `sf::st_read`:\n\n```{.r}\nak <- st_read(\"data/01_rgi60_Alaska\")\n```\n\n:::{.note}\n\nMake sure to use the absolute paths or the paths relative to your working directory (which can be obtained with `getwd`).\n\n:::\n\n```{.r}\nak <- st_read(\"data/01_rgi60_Alaska\")\n```\n\n<div style=\"font-size: 20px; margin: 25px 0 12px 1px; text-align: left; color: #802b00\">[Out]</div>\n\n```{.r}\nReading layer `01_rgi60_Alaska' from data source `./data/01_rgi60_Alaska'\n\t\t\t   using driver `ESRI Shapefile'\nSimple feature collection with 27108 features and 22 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: -176.1425 ymin: 52.05727 xmax: -126.8545 ymax: 69.35167\nGeodetic CRS:  WGS 84\n```\n\n:::{.exo}\n\n:::{.yourturn}\n\nYour turn:\n\n:::\n\nRead in the data for the rest of north western America (from `02_rgi60_WesternCanadaUS`) and create an sf object called `wes`.\n\n:::\n\n### First look at the data\n\n```{.r}\nak\n```\n\n<div style=\"font-size: 20px; margin: 25px 0 12px 1px; text-align: left; color: #802b00\">[Out]</div>\n\n```{.r}\nSimple feature collection with 27108 features and 22 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: -176.1425 ymin: 52.05727 xmax: -126.8545 ymax: 69.35167\nGeodetic CRS:  WGS 84\nFirst 10 features:\n\t\t   RGIId        GLIMSId  BgnDate  EndDate    CenLon   CenLat O1Region\n1  RGI60-01.00001 G213177E63689N 20090703 -9999999 -146.8230 63.68900        1\n2  RGI60-01.00002 G213332E63404N 20090703 -9999999 -146.6680 63.40400        1\n3  RGI60-01.00003 G213920E63376N 20090703 -9999999 -146.0800 63.37600        1\n4  RGI60-01.00004 G213880E63381N 20090703 -9999999 -146.1200 63.38100        1\n5  RGI60-01.00005 G212943E63551N 20090703 -9999999 -147.0570 63.55100        1\n6  RGI60-01.00006 G213756E63571N 20090703 -9999999 -146.2440 63.57100        1\n7  RGI60-01.00007 G213771E63551N 20090703 -9999999 -146.2295 63.55085        1\n8  RGI60-01.00008 G213704E63543N 20090703 -9999999 -146.2960 63.54300        1\n9  RGI60-01.00009 G212400E63659N 20090703 -9999999 -147.6000 63.65900        1\n10 RGI60-01.00010 G212830E63513N 20090703 -9999999 -147.1700 63.51300        1\nO2Region   Area Zmin Zmax Zmed Slope Aspect  Lmax Status Connect Form\n1         2  0.360 1936 2725 2385    42    346   839      0       0    0\n2         2  0.558 1713 2144 2005    16    162  1197      0       0    0\n3         2  1.685 1609 2182 1868    18    175  2106      0       0    0\n4         2  3.681 1273 2317 1944    19    195  4175      0       0    0\n5         2  2.573 1494 2317 1914    16    181  2981      0       0    0\n6         2 10.470 1201 3547 1740    22     33 10518      0       0    0\n7         2  0.649 1918 2811 2194    23    151  1818      0       0    0\n8         2  0.200 2826 3555 3195    45     80   613      0       0    0\n9         2  1.517 1750 2514 1977    18    274  2255      0       0    0\n10        2  3.806 1280 1998 1666    17     35  3332      0       0    0\nTermType Surging Linkages Name                       geometry\n1         0       9        9 <NA> POLYGON ((-146.818 63.69081...\n2         0       9        9 <NA> POLYGON ((-146.6635 63.4076...\n3         0       9        9 <NA> POLYGON ((-146.0723 63.3834...\n4         0       9        9 <NA> POLYGON ((-146.149 63.37919...\n5         0       9        9 <NA> POLYGON ((-147.0431 63.5502...\n6         0       9        9 <NA> POLYGON ((-146.2436 63.5562...\n7         0       9        9 <NA> POLYGON ((-146.2495 63.5531...\n8         0       9        9 <NA> POLYGON ((-146.2992 63.5443...\n9         0       9        9 <NA> POLYGON ((-147.6147 63.6643...\n10        0       9        9 <NA> POLYGON ((-147.1494 63.5098...\n```\n\n### Structure of the data\n\n```{.r}\nstr(ak)\n```\n\n<div style=\"font-size: 20px; margin: 25px 0 12px 1px; text-align: left; color: #802b00\">[Out]</div>\n\n```{.r}\nClasses ‘sf’ and 'data.frame':\t27108 obs. of  23 variables:\n$ RGIId   : chr  \"RGI60-01.00001\" \"RGI60-01.00002\" \"RGI60-01.00003\" ...\n$ GLIMSId : chr  \"G213177E63689N\" \"G213332E63404N\" \"G213920E63376N\" ...\n$ BgnDate : chr  \"20090703\" \"20090703\" \"20090703\" \"20090703\" ...\n$ EndDate : chr  \"-9999999\" \"-9999999\" \"-9999999\" \"-9999999\" ...\n$ CenLon  : num  -147 -147 -146 -146 -147 ...\n$ CenLat  : num  63.7 63.4 63.4 63.4 63.6 ...\n$ O1Region: chr  \"1\" \"1\" \"1\" \"1\" ...\n$ O2Region: chr  \"2\" \"2\" \"2\" \"2\" ...\n$ Area    : num  0.36 0.558 1.685 3.681 2.573 ...\n$ Zmin    : int  1936 1713 1609 1273 1494 1201 1918 2826 1750 1280 ...\n$ Zmax    : int  2725 2144 2182 2317 2317 3547 2811 3555 2514 1998 ...\n$ Zmed    : int  2385 2005 1868 1944 1914 1740 2194 3195 1977 1666 ...\n$ Slope   : num  42 16 18 19 16 22 23 45 18 17 ...\n$ Aspect  : int  346 162 175 195 181 33 151 80 274 35 ...\n$ Lmax    : int  839 1197 2106 4175 2981 10518 1818 613 2255 3332 ...\n$ Status  : int  0 0 0 0 0 0 0 0 0 0 ...\n$ Connect : int  0 0 0 0 0 0 0 0 0 0 ...\n$ Form    : int  0 0 0 0 0 0 0 0 0 0 ...\n$ TermType: int  0 0 0 0 0 0 0 0 0 0 ...\n$ Surging : int  9 9 9 9 9 9 9 9 9 9 ...\n$ Linkages: int  9 9 9 9 9 9 9 9 9 9 ...\n$ Name    : chr  NA NA NA NA ...\n$ geometry:sfc_POLYGON of length 27108; first list element: List of 1\n..$ : num [1:65, 1:2] -147 -147 -147 -147 -147 ...\n..- attr(*, \"class\")= chr [1:3] \"XY\" \"POLYGON\" \"sfg\"\n- attr(*, \"sf_column\")= chr \"geometry\"\n- attr(*, \"agr\")= Factor w/ 3 levels \"constant\",\"aggregate\",..: NA NA NA ...\n..- attr(*, \"names\")= chr [1:22] \"RGIId\" \"GLIMSId\" \"BgnDate\" \"EndDate\" ...\n```\n\n### Inspect your data\n\n:::{.exo}\n\n:::{.yourturn}\n\nYour turn:\n\n:::\n\nInspect the `wes` object you created.\n\n:::\n\n### Glacier National Park dataset\n\nThis dataset contains a time series of the retreat of 39 glaciers of Glacier National Park, MT, USA for the years `1966`, `1998`, `2005` and `2015`.\n\nYou can download and unzip the 4 sets of files from the [USGS website](https://www.sciencebase.gov/catalog/item/58af7022e4b01ccd54f9f542).\n\n### Read in and clean datasets\n\nCreate a function that reads and cleans the data:\n\n```{.r}\nprep <- function(dir) {\n  g <- st_read(dir)\n  g %<>% rename_with(~ tolower(gsub(\"Area....\", \"area\", .x)))\n  g %<>% dplyr::select(\n    year,\n    objectid,\n    glacname,\n    area,\n    shape_leng,\n    x_coord,\n    y_coord,\n    source_sca,\n    source\n  )\n}\n```\n\nCreate a vector of dataset names:\n\n```{.r}\ndirs <- grep(\"data/GNPglaciers_.*\", list.dirs(), value = T)\n```\n\nPass each element of that vector through prep() thanks to map():\n\n```{.r}\ngnp <- map(dirs, prep)\n```\n\n:::{.note}\n\nWe use `dplyr::select` because <b>terra</b> also has a `select` function.\n\n:::\n\n### Combine datasets into one sf object\n\nCheck that the CRS are all the same:\n\n```{.r}\nall(sapply(\n  list(st_crs(gnp[[1]]),\n       st_crs(gnp[[2]]),\n       st_crs(gnp[[3]]),\n       st_crs(gnp[[4]])),\n  function(x) x == st_crs(gnp[[1]])\n))\n```\n\n<div style=\"font-size: 20px; margin: 25px 0 12px 1px; text-align: left; color: #802b00\">[Out]</div>\n\n```{.r}\n[1] TRUE\n```\n\nWe can `rbind` the elements of our list:\n\n```{.r}\ngnp <- do.call(\"rbind\", gnp)\n```\n\nYou can inspect your new sf object by calling it or with `str`.\n\n### Estimate for ice thickness\n\nThis dataset contains an estimate for the ice thickness of all glaciers on Earth.\n\nThe nomenclature follows the Randolph Glacier Inventory.\n\nIce thickness being a spatial field, this is raster data.\n\nWe will use data in `RGI60-02.16664_thickness.tif` from the [ETH Zürich Research Collection](https://www.research-collection.ethz.ch/handle/20.500.11850/315707)\nwhich corresponds to one of the glaciers (Agassiz) of Glacier National Park.\n\n### Load raster data\n\nRead in data and create a SpatRaster object:\n\n```{.r}\nras <- rast(\"data/RGI60-02/RGI60-02.16664_thickness.tif\")\n```\n\n### Inspect our SpatRaster object\n\n```{.r}\nras\n```\n\n<div style=\"font-size: 20px; margin: 25px 0 12px 1px; text-align: left; color: #802b00\">[Out]</div>\n\n```{.r}\nclass       : SpatRaster \ndimensions  : 93, 74, 1  (nrow, ncol, nlyr)\nresolution  : 25, 25  (x, y)\nextent      : 707362.5, 709212.5, 5422962, 5425288  (xmin, xmax, ymin, ymax)\ncoord. ref. : +proj=utm +zone=11 +datum=WGS84 +units=m +no_defs \nsource      : RGI60-02.16664_thickness.tif \nname        : RGI60-02.16664_thickness \n```\n\n`nlyr` gives us the number of bands (a single one here). You can also run `str(ras)`.\n\n### Our data\n\nWe now have 3 sf objects and 1 SpatRaster object:\n\n- `ak`: contour of glaciers in AK,\n- `wes`: contour of glaciers in the rest of Western North America,\n- `gnp`: time series of 39 glaciers in Glacier National Park, MT, USA,\n- `ras`: ice thickness of the Agassiz Glacier from Glacier National Park.\n\n## Making maps\n\n### Let's map our sf object ak\n\nAt a bare minimum, we need `tm_shape` with the data and some info as to how to represent that data:\n\n```{.r}\ntm_shape(ak) +\n  tm_polygons()\n```\n\n![](img/ak0.png)\n\n### We need to label and customize it\n\n```{.r}\ntm_shape(ak) +\n  tm_polygons() +\n  tm_layout(\n    title = \"Glaciers of Alaska\",\n    title.position = c(\"center\", \"top\"),\n    title.size = 1.1,\n    bg.color = \"#fcfcfc\",\n    inner.margins = c(0.06, 0.01, 0.09, 0.01),\n    outer.margins = 0,\n    frame.lwd = 0.2\n  ) +\n  tm_compass(\n    type = \"arrow\",\n    position = c(\"right\", \"top\"),\n    size = 1.2,\n    text.size = 0.6\n  ) +\n  tm_scale_bar(\n    breaks = c(0, 500, 1000),\n    position = c(\"right\", \"BOTTOM\")\n  )\n```\n\n![](img/ak.png)\n\n### Make a map of the wes object\n\n:::{.exo}\n\n:::{.yourturn}\n\nYour turn:\n\n:::\n\nMake a map with the `wes` object you created with the data for Western North America excluding AK.\n\n:::\n\n![](img/wes.png)\n\n### Now, let's make a map with ak and wes\n\n*The Coordinate Reference Systems (CRS) must be the same*.\n\n*sf* has a function to retrieve the CRS of an *sf* object: `st_crs`.\n\n```{.r}\nst_crs(ak) == st_crs(wes)\n```\n\n<div style=\"font-size: 20px; margin: 25px 0 12px 1px; text-align: left; color: #802b00\">[Out]</div>\n\n```{.r}\n[1] TRUE\n```\n\nSo we're good (we will see later what to do if this is not the case).\n\n### Our combined map\n\nLet's start again with a minimum map without any layout to test things out:\n\n```{.r}\ntm_shape(ak) +\n  tm_polygons() +\n  tm_shape(wes) +\n  tm_polygons()\n```\n\n![](img/nwa0.png)\n\nUh ... oh ...\n\n### What went wrong?\n\nMaps are bound by \"bounding boxes\". In tmap, they are called `bbox`.\n\n*tmap* sets the bbox the first time `tm_shape` is called. In our case, the bbox was thus set to the bbox of the ak object.\n\nWe need to create a new bbox for our new map.\n\n### Retrieving bounding boxes\n\n*sf* has a function to retrieve the bbox of an sf object: `st_bbox`\n\nThe bbox of `ak` is:\n\n```{.r}\nst_bbox(ak)\n```\n\n<div style=\"font-size: 20px; margin: 25px 0 12px 1px; text-align: left; color: #802b00\">[Out]</div>\n\n```{.r}\nxmin         ymin       xmax         ymax\n-176.14247   52.05727   -126.85450   69.35167\n```\n\n### Combining bounding boxes\n\nbbox objects can't be combined directly.\n\nHere is how we can create a new bbox encompassing both of our bboxes:\n\n- first, we transform our bboxes to sfc objects with `st_as_sfc`,\n- then we combine those objects into a new sfc object with `st_union`,\n- finally, we retrieve the bbox of that object with `st_bbox`:\n\n```{.r}\nnwa_bbox <- st_bbox(\n  st_union(\n    st_as_sfc(st_bbox(wes)),\n    st_as_sfc(st_bbox(ak))\n  )\n)\n```\n\n### Back to our map\n\nWe can now use our new bounding box for the map of Western North America:\n\n```{.r}\ntm_shape(ak, bbox = nwa_bbox) +\n  tm_polygons() +\n  tm_shape(wes) +\n  tm_polygons() +\n  tm_layout(\n    title = \"Glaciers of Western North America\",\n    title.position = c(\"center\", \"top\"),\n    title.size = 1.1,\n    bg.color = \"#fcfcfc\",\n    inner.margins = c(0.06, 0.01, 0.09, 0.01),\n    outer.margins = 0,\n    frame.lwd = 0.2\n  ) +\n  tm_compass(\n    type = \"arrow\",\n    position = c(\"right\", \"top\"),\n    size = 1.2,\n    text.size = 0.6\n  ) +\n  tm_scale_bar(\n    breaks = c(0, 1000, 2000),\n    position = c(\"right\", \"BOTTOM\")\n  )\n```\n\n![](img/nwa.jpg)\n\n### Let's add a basemap\n\nWe will use data from [Natural Earth](https://www.naturalearthdata.com/), a public domain map dataset.\n\nThere are much more fancy options, but they usually involve creating accounts (e.g. with Google) to access some API.\n\nIn addition, this dataset can be accessed direction from within R thanks to the [rOpenSci](https://ropensci.org/) packages:\n\n- `rnaturalearth`: provides the functions,\n- `rnaturalearthdata`: provides the data.\n\n### Create an sf object with states/provinces\n\n```{.r}\nstates_all <- ne_states(\n  country = c(\"canada\", \"united states of america\"),\n  returnclass = \"sf\"\n)\n```\n\n:::{.note}\n\n`ne_` stands for \"Natural Earth\".\n\n:::\n\n### Select relevant states/provinces\n\n```{.r}\nstates <- states_all %>%\n  filter(name_en == \"Alaska\" |\n           name_en == \"British Columbia\" |\n           name_en == \"Yukon\" |\n           name_en == \"Northwest Territories\" |\n           name_en ==  \"Alberta\" |\n           name_en == \"California\" |\n           name_en == \"Washington\" |\n           name_en == \"Oregon\" |\n           name_en == \"Idaho\" |\n           name_en == \"Montana\" |\n           name_en == \"Wyoming\" |\n           name_en == \"Colorado\" |\n           name_en == \"Nevada\" |\n           name_en == \"Utah\"\n         )\n```\n\n### Add the basemap to our map\n\n:::{.exosimple}\n\nWhat do we need to make sure of first?\n\n:::\n\n```{.r}\nst_crs(states) == st_crs(ak)\n```\n\n<div style=\"font-size: 20px; margin: 25px 0 12px 1px; text-align: left; color: #802b00\">[Out]</div>\n\n```{.r}\n[1] TRUE\n```\n\nWe add the basemap as a 3^rd^ layer.\n\nMind the order! If you put the basemap last, it will cover your data.\n\nOf course, we will use our `nwa_bbox` bounding box again.\n\nWe will also break `tm_polygons` into `tm_borders` and `tm_fill` for ak and wes in order to colourise them with slightly different colours:\n\n```{.r}\ntm_shape(states, bbox = nwa_bbox) +\n  tm_polygons(col = \"#f2f2f2\", lwd = 0.2) +\n  tm_shape(ak) +\n  tm_borders(col = \"#3399ff\") +\n  tm_fill(col = \"#86baff\") +\n  tm_shape(wes) +\n  tm_borders(col = \"#3399ff\") +\n  tm_fill(col = \"#86baff\") +\n  tm_layout(\n    title = \"Glaciers of Western North America\",\n    title.position = c(\"center\", \"top\"),\n    title.size = 1.1,\n    bg.color = \"#fcfcfc\",\n    inner.margins = c(0.06, 0.01, 0.09, 0.01),\n    outer.margins = 0,\n    frame.lwd = 0.2\n  ) +\n  tm_compass(\n    type = \"arrow\",\n    position = c(\"right\", \"top\"),\n    size = 1.2,\n    text.size = 0.6\n  ) +\n  tm_scale_bar(\n    breaks = c(0, 1000, 2000),\n    position = c(\"right\", \"BOTTOM\")\n  )\n```\n\n![](img/nwa_bg.jpg)\n\n### tmap styles\n\n*tmap* has a number of styles that you can try.\n\nFor instance, to set the style to \"classic\", run the following before making your map:\n\n```{.r}\ntmap_style(\"classic\")\n```\n\n:::{.note}\n\nOther options are:\n\n\"white\" (default), \"gray\", \"natural\", \"cobalt\", \"col_blind\", \"albatross\", \"beaver\", \"bw\", and \"watercolor\".\n\n:::\n\n![](img/nwa_bg_classic.jpg)\n\nTo return to the default, you need to run:\n\n```{.r}\ntmap_style(\"white\")\n```\n\nor:\n\n```{.r}\ntmap_options_reset()\n```\n\nwhich will reset every *tmap* option.\n\n## Inset maps\n\nNow, how can we combine this with our `gnp` object?\n\nWe could add it as an inset of our Western North America map.\n\n### First, let's map it\n\nLet's use the same `tm_borders` and `tm_fill` we just used:\n\n```{.r}\ntm_shape(gnp) +\n  tm_borders(col = \"#3399ff\") +\n  tm_fill(col = \"#86baff\") +\n  tm_layout(\n    title = \"Glaciers of Glacier National Park\",\n    title.position = c(\"center\", \"top\"),\n    legend.title.color = \"#fcfcfc\",\n    legend.text.size = 1,\n    bg.color = \"#fcfcfc\",\n    inner.margins = c(0.07, 0.03, 0.07, 0.03),\n    outer.margins = 0\n  ) +\n  tm_compass(\n    type = \"arrow\",\n    position = c(\"right\", \"top\"),\n    text.size = 0.7\n  ) +\n  tm_scale_bar(\n    breaks = c(0, 10, 20),\n    position = c(\"right\", \"BOTTOM\"),\n    text.size = 1\n  )\n```\n\n![](img/gnp.png)\n\n### Create an inset map\n\nAs always, first we check that the CRS are the same:\n\n```{.r}\nst_crs(gnp) == st_crs(ak)\n```\n\n<div style=\"font-size: 20px; margin: 25px 0 12px 1px; text-align: left; color: #802b00\">[Out]</div>\n\n```{.r}\n[1] FALSE\n```\n\nAH!\n\n### CRS transformation\n\nWe need to reproject `gnp` into the CRS of our other sf objects (e.g. `ak`):\n\n```{.r}\ngnp <- st_transform(gnp, st_crs(ak))\n```\n\n\nWe can verify that the CRS are now the same:\n\n```{.r}\nst_crs(gnp) == st_crs(ak)\n```\n\n<div style=\"font-size: 20px; margin: 25px 0 12px 1px; text-align: left; color: #802b00\">[Out]</div>\n\n```{.r}\n[1] TRUE\n```\n\n### Inset maps: first step\n\n*Add a rectangle showing the location of the GNP map in the main North America map*.\n\nWe need to create a new sfc object from the `gnp` bbox so that we can add it to our previous map as a new layer:\n\n```{.r}\ngnp_zone <- st_bbox(gnp) %>%\n  st_as_sfc()\n```\n\n### Inset maps: second step\n\n*Create a tmap object of the main map.* Of course, we need to edit the title. Also, note the presence of our new layer:\n\n```{.r}\nmain_map <- tm_shape(states, bbox = nwa_bbox) +\n  tm_polygons(col = \"#f2f2f2\", lwd = 0.2) +\n  tm_shape(ak) +\n  tm_borders(col = \"#3399ff\") +\n  tm_fill(col = \"#86baff\") +\n  tm_shape(wes) +\n  tm_borders(col = \"#3399ff\") +\n  tm_fill(col = \"#86baff\") +\n  tm_shape(gnp_zone) +\n  tm_borders(lwd = 1.5, col = \"#ff9900\") +\n  tm_layout(\n    title = \"Glaciers of Glacier National Park\",\n    title.position = c(\"center\", \"top\"),\n    title.size = 1.1,\n    bg.color = \"#fcfcfc\",\n    inner.margins = c(0.06, 0.01, 0.09, 0.01),\n    outer.margins = 0,\n    frame.lwd = 0.2\n  ) +\n  tm_compass(\n    type = \"arrow\",\n    position = c(\"right\", \"top\"),\n    size = 1.2,\n    text.size = 0.6\n  ) +\n  tm_scale_bar(\n    breaks = c(0, 500, 1000),\n    position = c(\"right\", \"BOTTOM\")\n  )\n```\n\n### Inset maps: third step\n\n*Create a tmap object of the inset map*.\n\nWe make sure to matching colours and edit the layouts for better readability:\n\n```{.r}\ninset_map <- tm_shape(gnp) +\n  tm_borders(col = \"#3399ff\") +\n  tm_fill(col = \"#86baff\") +\n  tm_layout(\n    legend.show = F,\n    bg.color = \"#fcfcfc\",\n    inner.margins = c(0.03, 0.03, 0.03, 0.03),\n    outer.margins = 0,\n    frame = \"#ff9900\",\n    frame.lwd = 3\n  )\n```\n\n### Inset maps: final step\n\n*Combine the two tmap objects*.\n\nWe print the main map and add the inset map with `grid::viewport`:\n\n```{.r}\nmain_map\nprint(inset_map, vp = viewport(0.41, 0.26, width = 0.5, height = 0.5))\n```\n\n![](img/inset_bg3.png)\n\n## Mapping a subset of the data\n\nTo see the retreat of the ice, we need to zoom in.\n\nLet's focus on a single glacier: Agassiz Glacier.\n\n### Map of the Agassiz Glacier\n\nSelect the data points corresponding to the Agassiz Glacier:\n\n```{.r}\nag <- gnp %>% filter(glacname == \"Agassiz Glacier\")\n```\n\n```{.r}\ntm_shape(ag) +\n  tm_polygons() +\n  tm_layout(\n    title = \"Agassiz Glacier\",\n    title.position = c(\"center\", \"top\"),\n    legend.position = c(\"left\", \"bottom\"),\n    legend.title.color = \"#fcfcfc\",\n    legend.text.size = 1,\n    bg.color = \"#fcfcfc\",\n    inner.margins = c(0.07, 0.03, 0.07, 0.03),\n    outer.margins = 0\n  ) +\n  tm_compass(\n    type = \"arrow\",\n    position = c(\"right\", \"top\"),\n    text.size = 0.7\n  ) +\n  tm_scale_bar(\n    breaks = c(0, 0.5, 1),\n    position = c(\"right\", \"BOTTOM\"),\n    text.size = 1\n  )\n```\n\n![](img/ag0.png)\n\nNot great ...\n\n### Map based on attribute variables\n\n```{.r}\ntm_shape(ag) +\n  tm_polygons(\"year\", palette = \"Blues\") +\n  tm_layout(\n    title = \"Agassiz Glacier\",\n    title.position = c(\"center\", \"top\"),\n    legend.position = c(\"left\", \"bottom\"),\n    legend.title.color = \"#fcfcfc\",\n    legend.text.size = 1,\n    bg.color = \"#fcfcfc\",\n    inner.margins = c(0.07, 0.03, 0.07, 0.03),\n    outer.margins = 0\n  ) +\n  tm_compass(\n    type = \"arrow\",\n    position = c(\"right\", \"top\"),\n    text.size = 0.7\n  ) +\n  tm_scale_bar(\n    breaks = c(0, 0.5, 1),\n    position = c(\"right\", \"BOTTOM\"),\n    text.size = 1\n  )\n```\n\n![](img/ag.png)\n\n### Using ggplot2 instead of tmap\n\nAs an alternative to *tmap*, *ggplot2* can plot maps with the `geom_sf` function:\n\n```{.r}\nggplot(ag) +\n  geom_sf(aes(fill = year)) +\n  scale_fill_brewer(palette = \"Blues\") +\n  labs(title = \"Agassiz Glacier\") +\n  annotation_scale(location = \"bl\", width_hint = 0.4) +\n  annotation_north_arrow(location = \"tr\", which_north = \"true\",\n                         pad_x = unit(0.75, \"in\"), pad_y = unit(0.5, \"in\"),\n                         style = north_arrow_fancy_orienteering) +\n  theme_bw() +\n  theme(plot.title = element_text(hjust = 0.5))\n```\n\nThe package *ggspatial* adds a lot of functionality to *ggplot2* for spatial data.\n\n![](img/ag_ggplot2.png)\n\n## Faceted maps\n\n### Faceted map of the retreat of Agassiz\n\n```{.r}\ntm_shape(ag) +\n  tm_polygons(col = \"#86baff\") +\n  tm_layout(\n    main.title = \"Agassiz Glacier\",\n    main.title.position = c(\"center\", \"top\"),\n    main.title.size = 1.2,\n    legend.position = c(\"left\", \"bottom\"),\n    legend.title.color = \"#fcfcfc\",\n    legend.text.size = 1,\n    bg.color = \"#fcfcfc\",\n    inner.margins = c(0, 0.03, 0, 0.03),\n    outer.margins = 0,\n    panel.label.bg.color = \"#fcfcfc\",\n    frame = F,\n    asp = 0.6\n  ) +\n  tm_compass(\n    type = \"arrow\",\n    position = c(\"right\", \"top\"),\n    size = 1,\n    text.size = 0.6\n  ) +\n  tm_scale_bar(\n    breaks = c(0, 0.5, 1),\n    position = c(\"right\", \"BOTTOM\"),\n    text.size = 0.6\n  ) +\n  tm_facets(\n    by = \"year\",\n    free.coords = F,\n    ncol = 4\n  )\n```\n\n![](img/agfacet.png)\n\n## Animated maps\n\n### Animated map of the Retreat of Agassiz\n\nFirst, we need to create a tmap object with facets:\n\n```{.r}\nagassiz_anim <- tm_shape(ag) +\n  tm_polygons(col = \"#86baff\") +\n  tm_layout(\n    title = \"Agassiz Glacier\",\n    title.position = c(\"center\", \"top\"),\n    legend.position = c(\"left\", \"bottom\"),\n    legend.title.color = \"#fcfcfc\",\n    legend.text.size = 1,\n    bg.color = \"#fcfcfc\",\n    inner.margins = c(0.08, 0, 0.08, 0),\n    outer.margins = 0,\n    panel.label.bg.color = \"#fcfcfc\"\n  ) +\n  tm_compass(\n    type = \"arrow\",\n    position = c(\"right\", \"top\"),\n    text.size = 0.7\n  ) +\n  tm_scale_bar(\n    breaks = c(0, 0.5, 1),\n    position = c(\"right\", \"BOTTOM\"),\n    text.size = 1\n  ) +\n  tm_facets(\n    along = \"year\",\n    free.coords = F\n  )\n```\n\nThen we can pass that object to `tmap_animation`:\n\n```{.r}\ntmap_animation(\n  agassiz_anim,\n  filename = \"ag.gif\",\n  dpi = 300,\n  inner.margins = c(0.08, 0, 0.08, 0),\n  delay = 100\n)\n```\n\n![](img/ag.gif)\n\n### Map of ice thickness of Agassiz\n\nNow, let's map the estimated ice thickness on Agassiz Glacier.\n\nThis time, we use `tm_raster`:\n\n```{.r}\ntm_shape(ras) +\n  tm_raster(title = \"\") +\n  tm_layout(\n    title = \"Ice thickness (m) of Agassiz Glacier\",\n    title.position = c(\"center\", \"top\"),\n    legend.position = c(\"left\", \"bottom\"),\n    legend.bg.color = \"#ffffff\",\n    legend.text.size = 1,\n    bg.color = \"#fcfcfc\",\n    inner.margins = c(0.07, 0.03, 0.07, 0.03),\n    outer.margins = 0\n  ) +\n  tm_compass(\n    type = \"arrow\",\n    position = c(\"right\", \"top\"),\n    text.size = 0.7\n  ) +\n  tm_scale_bar(\n    breaks = c(0, 0.5, 1),\n    position = c(\"right\", \"BOTTOM\"),\n    text.size = 1\n  )\n```\n\n![](img/ag_thickness.png)\n\n### Combining with Randolph data\n\nAs always, we check whether the CRS are the same:\n\n```{.r}\nst_crs(ag) == st_crs(ras)\n```\n\n<div style=\"font-size: 20px; margin: 25px 0 12px 1px; text-align: left; color: #802b00\">[Out]</div>\n\n```{.r}\n[1] FALSE\n```\n\nWe need to reproject `ag` (remember that it is best to avoid reprojecting raster data):\n\n```{.r}\nag %<>% st_transform(st_crs(ras))\n```\n\nThe retreat and ice thickness layers will hide each other (the order matters!). One option is to use `tm_borders` for one of them, but we can also use transparency (alpha). We also adjust the legend:\n\n```{.r}\ntm_shape(ras) +\n  tm_raster(title = \"Ice (m)\") +\n  tm_shape(ag) +\n  tm_polygons(\"year\", palette = \"Blues\", alpha = 0.2, title = \"Contour\") +\n  tm_layout(\n    title = \"Ice thickness (m) and retreat of Agassiz Glacier\",\n    title.position = c(\"center\", \"top\"),\n    legend.position = c(\"left\", \"bottom\"),\n    legend.bg.color = \"#ffffff\",\n    legend.text.size = 0.7,\n    bg.color = \"#fcfcfc\",\n    inner.margins = c(0.07, 0.03, 0.07, 0.03),\n    outer.margins = 0\n  ) +\n  tm_compass(\n    type = \"arrow\",\n    position = c(\"right\", \"top\"),\n    text.size = 0.7\n  ) +\n  tm_scale_bar(\n    breaks = c(0, 0.5, 1),\n    position = c(\"right\", \"BOTTOM\"),\n    text.size = 1\n  )\n```\n\n![](img/ag_combined.png)\n\n### Refining raster maps\n\nLet's go back to our ice thickness map:\n\n![](img/ag_thickness.png){width=\"30%\"}\n\nWe can change the palette to blue with `tm_raster(palette = \"Blues\")`:\n\n![](img/ag_thickness_blue.png){width=\"30%\"}\n\n#### We can create a more suitable interval scale\n\nFirst, let's see what the maximum value is:\n\n```{.r}\nglobal(ras, \"max\")\n```\n\n<div style=\"font-size: 20px; margin: 25px 0 12px 1px; text-align: left; color: #802b00\">[Out]</div>\n\n```{.r}\nmax\nRGI60-02.16664_thickness 70.10873\n```\n\nThen we can set the breaks with `tm_raster(breaks = seq(0, 80, 5))`\n\nWe also need to tweak the layout, legend, etc.:\n\n```{.r}\ntm_shape(ras) +\n  tm_raster(title = \"\", palette = \"Blues\", breaks = seq(0, 80, 5)) +\n  tm_layout(\n    title = \"Ice thickness (m) of Agassiz Glacier\",\n    title.position = c(\"center\", \"top\"),\n    legend.position = c(\"left\", \"bottom\"),\n    legend.bg.color = \"#ffffff\",\n    legend.text.size = 0.7,\n    bg.color = \"#fcfcfc\",\n    inner.margins = c(0.07, 0.03, 0.07, 0.03),\n    outer.margins = 0\n  ) +\n  tm_compass(\n    type = \"arrow\",\n    position = c(\"right\", \"top\"),\n    text.size = 0.7\n  ) +\n  tm_scale_bar(\n    breaks = c(0, 0.5, 1),\n    position = c(\"right\", \"BOTTOM\"),\n    text.size = 1\n  )\n```\n\n![](img/ag_thickness_blue_res.png)\n\nOr we can use a continuous colour scheme with `tm_raster(style = \"cont\")`:\n\n![](img/ag_thickness_blue_cont.png)\n\n## Basemaps\n\n### Basemap with ggmap\n\n```{.r}\nbasemap <- get_map(\n  bbox = c(\n    left = st_bbox(ag)[1],\n    bottom = st_bbox(ag)[2],\n    right = st_bbox(ag)[3],\n    top = st_bbox(ag)[4]\n  ),\n  source = \"osm\"\n)\n```\n\n:::{.note}\n\n*ggmap* is a powerful package, but Google now requires an API key obtained through registration\n\n:::\n\n### Basemap with basemaps\n\nThe package *basemaps* allows to download open source basemap data from several sources, but those cannot easily be combined with `sf` objects\n\nThis plots a satellite image of the Agassiz Glacier:\n\n```{.r}\nbasemap_plot(ag, map_service = \"esri\", map_type = \"world_imagery\")\n```\n\n### Satellite image of the Agassiz Glacier\n\n![](img/ag_magick.png)\n\n## Tiled web maps with Leaflet JS\n\n### mapview\n\n```{.r}\nmapview(gnp)\n```\n\n::::{.columns}\n\n:::{.column}\n\n![CartoDB.Positron](img/mapview4.jpg)\n\n![OpenStreetMap](img/mapview3.jpg)\n\n:::\n\n:::{.column}\n\n![OpenTopoMap](img/mapview1.jpg)\n\n![Esri.WorldImagery](img/mapview2.jpg)\n\n:::\n\n::::\n  \n### tmap\n\nSo far, we have used the `plot` mode of *tmap*. There is also a `view` mode which allows interactive viewing in a browser through [Leaflet](https://leafletjs.com/)\n\nChange to `view` mode:\n\n```{.r}\ntmap_mode(\"view\")\n```\n\n:::{.note}\n\nYou can also toggle between modes with `ttm`\n\n:::\n\nRe-plot the last map we plotted with *tmap*:\n\n```{.r}\ntmap_last()\n```\n\n### leaflet\n\n`leaflet` creates a map widget to which you add layers\n\n```{.r}\nmap <- leaflet()\naddTiles(map)\n```\n\n## Spatial data analysis\n\n### Resources\n\nHere are some resources on the topic to get started.\n\n- [R companion to Geographic Information Analysis](https://rspatial.org/terra/rosu/index.html)\n- [Spatial data analysis](https://rspatial.org/terra/analysis/index.html)\n\n## Image credits\n\nSzűcs Róbert, Grasshopper Geography\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
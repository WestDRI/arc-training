<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.280">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Marie-Hélène Burle">

<title>WestDRI - Machine learning on production clusters</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../ml/pretrained_models.html" rel="next">
<link href="../ml/audio_dataloader.html" rel="prev">
<link href="..//img/sfu_favicon.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../img/sfudrac_logo.png" alt="SFU &amp; DRAC logos" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">WestDRI</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../git/index.html">
 <span class="menu-text">Git</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../r/index.html">
 <span class="menu-text">R</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../julia/index.html">
 <span class="menu-text">Julia</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../ml/index.html">
 <span class="menu-text">ML</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../bash/index.html">
 <span class="menu-text">Bash</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../tools/index.html">
 <span class="menu-text">Research tools</span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-reader-toggle nav-link" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Machine learning on production clusters</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Workshops &amp; courses</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ml/concept.html" class="sidebar-item-text sidebar-link">Overarching concept of DL</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ml/nn.html" class="sidebar-item-text sidebar-link">Concepts: AI, ML, DL, NN</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ml/intro_hss.html" class="sidebar-item-text sidebar-link">Intro for the humanities</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ml/choosing_frameworks.html" class="sidebar-item-text sidebar-link">Which framework to choose?</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ml/high_level_frameworks.html" class="sidebar-item-text sidebar-link">High-level frameworks</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ml/intro_hss.html" class="sidebar-item-text sidebar-link">Intro for the humanities</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ml/autograd.html" class="sidebar-item-text sidebar-link">Automatic differentiation</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ml/mnist.html" class="sidebar-item-text sidebar-link">Classifying the MNIST</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ml/nn_building.html" class="sidebar-item-text sidebar-link">Building a model</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ml/nn_training.html" class="sidebar-item-text sidebar-link">Training a model</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ml/audio_dataloader.html" class="sidebar-item-text sidebar-link">Audio DataLoader</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ml/hpc.html" class="sidebar-item-text sidebar-link active">ML on production clusters</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ml/pretrained_models.html" class="sidebar-item-text sidebar-link">Finding pre-trained models</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ml/checkpoints.html" class="sidebar-item-text sidebar-link">Creating checkpoints</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ml/resources.html" class="sidebar-item-text sidebar-link">Resources</a>
  </div>
</li>
      </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Webinars</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ml/torchtensors.html" class="sidebar-item-text sidebar-link">PyTorch tensors</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ml/upscaling.html" class="sidebar-item-text sidebar-link">Image upscaling</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ml/fastai.html" class="sidebar-item-text sidebar-link">fastai</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ml/flux.html" class="sidebar-item-text sidebar-link">ML in Julia with Flux</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Workshop sections</h2>
   
  <ul>
  <li><a href="#plots" id="toc-plots" class="nav-link active" data-scroll-target="#plots">Plots</a></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data">Data</a>
  <ul class="collapse">
  <li><a href="#copy-files-tofrom-the-cluster" id="toc-copy-files-tofrom-the-cluster" class="nav-link" data-scroll-target="#copy-files-tofrom-the-cluster">Copy files to/from the cluster</a></li>
  <li><a href="#large-collections-of-files" id="toc-large-collections-of-files" class="nav-link" data-scroll-target="#large-collections-of-files">Large collections of files</a></li>
  </ul></li>
  <li><a href="#interactive-jobs" id="toc-interactive-jobs" class="nav-link" data-scroll-target="#interactive-jobs">Interactive jobs</a></li>
  <li><a href="#batch-jobs" id="toc-batch-jobs" class="nav-link" data-scroll-target="#batch-jobs">Batch jobs</a>
  <ul class="collapse">
  <li><a href="#job-script" id="toc-job-script" class="nav-link" data-scroll-target="#job-script">Job script</a></li>
  <li><a href="#job-handling" id="toc-job-handling" class="nav-link" data-scroll-target="#job-handling">Job handling</a></li>
  </ul></li>
  <li><a href="#gpus" id="toc-gpus" class="nav-link" data-scroll-target="#gpus">GPU(s)</a>
  <ul class="collapse">
  <li><a href="#gpu-types" id="toc-gpu-types" class="nav-link" data-scroll-target="#gpu-types">GPU types</a></li>
  <li><a href="#number-of-gpus" id="toc-number-of-gpus" class="nav-link" data-scroll-target="#number-of-gpus">Number of GPU(s)</a></li>
  <li><a href="#cpugpu-ratio" id="toc-cpugpu-ratio" class="nav-link" data-scroll-target="#cpugpu-ratio">CPU/GPU ratio</a></li>
  </ul></li>
  <li><a href="#code-testing" id="toc-code-testing" class="nav-link" data-scroll-target="#code-testing">Code testing</a>
  <ul class="collapse">
  <li><a href="#activate-your-python-virtual-environment" id="toc-activate-your-python-virtual-environment" class="nav-link" data-scroll-target="#activate-your-python-virtual-environment">Activate your Python virtual environment</a></li>
  <li><a href="#start-an-interactive-job" id="toc-start-an-interactive-job" class="nav-link" data-scroll-target="#start-an-interactive-job">Start an interactive job</a></li>
  <li><a href="#prepare-the-data" id="toc-prepare-the-data" class="nav-link" data-scroll-target="#prepare-the-data">Prepare the data</a></li>
  <li><a href="#try-to-run-your-code" id="toc-try-to-run-your-code" class="nav-link" data-scroll-target="#try-to-run-your-code">Try to run your code</a></li>
  </ul></li>
  <li><a href="#checkpoints" id="toc-checkpoints" class="nav-link" data-scroll-target="#checkpoints">Checkpoints</a></li>
  <li><a href="#tensorboard-on-the-cluster" id="toc-tensorboard-on-the-cluster" class="nav-link" data-scroll-target="#tensorboard-on-the-cluster">TensorBoard on the cluster</a>
  <ul class="collapse">
  <li><a href="#launch-tensorboard" id="toc-launch-tensorboard" class="nav-link" data-scroll-target="#launch-tensorboard">Launch TensorBoard</a></li>
  <li><a href="#create-a-connection-between-the-compute-node-and-your-computer" id="toc-create-a-connection-between-the-compute-node-and-your-computer" class="nav-link" data-scroll-target="#create-a-connection-between-the-compute-node-and-your-computer">Create a connection between the compute node and your computer</a></li>
  <li><a href="#access-tensorboard" id="toc-access-tensorboard" class="nav-link" data-scroll-target="#access-tensorboard">Access TensorBoard</a></li>
  </ul></li>
  <li><a href="#running-several-similar-jobs" id="toc-running-several-similar-jobs" class="nav-link" data-scroll-target="#running-several-similar-jobs">Running several similar jobs</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Machine learning on production clusters</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Marie-Hélène Burle </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<div class="def">
<p>This lesson is a summary of relevant information while using Python in an HPC context for deep learning.</p>
</div>
<p>When you <code>ssh</code> into one of the Alliance clusters, you log into the login node.</p>
<p>Everybody using a cluster uses that node to enter the cluster. <span class="emph">Do not run anything computationally intensive on this node or you would make the entire cluster very slow for everyone.</span> To run your code, you need to start an interactive job or submit a batch job to Slurm (the job scheduler used by the Alliance clusters).</p>
<section id="plots" class="level2">
<h2 class="anchored" data-anchor-id="plots">Plots</h2>
<p>Do not run code that displays plots on screen. Instead, have them written to files.</p>
</section>
<section id="data" class="level2">
<h2 class="anchored" data-anchor-id="data">Data</h2>
<section id="copy-files-tofrom-the-cluster" class="level3">
<h3 class="anchored" data-anchor-id="copy-files-tofrom-the-cluster">Copy files to/from the cluster</h3>
<section id="few-files" class="level4">
<h4 class="anchored" data-anchor-id="few-files">Few files</h4>
<p>If you need to copy files to or from the cluster, you can use <code>scp</code> from your local machine.</p>
<section id="copy-file-from-your-computer-to-the-cluster" class="level5">
<h5 class="anchored" data-anchor-id="copy-file-from-your-computer-to-the-cluster">Copy file from your computer to the cluster</h5>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">[local]$</span> scp <span class="op">&lt;</span>/local/path/to/file<span class="op">&gt;</span> <span class="op">&lt;</span>user<span class="op">&gt;</span>@<span class="op">&lt;</span>hostname<span class="op">&gt;</span>:<span class="op">&lt;</span>path/in/cluster<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="note">
<p>Expressions between the <code>&lt;</code> and <code>&gt;</code> signs need to be replaced by the relevant information (without those signs).</p>
</div>
</section>
<section id="copy-file-from-the-cluster-to-your-computer" class="level5">
<h5 class="anchored" data-anchor-id="copy-file-from-the-cluster-to-your-computer">Copy file from the cluster to your computer</h5>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">[local]$</span> scp <span class="op">&lt;</span>user<span class="op">&gt;</span>@<span class="op">&lt;</span>hostname<span class="op">&gt;</span>:<span class="op">&lt;</span>cluster/path/to/file<span class="op">&gt;</span> <span class="op">&lt;</span>/local/path<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="large-amount-of-data" class="level4">
<h4 class="anchored" data-anchor-id="large-amount-of-data">Large amount of data</h4>
<p>Use <a href="https://docs.alliancecan.ca/wiki/Globus">Globus</a> for large data transfers.</p>
<div class="note">
<p>The Alliance is starting to store classic ML datasets on its clusters. So if your research uses a common dataset, it may be worth inquiring whether it might be available before downloading a copy.</p>
</div>
</section>
</section>
<section id="large-collections-of-files" class="level3">
<h3 class="anchored" data-anchor-id="large-collections-of-files">Large collections of files</h3>
<p>The Alliance clusters are optimized for very large files and are slowed by large collections of small files. Datasets with many small files need to be turned into single-file archives with <code>tar</code>. <strong>Failing to do so will affect performance not just for you, but for all users of the cluster.</strong></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> tar cf <span class="op">&lt;</span>data<span class="op">&gt;</span>.tar <span class="op">&lt;</span>path/to/dataset/directory<span class="op">&gt;</span>/<span class="pp">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="note">
<ul>
<li>If you want to also compress the files, replace <code>tar cf</code> with <code>tar czf</code></li>
<li>As a modern alternative to <code>tar</code>, you can use <a href="https://docs.alliancecan.ca/wiki/Dar">Dar</a></li>
</ul>
</div>
</section>
</section>
<section id="interactive-jobs" class="level2">
<h2 class="anchored" data-anchor-id="interactive-jobs">Interactive jobs</h2>
<p>Interactive jobs are useful for code testing and development. They are not however the most efficient way to run code, so you should limit their use to testing and development.</p>
<p>You start an interactive job with:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> salloc <span class="at">--account</span><span class="op">=</span>def-<span class="op">&lt;</span>account<span class="op">&gt;</span> --cpus-per-task=<span class="op">&lt;</span>n<span class="op">&gt;</span> --gres=gpu:<span class="op">&lt;</span>n<span class="op">&gt;</span> --mem=<span class="op">&lt;</span>mem<span class="op">&gt;</span> --time=<span class="op">&lt;</span>time<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Our training cluster does not have GPUs, so for this workshop, do not use the <code>--gres=gpu:&lt;n&gt;</code> option.</p>
<p>For the workshop, you also don’t have to worry about the <code>--account=def-&lt;account&gt;</code> option (or, if you want, you can use <code>--account=def-sponsor00</code>).</p>
<p>Our training cluster has a total of 60 CPUs on 5 compute nodes. Since there are many of you in this workshop, <strong>please be very mindful when running interactive jobs</strong>: if you request a lot of CPUs for a long time, the other workshop attendees won’t be able to use the cluster anymore until your interactive job requested time ends (even if you aren’t running any code).</p>
<p>Here are my suggestions so that we don’t run into this problem:</p>
<ul>
<li>Only start interactive jobs when you need to understand what Python is doing at every step, or to test, explore, and develop code (so where an interactive Python shell is really beneficial). Once you have a model, submit a batch job to Slurm instead</li>
<li>When running interactive jobs on this training cluster, only request 1 CPU (so <code>--cpus-per-task=1</code>)</li>
<li>Only request the time that you will really use (e.g.&nbsp;for <a href="https://westgrid-ml.netlify.app/schoolremake/pt-07-tensor.html">the lesson on Python tensors</a>, maybe 30 min to 1 hour seems reasonable)</li>
<li>If you don’t need your job allocation anymore before it runs out, you can relinquish it with <code>Ctrl+d</code></li>
</ul>
<div class="note">
<p>Be aware that, on Cedar, <a href="https://docs.alliancecan.ca/wiki/Running_jobs#Cluster_particularities">you are not allowed to submit jobs from ~/home</a>. Instead, you have to submit jobs from ~/scratch or ~/project.</p>
</div>
</section>
<section id="batch-jobs" class="level2">
<h2 class="anchored" data-anchor-id="batch-jobs">Batch jobs</h2>
<p>As soon as you have a working Python script, you want to submit a batch job instead of running an interactive job. To do that, you need to write an <code>sbatch</code> script.</p>
<section id="job-script" class="level3">
<h3 class="anchored" data-anchor-id="job-script">Job script</h3>
<div class="example">
<p>Here is an example script:</p>
</div>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --job-name=&lt;name&gt;*            # job name</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --account=def-&lt;account&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --time=&lt;time&gt;                 # max walltime in D-HH:MM or HH:MM:SS</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=&lt;number&gt;      # number of cores</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --gres=gpu:&lt;type&gt;:&lt;number&gt;    # type and number of GPU(s) per node</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mem=&lt;mem&gt;                   # max memory (default unit is MB) per node</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --output=%x_%j.out*           # file name for the output</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --error=%x_%j.err*            # file name for errors</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mail-user=&lt;email_address&gt;*</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mail-type=ALL*</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Load modules</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># (Do not use this in our workshop since we aren't using GPUs)</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co"># (Note: loading the Python module is not necessary</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co"># when you activate a Python virtual environment)</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co"># module load cudacore/.10.1.243 cuda/10 cudnn/7.6.5</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a variable with the directory for your ML project</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="va">SOURCEDIR</span><span class="op">=</span>~/<span class="op">&lt;</span>path/project/dir<span class="op">&gt;</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Activate your Python virtual environment</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> ~/env/bin/activate</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Transfer and extract data to a compute node</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="va">$SLURM_TMPDIR</span>/data</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="fu">tar</span> xf ~/projects/def-<span class="op">&lt;</span>user<span class="op">&gt;</span>/<span class="op">&lt;</span>data<span class="op">&gt;</span>.tar <span class="at">-C</span> <span class="va">$SLURM_TMPDIR</span>/data</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Run your Python script on the data</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="va">$SOURCEDIR</span>/<span class="op">&lt;</span>script<span class="op">&gt;</span>.py <span class="va">$SLURM_TMPDIR</span>/data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="note">
<ul>
<li><code>%x</code> will get replaced by the script name and <code>%j</code> by the job number</li>
<li>If you compressed your data with <code>tar czf</code>, you need to extract it with <code>tar xzf</code></li>
<li><code>SBATCH</code> options marked with a <code>*</code> are optional</li>
<li>There are various other options for <a href="https://docs.alliancecan.ca/wiki/Running_jobs#Email_notification">email notifications</a></li>
</ul>
</div>
<p>You may wonder why we transferred data to a compute node. This makes any I/O operation involving your data a lot faster, so it will speed up your code. Here is how this works:</p>
<p>First, we create a temporary data directory in <code>$SLURM_TMPDIR</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> mkdir <span class="va">$SLURM_TMPDIR</span>/data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="note">
<p>The variable <code>$SLURM_TMPDIR</code> is created by Slurm on the compute node where a job is running. Its path is <code>/localscratch/&lt;user&gt;.&lt;jobid&gt;.0</code>. Anything in it gets deleted when the job is done.</p>
</div>
<p>Then we extract the data into it:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> tar xf ~/projects/def-<span class="op">&lt;</span>user<span class="op">&gt;</span>/<span class="op">&lt;</span>data<span class="op">&gt;</span>.tar <span class="at">-C</span> <span class="va">$SLURM_TMPDIR</span>/data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If your data is not in a tar file, you can simply copy it to the compute node running your job:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cp <span class="at">-r</span> ~/projects/def-<span class="op">&lt;</span>user<span class="op">&gt;</span>/<span class="op">&lt;</span>data<span class="op">&gt;</span> <span class="va">$SLURM_TMPDIR</span>/data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="job-handling" class="level3">
<h3 class="anchored" data-anchor-id="job-handling">Job handling</h3>
<section id="submit-a-job" class="level4">
<h4 class="anchored" data-anchor-id="submit-a-job">Submit a job</h4>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cd <span class="op">&lt;</span>/dir/containing/job<span class="op">&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sbatch <span class="op">&lt;</span>jobscript<span class="op">&gt;</span>.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="check-the-status-of-your-jobs" class="level4">
<h4 class="anchored" data-anchor-id="check-the-status-of-your-jobs">Check the status of your job(s)</h4>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sq</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="note">
<p><code>PD</code> = pending<br>
<code>R</code> = running<br>
<code>CG</code> = completing (Slurm is doing the closing processes)<br>
No information = your job has finished running</p>
</div>
</section>
<section id="cancel-a-job" class="level4">
<h4 class="anchored" data-anchor-id="cancel-a-job">Cancel a job</h4>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> scancel <span class="op">&lt;</span>jobid<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="display-efficiency-measures-of-a-completed-job" class="level4">
<h4 class="anchored" data-anchor-id="display-efficiency-measures-of-a-completed-job">Display efficiency measures of a completed job</h4>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> seff <span class="op">&lt;</span>jobid<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
</section>
<section id="gpus" class="level2">
<h2 class="anchored" data-anchor-id="gpus">GPU(s)</h2>
<section id="gpu-types" class="level3">
<h3 class="anchored" data-anchor-id="gpu-types">GPU types</h3>
<p>Several Alliance clusters have GPUs. Their numbers and types differ:</p>
<p><img src="img/cc_gpu.png" class="img-fluid" alt="noshadow"> <span class="caption">From <a href="https://docs.alliancecan.ca/wiki/Using_GPUs_with_Slurm">the Alliance Wiki</a></span></p>
<p>The default is <code>12G P100</code>, but you can request another type with <code>SBATCH --gres=gpu:&lt;type&gt;:&lt;number&gt;</code> (example: <code>--gres=gpu:p100l:1</code> to request a 16G P100 on Cedar). Please <a href="https://docs.alliancecan.ca/wiki/Using_GPUs_with_Slurm#Specifying_the_type_of_GPU_to_use">refer to the Alliance Wiki</a> for more details.</p>
</section>
<section id="number-of-gpus" class="level3">
<h3 class="anchored" data-anchor-id="number-of-gpus">Number of GPU(s)</h3>
<p><span class="emph">Try running your model on a single GPU first.</span></p>
<p>It is very likely that you do not need more than one GPU. Asking for more than you need will greatly increase your waiting time until your job is run. The lesson on <a href="https://westgrid-ml.netlify.app/schoolremake/pt-15-distributed.html">distributed computing with PyTorch</a> gives a few information as to when you might benefit from using several GPUs and provides some links to more resources. We will also offer workshops on distributed ML in the future. In any event, you should test your model before asking for several GPUs.</p>
</section>
<section id="cpugpu-ratio" class="level3">
<h3 class="anchored" data-anchor-id="cpugpu-ratio">CPU/GPU ratio</h3>
<p>Here are the Alliance recommendations:</p>
<p><strong>Béluga</strong>:<br>
No more than 10 CPU per GPU.</p>
<p><strong>Cedar</strong>:<br>
P100 GPU: no more than 6 CPU per GPU.<br>
V100 GPU: no more than 8 CPU per GPU.</p>
<p><strong>Graham</strong>:<br>
No more than 16 CPU per GPU.</p>
</section>
</section>
<section id="code-testing" class="level2">
<h2 class="anchored" data-anchor-id="code-testing">Code testing</h2>
<p>It might be wise to test your code in an interactive job before submitting a really big batch job to Slurm.</p>
<section id="activate-your-python-virtual-environment" class="level3">
<h3 class="anchored" data-anchor-id="activate-your-python-virtual-environment">Activate your Python virtual environment</h3>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> source ~/env/bin/activate</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="start-an-interactive-job" class="level3">
<h3 class="anchored" data-anchor-id="start-an-interactive-job">Start an interactive job</h3>
<div class="example">
<p>Example:</p>
</div>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> salloc <span class="at">--account</span><span class="op">=</span>def-<span class="op">&lt;</span>account<span class="op">&gt;</span> --gres=gpu:1 <span class="at">--cpus-per-task</span><span class="op">=</span>6 <span class="at">--mem</span><span class="op">=</span>32000 <span class="at">--time</span><span class="op">=</span>0:30:0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="prepare-the-data" class="level3">
<h3 class="anchored" data-anchor-id="prepare-the-data">Prepare the data</h3>
<p>Create a temporary data directory in <code>$SLURM_TMPDIR</code>:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">env</span><span class="kw">)</span> <span class="ex">$</span> mkdir <span class="va">$SLURM_TMPDIR</span>/data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="note">
<p>The variable <code>$SLURM_TMPDIR</code> is created by Slurm on the compute node where a job is running. Its path is <code>/localscratch/&lt;user&gt;.&lt;jobid&gt;.0</code>. Anything in it gets deleted when the job is done.</p>
</div>
<p>Extract the data into it:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">env</span><span class="kw">)</span> <span class="ex">$</span> tar xf ~/projects/def-<span class="op">&lt;</span>user<span class="op">&gt;</span>/<span class="op">&lt;</span>data<span class="op">&gt;</span>.tar <span class="at">-C</span> <span class="va">$SLURM_TMPDIR</span>/data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="try-to-run-your-code" class="level3">
<h3 class="anchored" data-anchor-id="try-to-run-your-code">Try to run your code</h3>
<p>Play in Python to test your code:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">env</span><span class="kw">)</span> <span class="ex">$</span> python</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">import</span> torch</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> ...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To exit the virtual environment, run:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">env</span><span class="kw">)</span> <span class="ex">$</span> deactivate</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="checkpoints" class="level2">
<h2 class="anchored" data-anchor-id="checkpoints">Checkpoints</h2>
<p>Long jobs should have a checkpoint at least every 24 hours. This ensures that an outage won’t lead to days of computation lost and it will help get the job started by the scheduler sooner.</p>
<p>For instance, you might want to have checkpoints every <code>n</code> epochs (choose <code>n</code> so that <code>n</code> epochs take less than 24 hours to run).</p>
<p>In PyTorch, you can create dictionaries with all the information necessary and save them as <code>.tar</code> files with <code>torch.save()</code>. You can then load them back with <code>torch.load()</code>.</p>
<p>The information you want to save in each checkpoint includes the model’s <code>state_dict</code>, the optimizer’s <code>state_dict</code>, the <code>epoch</code> at which you stopped, the latest training <code>loss</code>, and anything else needed to restart training where you left off.</p>
<div class="example">
<p>For example, saving a checkpoint during training could look something like this:</p>
</div>
<div class="sourceCode" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>torch.save({</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'epoch'</span>: <span class="op">&lt;</span>last epoch run<span class="op">&gt;</span>,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'model_state_dict'</span>: net.state_dict(),</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'optimizer_state_dict'</span>: optimizer.state_dict(),</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'loss'</span>: <span class="op">&lt;</span>latest loss<span class="op">&gt;</span>,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>}, <span class="op">&lt;</span>path<span class="op">/</span>to<span class="op">/</span>checkpoint<span class="op">-</span><span class="bu">file</span>.tar<span class="op">&gt;</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="example">
<p>To restart, initialize the model and optimizer, load the dictionary, and resume training:</p>
</div>
<div class="sourceCode" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the model and optimizer</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> <span class="op">&lt;</span>your model<span class="op">&gt;</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> <span class="op">&lt;</span>your optimizer<span class="op">&gt;</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the dictionary</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>checkpoint <span class="op">=</span> torch.load(<span class="op">&lt;</span>path<span class="op">/</span>to<span class="op">/</span>checkpoint<span class="op">-</span><span class="bu">file</span>.tar<span class="op">&gt;</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>model.load_state_dict(checkpoint[<span class="st">'model_state_dict'</span>])</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>optimizer.load_state_dict(checkpoint[<span class="st">'optimizer_state_dict'</span>])</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>epoch <span class="op">=</span> checkpoint[<span class="st">'epoch'</span>]</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> checkpoint[<span class="st">'loss'</span>]</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Resume training</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>model.train()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="tensorboard-on-the-cluster" class="level2">
<h2 class="anchored" data-anchor-id="tensorboard-on-the-cluster">TensorBoard on the cluster</h2>
<p><a href="https://github.com/tensorflow/tensorboard">TensorBoard</a> allows to visually track your model metrics (e.g.&nbsp;loss, accuracy, model graph, etc.). It requires a lot of processing power however, so if you want to use it on an Alliance cluster, <strong>do not run it from the login node.</strong> Instead, run it as part of your job. This section guides you through the whole workflow.</p>
<section id="launch-tensorboard" class="level3">
<h3 class="anchored" data-anchor-id="launch-tensorboard">Launch TensorBoard</h3>
<p>First, you need to launch TensorBoard in the background (with a trailing <code>&amp;</code>) before running your Python script. To do so, ad to your <code>sbatch</code> script:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="ex">tensorboard</span> <span class="at">--logdir</span><span class="op">=</span>/tmp/<span class="op">&lt;</span>your log dir<span class="op">&gt;</span> --host 0.0.0.0 <span class="kw">&amp;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="example">
<p>Example:</p>
</div>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH ...</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="ex">tensorboard</span> <span class="at">--logdir</span><span class="op">=</span>/tmp/<span class="op">&lt;</span>your log dir<span class="op">&gt;</span> --host 0.0.0.0 <span class="kw">&amp;</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="va">$SOURCEDIR</span>/<span class="op">&lt;</span>script<span class="op">&gt;</span>.py <span class="va">$SLURM_TMPDIR</span>/data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="create-a-connection-between-the-compute-node-and-your-computer" class="level3">
<h3 class="anchored" data-anchor-id="create-a-connection-between-the-compute-node-and-your-computer">Create a connection between the compute node and your computer</h3>
<p>Once the job is running, you need to create a connection between the compute node running TensorBoard and your computer.</p>
<p>First, you need to find the hostname of the compute node running the Tensorboard server. This is the value under <code>NODELIST</code> for your job when you run:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sq</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then, <strong>from your computer</strong>, enter this <code>ssh</code> command:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="ex">[local]$</span> ssh <span class="at">-N</span> <span class="at">-f</span> <span class="at">-L</span> localhost:6006:<span class="op">&lt;</span>node hostname<span class="op">&gt;</span>:6006 <span class="op">&lt;</span>user<span class="op">&gt;</span>@<span class="op">&lt;</span>cluster<span class="op">&gt;</span>.computecanada.ca</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="note">
<p>Replace <code>&lt;node hostname&gt;</code> by the compute node hostname you just identified, <code>&lt;user&gt;</code> by your user name, and <code>&lt;cluster&gt;</code> by the name of the Alliance cluster hostname—e.g.&nbsp;beluga, cedar, graham.</p>
</div>
</section>
<section id="access-tensorboard" class="level3">
<h3 class="anchored" data-anchor-id="access-tensorboard">Access TensorBoard</h3>
<p>You can now open a browser (on your computer) and go to <a href="http://localhost:6006" class="uri">http://localhost:6006</a> to monitor your model running on a compute node in the cluster!</p>
</section>
</section>
<section id="running-several-similar-jobs" class="level2">
<h2 class="anchored" data-anchor-id="running-several-similar-jobs">Running several similar jobs</h2>
<p>A number of ML tasks (e.g.&nbsp;<a href="https://en.wikipedia.org/wiki/Hyperparameter_optimization">hyperparameter optimization</a>) require running several instances of similar jobs. Grouping them into a single job with <a href="https://docs.alliancecan.ca/wiki/GLOST">GLOST</a> or <a href="https://docs.alliancecan.ca/wiki/GNU_Parallel">GNU Parallel</a> reduces the stress on the scheduler.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp(/https:\/\/mint\.westdri\.ca\//);
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
    var links = window.document.querySelectorAll('a:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../ml/audio_dataloader.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Audio DataLoader</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../ml/pretrained_models.html" class="pagination-link">
        <span class="nav-page-text">Finding pre-trained models</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Please also visit our <strong><a href="https://training.westdri.ca/" target="_blank">main website</a></strong></div>   
      <div class="nav-footer-center">
        <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="../about.html">About</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="../calendar.html">Calendar</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="../newsletter.html">Newsletter</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="../contact.html">Contact</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="https://docs.alliancecan.ca/wiki/Technical_documentation">Wiki</a>
  </li>  
</ul>
      </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/WestDRI">
      <i class="bi bi-github" role="img" aria-label="WestDRI GitHub">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.youtube.com/channel/UCfgds4Qf7VFOv4ORRvFFmhw">
      <i class="bi bi-youtube" role="img" aria-label="WestDRI YouTube">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>